<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; RTL8720EA Docs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/toggleprompt.js?v=d7ede5d2"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="MP Image" href="../../mp_image/src/index.html" />
    <link rel="prev" title="Virtual File System" href="index.html" />  
     
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="text/javascript" src="../../../_static/js/selector.js"></script>
<style>
      .wy-nav-content {
      max-width: 1000px; /* 设置最大宽度 */
      }
</style>



</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            RTL8720EA Docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../product_overview/src/index.html">Product Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Application Note</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../gcc_build_environment/src/index.html">Build Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdk_architecture/src/index.html">SDK Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gcc_makefile/src/index.html">GCC Makefile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sdk_example/src/index.html">SDK Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../flash_memory_layout/index.html">Flash and Memory Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mpu_cache/src/index.html">MPU and Cache</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Virtual File System</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vfs-initialization">VFS Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-of-vfs">Usage of VFS</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vfs-on-flash">VFS on Flash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vfs-within-app-image">VFS within APP Image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#common-file-operation">Common File Operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#key-value-operation">Key-Value Operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-conversion">Code Conversion</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vfs-encryption">VFS Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vfs-bin-file-generation">VFS Bin File Generation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../mp_image/src/index.html">MP Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ota/src/index.html">OTA Firmware Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chipen/src/index.html">CHIP Enable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../boot_process/src/index.html">Boot Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user_config/src/index.html">User Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hardware_ecdsa/src/index.html">ECDSA Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hardware_crypto_engine/src/index.html">Hardware Crypto Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../otpc/src/index.html">One-time Programmable Controller (OTPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../power_save/src/index.html">Power Saving</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ipc/src/index.html">Inter-Processor Communication (IPC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dmac/src/index.html">Direct Memory Access Controller (DMAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../psram/src/index.html">Pseudo-Static Random Access Memory (PSRAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pad/src/index.html">Pad Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinmux/src/index.html">Pin Multiplexing Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpio/gpio/src/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gpio/pinctrl/src/pinctrl.html">Pin Controller (Pinctrl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ledc/src/index.html">Light Emitting Diode Controller (LEDC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../trng/src/index.html">True Random Number Generator (TRNG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../adc/src/index.html">Analog-to-Digital Converter (ADC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cap_touch/src/index.html">Cap-Touch Controller (CTC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../thermal/src/index.html">Thermal Senor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/fullmac/src/index.html">FullMAC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/wifi/index.html">Wi-Fi Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/wifi_tunnel/src/index.html">Wi-Fi R-Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/wifi_bridge/src/index.html">Wi-Fi Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/wifi_csi/src/index.html">Wi-Fi CSI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/dsp/index.html">DSP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/usb/usb_otg/src/index.html">USB Host &amp; Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/audio/src/index.html">Audio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/multimedia/src/index.html">Multimedia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/gui/src/index.html">GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/ai/index.html">AI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/ai_voice/src/index.html">AIVoice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/low_power/src/index.html">Low Power Solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/security_encryption/src/index.html">Security &amp; Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/at_command/src/index.html">AT Command</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/software_tools/index.html">Software Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ameba/en/mp_tools/src/index.html">MP Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">RTL8720EA Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Application Note</a></li>
          <li class="breadcrumb-item"><a href="index.html">Virtual File System</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<span id="amebalite-virtual-file-system"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<p>This section introduces how to run Virtual File System (VFS) on RTL8720EA, including FatFS and LittleFS as the underlying implementation. Users can ignore the differences between different file systems by using VFS. The VFS provides common file operation interfaces like fopen, fwrite, fread, fclose, etc. The Key-Value (KV) interfaces are based on these common file operations. The architecture of VFS is illustrated as follows:</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../../../_images/vfs_architecture.svg"><img alt="../../../_images/vfs_architecture.svg" height="247" src="../../../_images/vfs_architecture.svg" width="349" /></a>
<figcaption>
<p><span class="caption-text">VFS architecture</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="vfs-initialization">
<h1>VFS Initialization<a class="headerlink" href="#vfs-initialization" title="Link to this heading"></a></h1>
<p>By default, the VFS has been initialized in <code class="file docutils literal notranslate"><span class="pre">main.c</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">app_filesystem_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">   </span><span class="n">vfs_init</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_FATFS_WITHIN_APP_IMG</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vfs_user_register</span><span class="p">(</span><span class="s">&quot;fat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">VFS_FATFS</span><span class="p">,</span><span class="w"> </span><span class="n">VFS_INF_FLASH</span><span class="p">,</span><span class="w"> </span><span class="n">VFS_REGION_2</span><span class="p">,</span><span class="w"> </span><span class="n">VFS_RO</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">RTK_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VFS-FAT Init Success </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">RTK_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;VFS-FAT Init Fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="cp">#endif</span>

<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vfs_user_register</span><span class="p">(</span><span class="n">VFS_PREFIX</span><span class="p">,</span><span class="w"> </span><span class="n">VFS_LITTLEFS</span><span class="p">,</span><span class="w"> </span><span class="n">VFS_INF_FLASH</span><span class="p">,</span><span class="w"> </span><span class="n">VFS_REGION_R1</span><span class="p">,</span><span class="w"> </span><span class="n">VFS_RW</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt_kv_init</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">RTK_LOGI</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;File System Init Success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">         </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">RTK_LOGE</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;File System Init Fail </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">vfs_user_register()</span></code> API will mount VFS to the Flash by users’ configuration. If failed to mount, this API will check whether the Flash is clean (0xFF). And if the Flash is clean, it will program the Flash to initialize VFS.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">vfs_user_register</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">vfs_type</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">interface</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">region</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span>
</pre></div>
</div>
<p>Where:</p>
<dl class="field-list simple">
<dt class="field-odd"><strong>prefix</strong><span class="colon">:</span></dt>
<dd class="field-odd"><p>defined by users, used to distinguish different file systems</p>
</dd>
<dt class="field-even"><strong>vfs_type</strong><span class="colon">:</span></dt>
<dd class="field-even"><p>file system type of the underlying implementation (<strong>FatFS</strong> or <strong>LittleFS</strong>)</p>
</dd>
<dt class="field-odd"><strong>interface</strong><span class="colon">:</span></dt>
<dd class="field-odd"><p>memory type (Flash only)</p>
</dd>
<dt class="field-even"><strong>region</strong><span class="colon">:</span></dt>
<dd class="field-even"><p>Flash partition (<strong>VFS1</strong> or <strong>VFS2</strong>, described in Section <a class="reference internal" href="#vfs-on-flash-section"><span class="std std-ref">VFS on Flash</span></a>)</p>
</dd>
<dt class="field-odd"><strong>flag</strong><span class="colon">:</span></dt>
<dd class="field-odd"><p>operation authority of file system (read-write or read-only)</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>vfs_type</em> of VFS_REGION_1 is set to <strong>LittleFS</strong> by default for read-write balance and power failure protection. To ensure proper utilization of <strong>FatFS</strong>, it is essential to configure the relevant settings in the menuconfig.</p>
</div>
</section>
<section id="usage-of-vfs">
<h1>Usage of VFS<a class="headerlink" href="#usage-of-vfs" title="Link to this heading"></a></h1>
<section id="vfs-on-flash">
<span id="vfs-on-flash-section"></span><h2>VFS on Flash<a class="headerlink" href="#vfs-on-flash" title="Link to this heading"></a></h2>
<p>Adjust the Flash partitions appropriately if the VFS interfaces are set to the Flash, and modify <strong>VFS1</strong> or <strong>VFS2</strong> (according to register region in <code class="file docutils literal notranslate"><span class="pre">main.c</span></code>) in <cite>Flash_Layout[]</cite> in <code class="docutils literal notranslate"><span class="pre">{SDK}component\soc\amebalite\usrcfg\ameba_flashcfg.c</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">FlashLayoutInfo_TypeDef</span><span class="w"> </span><span class="n">Flash_Layout</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="cm">/*Region_Type,    [StartAddr,     EndAddr]                */</span>
<span class="w">   </span><span class="p">{</span><span class="n">IMG_BOOT</span><span class="p">,</span><span class="w">      </span><span class="mh">0x08000000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08013FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Boot Manifest(4K) + KM4 Bootloader(76K)</span>
<span class="w">   </span><span class="c1">//Users should modify below according to their own memory</span>
<span class="w">   </span><span class="p">{</span><span class="n">IMG_APP_OTA1</span><span class="p">,</span><span class="w">  </span><span class="mh">0x08014000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x081F3FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Certificate(4K) + Manifest(4K) + KR4 &amp; KM4 Application OTA1 + Manifest(4K) + RDP IMG OTA1</span>

<span class="w">   </span><span class="p">{</span><span class="n">IMG_BOOT_OTA2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08200000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08213FFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Boot Manifest(4K) + KM4 Bootloader(76K) OTA</span>
<span class="w">   </span><span class="p">{</span><span class="n">IMG_APP_OTA2</span><span class="p">,</span><span class="w">  </span><span class="mh">0x08214000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x083DCFFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Certificate(4K) + Manifest(4K) + KR4 &amp; KM4 Application OTA2 + Manifest(4K) + RDP IMG OTA2</span>
<span class="w">   </span><span class="p">{</span><span class="n">FTL</span><span class="p">,</span><span class="w">           </span><span class="mh">0x083DD000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x083DFFFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//FTL for BT(&gt;=12K), The start offset of flash pages which is allocated to FTL physical map.</span>
<span class="hll"><span class="w">   </span><span class="p">{</span><span class="n">VFS1</span><span class="p">,</span><span class="w">          </span><span class="mh">0x083E0000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x083FFFFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//VFS region 1 (128K)</span>
</span><span class="w">   </span><span class="p">{</span><span class="n">IMG_DSP</span><span class="p">,</span><span class="w">       </span><span class="mh">0x08400000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x086FFFFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//Manifest(4K) + DSP IMG, only one DSP region in layout</span>
<span class="w">   </span><span class="p">{</span><span class="n">VFS2</span><span class="p">,</span><span class="w">          </span><span class="mh">0xFFFFFFFF</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//VFS region 2</span>
<span class="w">   </span><span class="p">{</span><span class="n">USER</span><span class="p">,</span><span class="w">          </span><span class="mh">0xFFFFFFFF</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="p">},</span><span class="w"> </span><span class="c1">//reserve for user</span>

<span class="w">   </span><span class="cm">/* End */</span>
<span class="w">   </span><span class="p">{</span><span class="mh">0xFF</span><span class="p">,</span><span class="w">          </span><span class="mh">0xFFFFFFFF</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The <strong>VFS1</strong> region must exist, and its size should always be larger than 128KB.</p></li>
<li><p>There are two VFS regions at most.</p></li>
</ul>
</div>
</section>
<section id="vfs-within-app-image">
<h2>VFS within APP Image<a class="headerlink" href="#vfs-within-app-image" title="Link to this heading"></a></h2>
<p>If the user only intends to use read-only files through VFS, VFS provides a more convenient read-only configuration feature. The detailed steps are as follows:</p>
<ol class="arabic">
<li><p>Prepare the read-only files and convert them into a FAT-formatted bin file. Refer to Section <a class="reference internal" href="#fatfs-bin-file-generation-section"><span class="std std-ref">FatFS Bin File Generation</span></a> for the method.</p></li>
<li><p>Name the bin file <code class="file docutils literal notranslate"><span class="pre">fatfs.bin</span></code> and place it in the <code class="docutils literal notranslate"><span class="pre">amebalite_gcc_project</span></code> directory.</p></li>
<li><p>Enable the following configurations in the menuconfig:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/vfs_within_app_image_1.png"><img alt="../../../_images/vfs_within_app_image_1.png" src="../../../_images/vfs_within_app_image_1.png" style="width: 400.5px; height: 170.1px;" /></a>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/vfs_within_app_image_2.png"><img alt="../../../_images/vfs_within_app_image_2.png" src="../../../_images/vfs_within_app_image_2.png" style="width: 254.70000000000002px; height: 92.7px;" /></a>
</figure>
</li>
<li><p>Rebuild the application firmware.</p>
<p>The application firmware (<code class="file docutils literal notranslate"><span class="pre">kr4_km4_app.bin</span></code> or <code class="file docutils literal notranslate"><span class="pre">kr4_km4_dsp_app.bin</span></code>) will include a read-only VFS area in FAT format, which will be mounted during the startup process.</p>
</li>
</ol>
<p>After startup, you will see the log <strong>VFS-FAT Init Success</strong> indicating that the read-only file system has been successfully mounted.</p>
<p>For the file usage method, refer to Sections <a class="reference internal" href="#common-file-operation-section"><span class="std std-ref">Common File Operation</span></a> or <a class="reference internal" href="#key-value-operation-section"><span class="std std-ref">Key-Value Operation</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To optimize the effective space utilization of the read-only file system, only FAT format is currently supported.</p>
</div>
</section>
<section id="common-file-operation">
<span id="common-file-operation-section"></span><h2>Common File Operation<a class="headerlink" href="#common-file-operation" title="Link to this heading"></a></h2>
<p>The common file operation interfaces used in VFS are listed below:</p>
<table class="docutils align-default" style="width: 100%">
<colgroup>
<col style="width: 30.0%" />
<col style="width: 40.0%" />
<col style="width: 30.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Parameters</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fopen</p></td>
<td><ul class="simple">
<li><p>const char * filename</p></li>
<li><p>const char * mode</p></li>
</ul>
</td>
<td><p>Open the filename pointed to, by filename using the given mode</p></td>
</tr>
<tr class="row-odd"><td><p>fclose</p></td>
<td><p>FILE * stream</p></td>
<td><p>Close the stream</p></td>
</tr>
<tr class="row-even"><td><p>fread</p></td>
<td><ul class="simple">
<li><p>void * ptr</p></li>
<li><p>size_t size</p></li>
<li><p>size_t count</p></li>
<li><p>FILE * stream</p></li>
</ul>
</td>
<td><p>Read data from the given stream by ptr into the array pointed to</p></td>
</tr>
<tr class="row-odd"><td><p>fwrite</p></td>
<td><ul class="simple">
<li><p>const void * ptr</p></li>
<li><p>size_t size</p></li>
<li><p>size_t count</p></li>
<li><p>FILE * stream</p></li>
</ul>
</td>
<td><p>Write data from the array pointed to by ptr to the given stream</p></td>
</tr>
<tr class="row-even"><td><p>fseek</p></td>
<td><ul class="simple">
<li><p>FILE * stream</p></li>
<li><p>long int offset</p></li>
<li><p>int origin</p></li>
</ul>
</td>
<td><p>Set the file position of the stream to the given offset</p></td>
</tr>
<tr class="row-odd"><td><p>rewind</p></td>
<td><p>FILE * stream</p></td>
<td><p>Set the file position to the beginning of the file of the given stream</p></td>
</tr>
<tr class="row-even"><td><p>fgetpos</p></td>
<td><ul class="simple">
<li><p>FILE * stream</p></li>
<li><p>fpos_t * p</p></li>
</ul>
</td>
<td><p>Get the current file position of the stream and writes it to pos</p></td>
</tr>
<tr class="row-odd"><td><p>fsetpos</p></td>
<td><ul class="simple">
<li><p>FILE * stream</p></li>
<li><p>fpos_t * p</p></li>
</ul>
</td>
<td><p>Set the file position of the given stream to the given position</p></td>
</tr>
<tr class="row-even"><td><p>fflush</p></td>
<td><p>FILE * stream</p></td>
<td><p>Flush the output buffer of a stream</p></td>
</tr>
<tr class="row-odd"><td><p>remove</p></td>
<td><p>const char * filename</p></td>
<td><p>Delete the given filename so that it is no longer accessible</p></td>
</tr>
<tr class="row-even"><td><p>rename</p></td>
<td><ul class="simple">
<li><p>const char * oldname</p></li>
<li><p>const char * newname</p></li>
</ul>
</td>
<td><p>Cause the filename referred to from old_filename to new_filename</p></td>
</tr>
<tr class="row-odd"><td><p>feof</p></td>
<td><p>FILE * stream</p></td>
<td><p>Test the end-of-file indicator for the given stream</p></td>
</tr>
<tr class="row-even"><td><p>ferror</p></td>
<td><p>FILE * stream</p></td>
<td><p>Test the error indicator for the given stream</p></td>
</tr>
<tr class="row-odd"><td><p>ftell</p></td>
<td><p>FILE * stream</p></td>
<td><p>Return the current file position of the given stream</p></td>
</tr>
<tr class="row-even"><td><p>ftruncate</p></td>
<td><ul class="simple">
<li><p>FILE * stream</p></li>
<li><p>off_t length</p></li>
</ul>
</td>
<td><p>Truncate a file to a specified length</p></td>
</tr>
<tr class="row-odd"><td><p>opendir</p></td>
<td><p>const char * name</p></td>
<td><p>Open a directory</p></td>
</tr>
<tr class="row-even"><td><p>readdir</p></td>
<td><p>DIR * pdir</p></td>
<td><p>Read a directory</p></td>
</tr>
<tr class="row-odd"><td><p>closedir</p></td>
<td><p>DIR * dirp</p></td>
<td><p>Close a directory</p></td>
</tr>
<tr class="row-even"><td><p>rmdir</p></td>
<td><p>const char * path</p></td>
<td><p>Remove a directory</p></td>
</tr>
<tr class="row-odd"><td><p>mkdir</p></td>
<td><ul class="simple">
<li><p>const char * pathname</p></li>
<li><p>mode_t mode</p></li>
</ul>
</td>
<td><p>Make a directory</p></td>
</tr>
<tr class="row-even"><td><p>access</p></td>
<td><ul class="simple">
<li><p>const char * pathname</p></li>
<li><p>int mode</p></li>
</ul>
</td>
<td><p>Determine accessibility of a file</p></td>
</tr>
<tr class="row-odd"><td><p>stat</p></td>
<td><ul class="simple">
<li><p>const char * path</p></li>
<li><p>struct stat * buf</p></li>
</ul>
</td>
<td><p>Get file status</p></td>
</tr>
</tbody>
</table>
<p>Users can rebuild the project by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span> <span class="pre">EXAMPLE=vfs</span></code> to test how common file operations work. Test logs should be like below:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">example_vfs_thread</span><span class="p">]</span><span class="w"> </span><span class="n">fwrite</span><span class="w"> </span><span class="n">succeeded</span><span class="w"> </span><span class="o">!!!</span>
<span class="p">[</span><span class="n">example_vfs_thread</span><span class="p">]</span><span class="w"> </span><span class="n">fread</span><span class="w"> </span><span class="n">succeeded</span><span class="w"> </span><span class="o">!!!</span>
<span class="p">[</span><span class="n">example_vfs_thread</span><span class="p">]</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">succeeded</span><span class="w"> </span><span class="o">!!!</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If success, <code class="docutils literal notranslate"><span class="pre">fseek</span></code> returns offset according to the beginning of file which is different from standard interfaces.</p>
</div>
</section>
<section id="key-value-operation">
<span id="key-value-operation-section"></span><h2>Key-Value Operation<a class="headerlink" href="#key-value-operation" title="Link to this heading"></a></h2>
<p>Simple KV interfaces are also provided for users. All KV APIs are placed in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\file_system\kv\kv.c.</span></code> Users can rebuild the project by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span> <span class="pre">EXAMPLE=kv</span></code> to test how KV APIs work. Test logs should be like below:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">rt_kv_set</span><span class="w"> </span><span class="n">success</span><span class="p">,</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="n">letters</span><span class="p">.</span>
<span class="n">rt_kv_get</span><span class="w"> </span><span class="n">success</span><span class="p">,</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="n">letters</span><span class="p">.</span>
<span class="n">rt_kv_delett</span><span class="w"> </span><span class="n">success</span><span class="p">.</span>
</pre></div>
</div>
</section>
<section id="code-conversion">
<h2>Code Conversion<a class="headerlink" href="#code-conversion" title="Link to this heading"></a></h2>
<p>The conversion between unicode and other codes is not supported on <strong>FatFS</strong> by default.</p>
<p>Modify the macro <cite>FF_CODE_PAGE</cite> in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\file_system\fatfs\r0.14b\include\ffconf.h</span></code> to enable the code conversion function, where <cite>FF_CODE_PAGE</cite> should be chosen as code page number which is desired.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define FF_CODE_PAGE  999</span>
<span class="cm">/* This option specifies the OEM code page to be used on the target system.</span>
<span class="cm">/  Incorrect code page setting can cause a file open failure.</span>
<span class="cm">/   437 - U.S.</span>
<span class="cm">/   720 - Arabic</span>
<span class="cm">/   737 - Greek</span>
<span class="cm">/   771 - KBL</span>
<span class="cm">/   775 - Baltic</span>
<span class="cm">/   850 - Latin 1</span>
<span class="cm">/   852 - Latin 2</span>
<span class="cm">/   855 - Cyrillic</span>
<span class="cm">/   857 - Turkish</span>
<span class="cm">/   860 - Portuguese</span>
<span class="cm">/   861 - Icelandic</span>
<span class="cm">/   862 - Hebrew</span>
<span class="cm">/   863 - Canadian French</span>
<span class="cm">/   864 - Arabic</span>
<span class="cm">/   865 - Nordic</span>
<span class="cm">/   866 - Russian</span>
<span class="cm">/   869 - Greek 2</span>
<span class="cm">/   932 - Japanese (DBCS)</span>
<span class="cm">/   936 - Simplified Chinese (DBCS)</span>
<span class="cm">/   949 - Korean (DBCS)</span>
<span class="cm">/   950 - Traditional Chinese (DBCS)</span>
<span class="cm">/   999 - Realtek defined for code size</span>
<span class="cm">/     0 - Include all code pages above and configured by f_setcp()</span>
<span class="cm">*/</span>
</pre></div>
</div>
</section>
<section id="vfs-encryption">
<h2>VFS Encryption<a class="headerlink" href="#vfs-encryption" title="Link to this heading"></a></h2>
<p>For special storage security needs, users can configure encryption and decryption interfaces of vfs. Specific interface usage instructions are listed in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\example\storage\vfs_encrypt\readme.txt</span></code>. Users can rebuild the project by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span> <span class="pre">EXAMPLE=vfs_encrypt</span></code> to test how KV APIs work. Test logs should be like below:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">example_vfs_encrypt_thread</span><span class="p">]</span><span class="w"> </span><span class="n">fwrite</span><span class="w"> </span><span class="n">succeeded</span><span class="w"> </span><span class="o">!!!</span>
<span class="p">[</span><span class="n">example_vfs_encrypt_thread</span><span class="p">]</span><span class="w"> </span><span class="n">fread</span><span class="w"> </span><span class="n">succeeded</span><span class="w"> </span><span class="o">!!!</span>
<span class="p">[</span><span class="n">example_vfs_encrypt_thread</span><span class="p">]</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">succeeded</span><span class="w"> </span><span class="o">!!!</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Plaintext will be padded according to the length of grouped data. It will take more cost of memory space if using vfs encryption.</p>
</div>
</section>
<section id="vfs-bin-file-generation">
<h2>VFS Bin File Generation<a class="headerlink" href="#vfs-bin-file-generation" title="Link to this heading"></a></h2>
<p>If data needs to be placed in the Flash in advance, VFS bin file can be generated on PC. After generating the bin file, it should be downloaded to VFS region according to the Flash layout.</p>
<section id="littlefs-bin-file-generation">
<h3>LittleFS Bin File Generation<a class="headerlink" href="#littlefs-bin-file-generation" title="Link to this heading"></a></h3>
<ol class="arabic">
<li><p>Prepare a needed object folder including files before generating LittleFS bin files. For example:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/littlefs_bin_generation_step1.png"><img alt="../../../_images/littlefs_bin_generation_step1.png" src="../../../_images/littlefs_bin_generation_step1.png" style="width: 154.8px; height: 178.20000000000002px;" /></a>
</figure>
<p><strong>AUDIO</strong> and <strong>KV</strong> directories will be LittleFS directory in the Flash.</p>
</li>
<li><p>Use the command <code class="docutils literal notranslate"><span class="pre">$./mklittlefs</span> <span class="pre">-b</span> <span class="pre">4096</span> <span class="pre">-p</span> <span class="pre">256</span> <span class="pre">-c-s</span> <span class="pre">0x20000</span> <span class="pre">test</span> <span class="pre">image_littlefs.bin</span></code> in <code class="docutils literal notranslate"><span class="pre">mklittlefs</span></code> tool located at <code class="docutils literal notranslate"><span class="pre">\tools\littlefs</span></code>  to generate LittleFS bin files.</p>
<p>Where:</p>
<dl class="field-list simple">
<dt class="field-odd">b<span class="colon">:</span></dt>
<dd class="field-odd"><p>block size decided by Flash</p>
</dd>
<dt class="field-even">p<span class="colon">:</span></dt>
<dd class="field-even"><p>page size</p>
</dd>
<dt class="field-odd">s<span class="colon">:</span></dt>
<dd class="field-odd"><p>bin file size</p>
</dd>
<dt class="field-even">c<span class="colon">:</span></dt>
<dd class="field-even"><p>object folder</p>
</dd>
<dt class="field-odd">&lt;Image_littlefs.bin&gt;<span class="colon">:</span></dt>
<dd class="field-odd"><p>LittleFS bin file name</p>
</dd>
</dl>
<figure class="align-center">
<a class="reference internal image-reference" href="../../../_images/littlefs_bin_generation_step2.png"><img alt="../../../_images/littlefs_bin_generation_step2.png" src="../../../_images/littlefs_bin_generation_step2.png" style="width: 596.7px; height: 66.60000000000001px;" /></a>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">-b</span> <span class="pre">4096</span></code> and <code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">256</span></code> are default configurations, users should adapt the configuration according to <cite>block_size</cite> and <cite>cache_size</cite> of <strong>lfs_config</strong> in <code class="docutils literal notranslate"><span class="pre">{SDK}\component\file_system\littlefs\littlefs_adapter.c</span></code>. <code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">0x20000</span></code> is according to VFS region mentioned in Section <a class="reference internal" href="#vfs-on-flash-section"><span class="std std-ref">VFS on Flash</span></a>.</p>
</div>
</li>
<li><p>Download the image to the Flash.</p>
<p>The start address of image should be VFS Flash region address mentioned in Section <a class="reference internal" href="#vfs-on-flash-section"><span class="std std-ref">VFS on Flash</span></a>. Test logs are shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>==========mklittlefs example==========
[TEST1]: This is a test file for mklittle …
[AUDIO1]: Copyright (c) 2013 Realtek …
</pre></div>
</div>
</li>
</ol>
</section>
<section id="fatfs-bin-file-generation">
<span id="fatfs-bin-file-generation-section"></span><h3>FatFS Bin File Generation<a class="headerlink" href="#fatfs-bin-file-generation" title="Link to this heading"></a></h3>
<p>The steps to generate FatFS bin files are listed below:</p>
<ol class="arabic">
<li><p>Use command <code class="docutils literal notranslate"><span class="pre">root&#64;ubuntu</span> <span class="pre">#</span> <span class="pre">dd</span> <span class="pre">if=/dev/zero</span> <span class="pre">of=test.bin</span> <span class="pre">count=64</span> <span class="pre">bs=1KB</span></code> to create <code class="file docutils literal notranslate"><span class="pre">test.bin</span></code> that has 64 blocks and each block is 1KB.</p></li>
<li><p>Use command <code class="docutils literal notranslate"><span class="pre">root&#64;ubuntu</span> <span class="pre">#</span> <span class="pre">mkfs.fat</span> <span class="pre">-S</span> <span class="pre">512-F</span> <span class="pre">12</span> <span class="pre">test.bin</span></code> to build a FAT file system.</p></li>
<li><p>Use command <code class="docutils literal notranslate"><span class="pre">root&#64;ubuntu</span> <span class="pre">#</span> <span class="pre">sudo</span> <span class="pre">mount</span> <span class="pre">test.bin</span> <span class="pre">./fs</span></code> to mount <code class="file docutils literal notranslate"><span class="pre">test.bin</span></code> to file folder fs.</p></li>
<li><p>Use command <code class="docutils literal notranslate"><span class="pre">root&#64;ubuntu</span> <span class="pre">#</span> <span class="pre">sudocphello.txt</span> <span class="pre">./fs</span></code> to copy the files that users want to store into <code class="docutils literal notranslate"><span class="pre">test.bin</span></code>.</p>
<p>In this step, <code class="file docutils literal notranslate"><span class="pre">hello.txt</span></code> is stored in <code class="file docutils literal notranslate"><span class="pre">test.bin</span></code>.</p>
</li>
<li><p>Use command <code class="docutils literal notranslate"><span class="pre">root&#64;ubuntu</span> <span class="pre">#</span> <span class="pre">sudoumount</span> <span class="pre">./fs</span></code> to generate the FatFS file after unmounting <code class="file docutils literal notranslate"><span class="pre">test.bin</span></code>.</p></li>
</ol>
<p>Users should find more related information about this topic from the internet, and copy <code class="file docutils literal notranslate"><span class="pre">test.bin</span></code> into user data area of Flash finally.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Virtual File System" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../mp_image/src/index.html" class="btn btn-neutral float-right" title="MP Image" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Realsil.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>