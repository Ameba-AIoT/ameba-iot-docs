

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; Ameba IoT Docs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=7d84cf84" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="../../_static/_static/custom.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/toggleprompt.js?v=d7ede5d2"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="SDIO Host" href="../7_sdio/0_sdioh_index.html" />
    <link rel="prev" title="USB OTG" href="0_usb_index.html" />
   
  
  <script type="text/javascript" src="../../_static/js/selector.js"></script>

  <style>
    .wy-nav-content {max-width: 1000px;} /* 设置最大宽度 */
  </style>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Ameba IoT Docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_ameba_product/0_ameba_product_center_index.html">Products Center</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_ameba_sdk/0_ameba_sdks_index.html">Ameba SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_release_packages/0_release_packages_index.html">0.0 Release Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_gcc_build_environment/0_gcc_build_index.html">0.1 Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_sdk_architecture/0_sdk_architecture_index.html">0.2 SDK Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_tools/0_tools_index.html">0.7 Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_question_help/0_question_help_index.html">0.A Questions and Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_debugging/0_debugging_index.html">0.B System Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_boot_process/0_boot_index.html">1.1 BOOT Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_ota/0_ota_index.html">1.2 OTA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_otpc/0_otpc_index.html">1.3 OTPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_flash/0_flash_index.html">1.4 Flash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_gpio/0_gpio_index.html">1.7 GPIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_power_save/0_ps_index.html">1.8 Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_nda_secure_boot/0_secure_boot_index_nda.html">3.6 Secure Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_usb_boot/0_usb_boot_index.html">3.7 USB Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_crypto_engine/0_crypto_engine_index.html">3.8 Crypto Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_multimedia/0_multimedia_index.html">4.3 Multimedia</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="0_usb_index.html">7.1 USB Host &amp; Device</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implementation">Implementation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dts-configuration">DTS Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#usb-phy-dts-configuration">USB PHY DTS Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usb-dts-configuration">USB DTS Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#build-configuration">Build Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-in-configuration">Build-in Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-configuration">Module Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usb-host-usage">USB Host Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cdc-acm-class">CDC ACM Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apis-for-application">APIs for Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mass-storage-class">Mass Storage Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">APIs for Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#uvc-class">UVC Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">APIs for Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vendor-class">Vendor Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">APIs for Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">Usage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usb-gadget-usage">USB Gadget Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id18">CDC ACM Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id19">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">APIs for Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id23">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#hid-class">HID Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id24">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">APIs for Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id29">Mass Storage Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id30">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id33">APIs for Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id34">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id35">Vendor Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id36">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id39">APIs for Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id40">Usage</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../7_sdio/0_sdioh_index.html">7.2 SDIO Host</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_dmac/0_dmac_index.html">8.1 DMA Controllor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_rtc/0_rtc_index.html">8.2 RTC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_thermal/0_thermal_index.html">8.3 Thermal Meter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_adc/0_adc_index.html">8.4 ADC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_cap_touch/0_cap_touch_index.html">8.5 Cap-Touch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_ir/0_ir_index.html">8.6 IR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_ledc/0_ledc_index.html">8.7 LEDC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_i2c/0_i2c_index.html">8.8 I2C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_uart/0_uart_index.html">8.9 UART</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_lcdc/0_lcdc_index.html">8.A LCDC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_spi/0_spi_index.html">8.B SPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_spic/0_spic_index.html">8.C SPI Flash Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_timer/0_timer_index.html">8.D Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_wdg/0_wdg_index.html">8.E Watchdog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../9_bluetooth/0_bluetooth_index.html">9.1 Bluetooth</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ameba IoT Docs</a>
      </nav>

      <div class="wy-nav-content">

        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="0_usb_index.html">USB OTG</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<span id="usb-otg"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<p>The Universal Serial Bus On-The-Go (USB OTG) is originally supported by Linux USB subsystem with Realtek’s dedicatedly designed USB PHY driver and a few changes at DWC2 USB controller driver.</p>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading"></a></h2>
<p>The USB software architecture is illustrated in the following figure.</p>
<figure class="align-center" id="id42">
<a class="reference internal image-reference" href="../../_images/usb_software_architecture.svg"><img alt="../../_images/usb_software_architecture.svg" height="415" src="../../_images/usb_software_architecture.svg" width="564" /></a>
<figcaption>
<p><span class="caption-text">USB software architecture</span><a class="headerlink" href="#id42" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h2>
<p>The original USB is supported by Linux USB subsystem.</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/usb/dwc2/</p></td>
<td><p>DWC2 host &amp; device controller driver, with changes by Realtek</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;linux&gt;/drivers/usb/core/</p></td>
<td><p>HCD core</p></td>
</tr>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/usb/gadget/</p></td>
<td><p>Gadget core</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;linux&gt;/drivers/usb/gadget/function/</p></td>
<td><p>Device classes, such as ADB, CDC ACM, HID, MSC, etc.</p></td>
</tr>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/usb/class/cdc-acm.*</p></td>
<td><p>CDC ACM host class</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;linux&gt;/drivers/usb/storage/*</p></td>
<td><p>MSC host class</p></td>
</tr>
</tbody>
</table>
<p>For more details of USB subsystem, refer to <a class="reference external" href="https://www.kernel.org/doc/html/v5.4/usb/index.html">https://www.kernel.org/doc/html/v5.4/usb/index.html</a>.</p>
<p>Realtek USB PHY driver is implemented as following files:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/rtkdrivers/usb_phy/Kconfig</p></td>
<td><p>USB PHY driver Kconfig</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;linux&gt;/drivers/rtkdrivers/usb_phy/Makefile</p></td>
<td><p>USB PHY driver Makefile</p></td>
</tr>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/rtkdrivers/usb_phy/phy-rtk-usb.c</p></td>
<td><p>USB PHY functions</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;linux&gt;/drivers/rtkdrivers/usb_phy/phy-rtk-usb.h</p></td>
<td><p>USB PHY API declaration</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="configuration">
<h1>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h1>
<section id="dts-configuration">
<h2>DTS Configuration<a class="headerlink" href="#dts-configuration" title="Link to this heading"></a></h2>
<section id="usb-phy-dts-configuration">
<h3>USB PHY DTS Configuration<a class="headerlink" href="#usb-phy-dts-configuration" title="Link to this heading"></a></h3>
<p>USB PHY DTS node is defined in <code class="docutils literal notranslate"><span class="pre">&lt;dts&gt;/rtl8730e-ocp.dtsi</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usb_phy</span><span class="p">:</span> <span class="n">usb</span><span class="o">-</span><span class="n">phy</span><span class="o">@</span><span class="mi">41000000</span> <span class="p">{</span>
   <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;realtek,otg-phy&quot;</span><span class="p">;</span>
   <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x400B0000</span> <span class="mh">0x20</span><span class="o">&gt;</span><span class="p">,</span>
   <span class="o">&lt;</span><span class="mh">0x41000060</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">,</span>
   <span class="o">&lt;</span><span class="mh">0x42000100</span> <span class="mh">0x10</span><span class="o">&gt;</span><span class="p">,</span>
   <span class="o">&lt;</span><span class="mh">0x4200825C</span> <span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="c1">#phy-cells = &lt;0&gt;;</span>
   <span class="n">clocks</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">rcc</span> <span class="n">RTK_CKE_USB</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">rtk</span><span class="p">,</span><span class="n">cal</span><span class="o">-</span><span class="n">data</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x00</span> <span class="mh">0xE0</span> <span class="mh">0x9D</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x00</span> <span class="mh">0xE1</span> <span class="mh">0x19</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x00</span> <span class="mh">0xE2</span> <span class="mh">0xDB</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x00</span> <span class="mh">0xE4</span> <span class="mh">0x68</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x01</span> <span class="mh">0xE5</span> <span class="mh">0x0A</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x01</span> <span class="mh">0xE6</span> <span class="mh">0xD8</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x02</span> <span class="mh">0xE7</span> <span class="mh">0x52</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x01</span> <span class="mh">0xE0</span> <span class="mh">0x04</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x01</span> <span class="mh">0xE0</span> <span class="mh">0x00</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="mh">0x01</span> <span class="mh">0xE0</span> <span class="mh">0x04</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">rtk</span><span class="p">,</span><span class="n">usb</span><span class="o">-</span><span class="n">phandle</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">usb</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">rtk</span><span class="p">,</span><span class="n">usb</span><span class="o">-</span><span class="n">force</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">en</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;okay&quot;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The DTS configurations of USB PHY are listed below:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Configurable?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>compatible</p></td>
<td><p>ID to match the Realtek USB PHY driver with the USB PHY device</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>reg</p></td>
<td><p>USB PHY register resource</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>#phy-cells</p></td>
<td><p>Indicates how many cells are needed to specifically describe a USB PHY, fixed at 0 for only one USB phy</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>clocks</p></td>
<td><p>The clock source of USB PHY</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>rtk,cal-data</p></td>
<td><p>The calibration data of USB PHY</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>rtk,usb-phandle</p></td>
<td><p>The USB Pointer Handle of USB PHY</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>rtk,usb-force-role-en</p></td>
<td><p>Enables forced switching between USB Host and Device modes.</p></td>
<td><p>1/0</p></td>
</tr>
<tr class="row-odd"><td><p>status</p></td>
<td><p>USB PHY status</p></td>
<td><p>disabled/okay</p></td>
</tr>
</tbody>
</table>
<p>USB PHY node is enabled by default. To disable it, overwrite the node status to <strong>disabled</strong> by node reference in higher level DTS file, such as chip specific DTS file or board specific DTS file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">usb_phy</span><span class="p">{</span>
   <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;disabled&quot;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="usb-dts-configuration">
<h3>USB DTS Configuration<a class="headerlink" href="#usb-dts-configuration" title="Link to this heading"></a></h3>
<p>USB PHY DTS node is defined in <code class="docutils literal notranslate"><span class="pre">&lt;dts&gt;/rtl8730e-ocp.dtsi</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usb</span><span class="p">:</span> <span class="n">usb</span><span class="o">@</span><span class="mi">40080000</span> <span class="p">{</span>
   <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;realtek,dwc-otg&quot;</span><span class="p">;</span>
   <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x40080000</span> <span class="mh">0x20000</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">interrupts</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">GIC_SPI</span> <span class="mi">39</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">g</span><span class="o">-</span><span class="n">rx</span><span class="o">-</span><span class="n">fifo</span><span class="o">-</span><span class="n">size</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">512</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">g</span><span class="o">-</span><span class="n">np</span><span class="o">-</span><span class="n">tx</span><span class="o">-</span><span class="n">fifo</span><span class="o">-</span><span class="n">size</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">256</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">g</span><span class="o">-</span><span class="n">tx</span><span class="o">-</span><span class="n">fifo</span><span class="o">-</span><span class="n">size</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">128</span> <span class="mi">120</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;okay&quot;</span><span class="p">;</span>
   <span class="n">endpoints</span> <span class="p">{</span>
      <span class="n">ep1in</span> <span class="p">{</span>
         <span class="n">ep_name</span> <span class="o">=</span> <span class="s2">&quot;ep1in&quot;</span><span class="p">;</span>
         <span class="n">ep_type</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0E</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">//</span> <span class="n">USB_EP_CAPS_TYPE_ALL</span>
      <span class="p">};</span>
      <span class="n">ep2out</span> <span class="p">{</span>
         <span class="n">ep_name</span> <span class="o">=</span> <span class="s2">&quot;ep2out&quot;</span><span class="p">;</span>
         <span class="n">ep_type</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0E</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">//</span> <span class="n">USB_EP_CAPS_TYPE_ALL</span>
      <span class="p">};</span>
      <span class="n">ep3in</span> <span class="p">{</span>
         <span class="n">ep_name</span> <span class="o">=</span> <span class="s2">&quot;ep3in&quot;</span><span class="p">;</span>
         <span class="n">ep_type</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0E</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">//</span> <span class="n">USB_EP_CAPS_TYPE_ALL</span>
      <span class="p">};</span>
      <span class="n">ep4out</span> <span class="p">{</span>
         <span class="n">ep_name</span> <span class="o">=</span> <span class="s2">&quot;ep4out&quot;</span><span class="p">;</span>
         <span class="n">ep_type</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0E</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">//</span> <span class="n">USB_EP_CAPS_TYPE_ALL</span>
      <span class="p">};</span>
      <span class="n">ep5in</span> <span class="p">{</span>
         <span class="n">ep_name</span> <span class="o">=</span> <span class="s2">&quot;ep5in&quot;</span><span class="p">;</span>
         <span class="n">ep_type</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0E</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">//</span> <span class="n">USB_EP_CAPS_TYPE_ALL</span>
      <span class="p">};</span>
      <span class="n">ep5out</span> <span class="p">{</span>
         <span class="n">ep_name</span> <span class="o">=</span> <span class="s2">&quot;ep5out&quot;</span><span class="p">;</span>
         <span class="n">ep_type</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0E</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">//</span> <span class="n">USB_EP_CAPS_TYPE_ALL</span>
      <span class="p">};</span>
   <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The DTS configurations of USB are listed below:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Configurable?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>compatible</p></td>
<td><p>ID to match the DWC2 controller driver with the USB OTG device</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>reg</p></td>
<td><p>USB register resource</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>interrupts</p></td>
<td><p>The GIC interrupt for USB</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>g-rx-fifo-size</p></td>
<td><p>The periodic Rx FIFO size for the USB device (unit: DWORDS).</p></td>
<td><p>16~512</p></td>
</tr>
<tr class="row-even"><td><p>g-np-tx-fifo-size</p></td>
<td><p>The non-periodic Tx FIFO size for the USB device (unit: DWORDS).</p></td>
<td><p>16~256</p></td>
</tr>
<tr class="row-odd"><td><p>g-tx-fifo-size</p></td>
<td><p>An array of TX FIFO sizes in dedicated FIFO mode. Each value corresponds to one EP starting (unit: DWORDS). Realtek USB works in shared FIFO mode, therefore this configuration will be ignored.</p></td>
<td><p>16~256</p></td>
</tr>
<tr class="row-even"><td><p>status</p></td>
<td><p>USB device status</p></td>
<td><p>disabled/okay</p></td>
</tr>
<tr class="row-odd"><td><p>endpoints</p></td>
<td><p>Allows USB Endpoint address configuration to meet specific client requirements.</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The total Data FIFO depth is 1016, that means the result of g-rx-fifo-size + g-np-tx-fifo-size + g-tx-fifo-size should not be larger than 1016.</p></li>
<li><p>DO NOT change the default configurations unless indeed necessary.</p></li>
</ul>
</div>
<p>The USB node is enabled by default. To disable it, overwrite the node status to <strong>disabled</strong> by node reference in higher level DTS file, such as chip specific DTS file or board specific DTS file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">usb</span><span class="p">{</span>
   <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;disabled&quot;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
</section>
<section id="build-configuration">
<h2>Build Configuration<a class="headerlink" href="#build-configuration" title="Link to this heading"></a></h2>
<p>The USB functions can be configured as built-in functions in kernel image or independent kernel modules.</p>
<section id="build-in-configuration">
<h3>Build-in Configuration<a class="headerlink" href="#build-in-configuration" title="Link to this heading"></a></h3>
<p>To build USB functions into kernel image:</p>
<ol class="arabic">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <span class="menuselection">Device Drivers &gt; Drivers for Realtek &gt; USB PHY driver</span>.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/select_y_for_usb_phy_driver.png"><img alt="../../_images/select_y_for_usb_phy_driver.png" src="../../_images/select_y_for_usb_phy_driver.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <span class="menuselection">Device Drivers &gt; USB support</span>.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/select_y_for_usb_support.png"><img alt="../../_images/select_y_for_usb_support.png" src="../../_images/select_y_for_usb_support.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
<li><p>Select required USB mode.</p>
<ol class="loweralpha simple">
<li><p>For host mode, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <span class="menuselection">Device Drivers &gt; USB support &gt; Support for Host-side USB</span>.</p></li>
<li><p>For device mode, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <span class="menuselection">Device Drivers &gt; USB support &gt; USB Gadget Support</span>.</p></li>
<li><p>For OTG mode, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for both <span class="menuselection">Device Drivers &gt; USB support &gt; Support for Host-side USB</span> and <span class="menuselection">Device Drivers &gt; USB support &gt; USB Gadget Support</span>.</p></li>
</ol>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/select_required_usb_mode.png"><img alt="../../_images/select_required_usb_mode.png" src="../../_images/select_required_usb_mode.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <span class="menuselection">Device Drivers &gt; USB support &gt; DesignWare USB2 DRD Core Support</span>.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/select_y_for_designware_usb2_drd_core_support.png"><img alt="../../_images/select_y_for_designware_usb2_drd_core_support.png" src="../../_images/select_y_for_designware_usb2_drd_core_support.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
<li><p>Check DWC2 mode selection.</p>
<ol class="loweralpha simple">
<li><p>For USB host, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <strong>Host only mode</strong></p></li>
<li><p>For USB device, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <strong>Gadget only mode</strong></p></li>
<li><p>For USB OTG mode, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <strong>Dual Role mode</strong>.</p></li>
</ol>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/check_dwc2_mode_selection.png"><img alt="../../_images/check_dwc2_mode_selection.png" src="../../_images/check_dwc2_mode_selection.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
<li><p>Select configurations for required class, refer to the following sections for details.</p></li>
</ol>
</section>
<section id="module-configuration">
<h3>Module Configuration<a class="headerlink" href="#module-configuration" title="Link to this heading"></a></h3>
<p>To build USB functions as kernel modules:</p>
<ol class="arabic">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">M</span></code> for <span class="menuselection">Device Drivers &gt; Drivers for Realtek &gt; USB PHY</span> driver</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/select_m_for_usb_phy_driver_module.png"><img alt="../../_images/select_m_for_usb_phy_driver_module.png" src="../../_images/select_m_for_usb_phy_driver_module.png" style="width: 719.1px; height: 608.4px;" /></a>
</figure>
</li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <span class="menuselection">Device Drivers &gt; USB support</span>.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/select_y_for_usb_support.png"><img alt="../../_images/select_y_for_usb_support.png" src="../../_images/select_y_for_usb_support.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
<li><p>Select required USB mode.</p>
<ol class="loweralpha simple">
<li><p>For host mode, select <code class="docutils literal notranslate"><span class="pre">M</span></code> for <span class="menuselection">Device Drivers &gt; USB support &gt; Support for Host-side USB</span>.</p></li>
<li><p>For device mode, select <code class="docutils literal notranslate"><span class="pre">M</span></code> for <span class="menuselection">Device Drivers &gt; USB support &gt; USB Gadget Support</span>.</p></li>
<li><p>For OTG mode, select <code class="docutils literal notranslate"><span class="pre">M</span></code> for both <span class="menuselection">Device Drivers &gt; USB support &gt; Support for Host-side USB</span> and <span class="menuselection">Device Drivers &gt; USB support &gt; USB Gadget Support</span>.</p></li>
</ol>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/select_required_usb_mode.png"><img alt="../../_images/select_required_usb_mode.png" src="../../_images/select_required_usb_mode.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">M</span></code> for <span class="menuselection">Device Drivers &gt; USB support &gt; DesignWare USB2 DRD Core Support</span>.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/select_m_for_designWare_usb2_drd_core_support.png"><img alt="../../_images/select_m_for_designWare_usb2_drd_core_support.png" src="../../_images/select_m_for_designWare_usb2_drd_core_support.png" style="width: 719.1px; height: 504.90000000000003px;" /></a>
</figure>
</li>
<li><p>Check DWC2 mode selection.</p>
<ol class="loweralpha simple">
<li><p>For USB host, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <strong>Host only mode</strong></p></li>
<li><p>For USB device, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <strong>Gadget only mode</strong></p></li>
<li><p>For USB OTG mode, select <code class="docutils literal notranslate"><span class="pre">Y</span></code> for <strong>Dual Role mode</strong>.</p></li>
</ol>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/check_dwc2_mode_selection.png"><img alt="../../_images/check_dwc2_mode_selection.png" src="../../_images/check_dwc2_mode_selection.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
<li><p>Select configurations for required class, refer to the following sections for details.</p></li>
<li><p>Load kernel modules at runtime</p>
<p>Where the <code class="docutils literal notranslate"><span class="pre">&lt;kernel_ver&gt;</span></code> below depends on the kernel version, such as 5.4.63.</p>
<ol class="loweralpha">
<li><p>For host mode, type the following command sequences to load USB common host drivers before loading any USB class specific modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">rtkdrivers</span><span class="o">/</span><span class="n">usb_phy</span><span class="o">/</span><span class="n">phy</span><span class="o">-</span><span class="n">rtk</span><span class="o">-</span><span class="n">usb</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">usb</span><span class="o">-</span><span class="n">common</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">usbcore</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">dwc2</span><span class="o">/</span><span class="n">dwc2</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
<li><p>For device mode, type the following command sequences to load USB common device drivers before loading any USB class specific modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">rtkdrivers</span><span class="o">/</span><span class="n">usb_phy</span><span class="o">/</span><span class="n">phy</span><span class="o">-</span><span class="n">rtk</span><span class="o">-</span><span class="n">usb</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">usb</span><span class="o">-</span><span class="n">common</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">udc</span><span class="o">/</span><span class="n">udc</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">libcomposite</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">dwc2</span><span class="o">/</span><span class="n">dwc2</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
</ol>
</li>
</ol>
</section>
</section>
</section>
<section id="usb-host-usage">
<h1>USB Host Usage<a class="headerlink" href="#usb-host-usage" title="Link to this heading"></a></h1>
<p>In USB host mode, USB OTG can enumerate the attached USB device and initiate the USB transfer.</p>
<p>Only the usage of several host classes are described in this section, for more information, refer to <a class="reference external" href="https://www.kernel.org/doc/html/v5.4/usb/index.html">https://www.kernel.org/doc/html/v5.4/usb/index.html</a>.</p>
<section id="cdc-acm-class">
<h2>CDC ACM Class<a class="headerlink" href="#cdc-acm-class" title="Link to this heading"></a></h2>
<section id="id1">
<h3>Configuration<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>Besides the common USB host configurations, extra configurations are required to support USB CDC ACM class driver, and user can choose to configure it as built-in functions or independent kernel modules.</p>
<p>The following configurations provide an example to support a typical CDC ACM device: USB serial port.</p>
<p>Adjust the configurations as required.</p>
<section id="built-in-configuration">
<h4>Built-in Configuration<a class="headerlink" href="#built-in-configuration" title="Link to this heading"></a></h4>
<p>Enter <span class="guilabel">USB support</span> menu, type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select <strong>USB Modem (CDC ACM) support</strong> and <strong>USB Serial Converter support</strong> options:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/type_y_usb_modem_support.png"><img alt="../../_images/type_y_usb_modem_support.png" src="../../_images/type_y_usb_modem_support.png" style="width: 715.5px; height: 606.6px;" /></a>
</figure>
</section>
<section id="id2">
<h4>Module Configuration<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Enter <span class="guilabel">USB support</span> menu, type <code class="docutils literal notranslate"><span class="pre">M</span></code> to select <strong>USB Modem (CDC ACM) support</strong> and <strong>USB Serial Converter support</strong> options:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/type_m_usb_modem_support.png"><img alt="../../_images/type_m_usb_modem_support.png" src="../../_images/type_m_usb_modem_support.png" style="width: 724.5px; height: 626.4px;" /></a>
</figure>
</li>
<li><p>Load kernel modules for CDC ACM class after loading common USB host modules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">cdc</span><span class="o">-</span><span class="n">acm</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">serial</span><span class="o">/</span><span class="n">usbserial</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="apis-for-application">
<h3>APIs for Application<a class="headerlink" href="#apis-for-application" title="Link to this heading"></a></h3>
<p>Refer to <a class="reference external" href="http://www.linux-usb.org/USB-guide/x332.html">http://www.linux-usb.org/USB-guide/x332.html</a>.</p>
</section>
<section id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h3>
<p>Once configured as a CDC ACM host, the SoC will recognize the attached CDC ACM device as a TTY device, and will be able to communicate with the CDC ACM device through TTY interface.</p>
<ol class="arabic">
<li><p>Connect a CDC ACM device to SoC with USB cable, the following log will be printed on the console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwc2</span> <span class="mf">40080000.</span><span class="n">usb</span><span class="p">:</span> <span class="n">Set</span> <span class="n">speed</span> <span class="n">to</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span>
<span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">new</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">number</span> <span class="mi">2</span> <span class="n">using</span> <span class="n">dwc2</span>
<span class="n">dwc2</span> <span class="mf">40080000.</span><span class="n">usb</span><span class="p">:</span> <span class="n">Set</span> <span class="n">speed</span> <span class="n">to</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span>
<span class="n">cdc_acm</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mf">1.0</span><span class="p">:</span> <span class="n">ttyACM0</span><span class="p">:</span> <span class="n">USB</span> <span class="n">ACM</span> <span class="n">device</span>
</pre></div>
</div>
</li>
<li><p>Communicate with the CDC ACM device through device node <code class="docutils literal notranslate"><span class="pre">/dev/ttyACM0</span></code>, for example:</p>
<ol class="loweralpha">
<li><p>Send data to CDC ACM device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">helloworld</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyACM0</span>
</pre></div>
</div>
</li>
<li><p>Receive data from CDC ACM device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyACM0</span>
</pre></div>
</div>
</li>
</ol>
</li>
</ol>
<p>Refer to <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/tests/usbh_cdc_acm</span></code> for CDC ACM host demo.</p>
</section>
</section>
<section id="mass-storage-class">
<h2>Mass Storage Class<a class="headerlink" href="#mass-storage-class" title="Link to this heading"></a></h2>
<section id="id3">
<h3>Configuration<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>Besides the common USB host configurations, extra configurations are required to support USB mass storage class driver, and user can choose to configure it as built-in functions or independent kernel modules.</p>
<p>The following configurations provide an example to support a typical mass storage device: UDISK with Realtek card reader solution and formatted with FAT32 file system.</p>
<p>Common configurations required by USB mass storage class driver:</p>
<ol class="arabic">
<li><p><span class="menuselection">Device Drivers &gt; SCSI device support &gt; SCSI device support</span> and <span class="menuselection">Device Drivers &gt; SCSI device support &gt; SCSI disk support</span>:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/scsi_device_disk_support.png"><img alt="../../_images/scsi_device_disk_support.png" src="../../_images/scsi_device_disk_support.png" style="width: 706.5px; height: 602.1px;" /></a>
</figure>
</li>
<li><p><span class="menuselection">File systems &gt; DOS/FAT/NT Filesystems &gt; VFAT (Windows-95) fs support</span>:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/vfat_windows_95_fs_support.png"><img alt="../../_images/vfat_windows_95_fs_support.png" src="../../_images/vfat_windows_95_fs_support.png" style="width: 701.1px; height: 601.2px;" /></a>
</figure>
</li>
<li><p><span class="menuselection">File systems &gt; Native language support &gt; Codepage 437(United States, Canada)</span> and <span class="menuselection">File systems &gt; Native language support &gt; NLS ISO 8859-1 (Latin 1; Western European Languages)`</span>:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/codepage_437.png"><img alt="../../_images/codepage_437.png" src="../../_images/codepage_437.png" style="width: 705.6px; height: 521.1px;" /></a>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/nls_ios_8859_1.png"><img alt="../../_images/nls_ios_8859_1.png" src="../../_images/nls_ios_8859_1.png" style="width: 706.5px; height: 524.7px;" /></a>
</figure>
</li>
</ol>
<p>Adjust the configurations as required.</p>
<section id="id4">
<h4>Built-in Configuration<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<p>Enter <span class="guilabel">USB support</span> menu, type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select <strong>USB Mass Storage support</strong> and <strong>Realtek Card Reader support</strong> options:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/type_y_usb_mass_storage_support.png"><img alt="../../_images/type_y_usb_mass_storage_support.png" src="../../_images/type_y_usb_mass_storage_support.png" style="width: 700.2px; height: 603.9px;" /></a>
</figure>
</section>
<section id="id5">
<h4>Module Configuration<a class="headerlink" href="#id5" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Enter <span class="guilabel">USB support</span> menu, type <code class="docutils literal notranslate"><span class="pre">M</span></code> to select <strong>USB Mass Storage support</strong> and then <strong>Realtek Card Reader support</strong> options:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/type_m_usb_mass_storage_support.png"><img alt="../../_images/type_m_usb_mass_storage_support.png" src="../../_images/type_m_usb_mass_storage_support.png" style="width: 702.0px; height: 597.6px;" /></a>
</figure>
</li>
<li><p>Load kernel modules for mass storage class after loading common USB host modules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">usb</span><span class="o">-</span><span class="n">storage</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">ums</span><span class="o">-</span><span class="n">realtek</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id6">
<h3>APIs for Application<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<p>Refer to <a class="reference external" href="http://www.linux-usb.org/USB-guide/x498.html">http://www.linux-usb.org/USB-guide/x498.html</a>.</p>
</section>
<section id="id7">
<h3>Usage<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<p>Here is the example to test the USB host mass storage driver with supported UDISK.</p>
<ol class="arabic">
<li><p>Connect an UDISK to SoC, the following log will be printed on console.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">USB</span> <span class="n">disconnect</span><span class="p">,</span> <span class="n">device</span> <span class="n">number</span> <span class="mi">2</span>
<span class="n">dwc2</span> <span class="mf">40080000.</span><span class="n">usb</span><span class="p">:</span> <span class="n">Set</span> <span class="n">speed</span> <span class="n">to</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span>
<span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">new</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">number</span> <span class="mi">3</span> <span class="n">using</span> <span class="n">dwc2</span>
<span class="n">dwc2</span> <span class="mf">40080000.</span><span class="n">usb</span><span class="p">:</span> <span class="n">Set</span> <span class="n">speed</span> <span class="n">to</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span>
<span class="n">usb</span><span class="o">-</span><span class="n">storage</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mf">1.0</span><span class="p">:</span> <span class="n">USB</span> <span class="n">Mass</span> <span class="n">Storage</span> <span class="n">device</span> <span class="n">detected</span>
<span class="n">scsi</span> <span class="n">host0</span><span class="p">:</span> <span class="n">usb</span><span class="o">-</span><span class="n">storage</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mf">1.0</span>
<span class="n">scsi</span> <span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">Direct</span><span class="o">-</span><span class="n">Access</span> <span class="n">TOSHIBA</span> <span class="n">USB</span> <span class="n">FLASH</span> <span class="n">DRIVE</span> <span class="n">PMAP</span> <span class="n">PQ</span><span class="p">:</span> <span class="mi">0</span> <span class="n">ANSI</span><span class="p">:</span> <span class="mi">6</span>
<span class="n">sd</span> <span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="mi">30253056</span> <span class="mi">512</span><span class="o">-</span><span class="n">byte</span> <span class="n">logical</span> <span class="n">blocks</span><span class="p">:</span> <span class="p">(</span><span class="mf">15.5</span> <span class="n">GB</span><span class="o">/</span><span class="mf">14.4</span> <span class="n">GiB</span><span class="p">)</span>
<span class="n">sd</span> <span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="n">Write</span> <span class="n">Protect</span> <span class="ow">is</span> <span class="n">off</span>
<span class="n">sd</span> <span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="n">Write</span> <span class="n">cache</span><span class="p">:</span> <span class="n">disabled</span><span class="p">,</span> <span class="n">read</span> <span class="n">cache</span><span class="p">:</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">doesn</span><span class="s1">&#39;t support DPO or FUA</span>
<span class="n">sda</span><span class="p">:</span> <span class="n">sda1</span>
<span class="n">sd</span> <span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="n">Attached</span> <span class="n">SCSI</span> <span class="n">removable</span> <span class="n">disk</span>
</pre></div>
</div>
</li>
<li><p>Mount UDISK device.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">udisk</span>
<span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">vfat</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">udisk</span>
</pre></div>
</div>
</li>
<li><p>Access UDISK device. Create a file and write/read it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">udisk</span>
<span class="n">echo</span> <span class="n">hello</span> <span class="o">&gt;&gt;</span> <span class="n">test</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cat</span> <span class="n">test</span><span class="o">.</span><span class="n">txt</span>
<span class="n">hello</span>
</pre></div>
</div>
</li>
<li><p>Unmount UDISK device</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">udisk</span>
</pre></div>
</div>
</li>
<li><p>Disconnect the UDISK device</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">USB</span> <span class="n">disconnect</span><span class="p">,</span> <span class="n">device</span> <span class="n">number</span> <span class="mi">2</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="uvc-class">
<h2>UVC Class<a class="headerlink" href="#uvc-class" title="Link to this heading"></a></h2>
<section id="id8">
<h3>Configuration<a class="headerlink" href="#id8" title="Link to this heading"></a></h3>
<p>Besides the common USB host configurations, extra configurations are required to support USB UVC class driver, and user can choose to configure it as built-in functions or independent kernel modules.</p>
<p>The following configurations provide an example to support a typical UVC device: UVC camera.</p>
<p>Common configurations required by UVC camera, selected as default in SDK:</p>
<ol class="arabic">
<li><p><span class="menuselection">Device Drivers &gt; Multimedia support</span></p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/multimedia_support.png"><img alt="../../_images/multimedia_support.png" src="../../_images/multimedia_support.png" style="width: 728.1px; height: 405.0px;" /></a>
</figure>
</li>
<li><p><span class="menuselection">Device Drivers &gt; Multimedia support &gt; Cameras/video grabbers support, Media Controller API,  V4L2 sub-device userspace API, Media USB Adapters</span>:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/options_in_multimedia_support.png"><img alt="../../_images/options_in_multimedia_support.png" src="../../_images/options_in_multimedia_support.png" style="width: 704.7px; height: 522.9px;" /></a>
</figure>
</li>
</ol>
<section id="id9">
<h4>Built-in Configuration<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<p>Enter <span class="guilabel">Media USB Adapters</span> and type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select <strong>USB Video Class (UVC)</strong>:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/y_for_usb_video_class.png"><img alt="../../_images/y_for_usb_video_class.png" src="../../_images/y_for_usb_video_class.png" style="width: 702.9px; height: 520.2px;" /></a>
</figure>
</section>
<section id="id10">
<h4>Module Configuration<a class="headerlink" href="#id10" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Enter <span class="guilabel">Media USB Adapters</span> and type <code class="docutils literal notranslate"><span class="pre">M</span></code> to select <strong>USB Video Class (UVC)</strong> :</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/m_for_usb_video_class.png"><img alt="../../_images/m_for_usb_video_class.png" src="../../_images/m_for_usb_video_class.png" style="width: 703.8000000000001px; height: 513.9px;" /></a>
</figure>
</li>
<li><p>Load kernel modules about UVC class after loading common USB host modules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">uvc</span><span class="o">/</span><span class="n">uvcvideo</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id11">
<h3>APIs for Application<a class="headerlink" href="#id11" title="Link to this heading"></a></h3>
<p>It treats UVC device as a V4L2 device. Refer to <a class="reference external" href="https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/v4l2.html">https://www.kernel.org/doc/html/latest/userspace-api/media/v4l/v4l2.html</a> to get more information about V4L2 API.</p>
</section>
<section id="id12">
<h3>Usage<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<p>The following is a usage simple for a typical UVC device: USB camera.</p>
<p>Once the USB camera is plugged into USB cable, the following log will print on console.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwc2</span> <span class="mf">40080000.</span><span class="n">usb</span><span class="p">:</span> <span class="n">Set</span> <span class="n">speed</span> <span class="n">to</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span>
<span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">new</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">number</span> <span class="mi">2</span> <span class="n">using</span> <span class="n">dwc2</span>
<span class="n">dwc2</span> <span class="mf">40080000.</span><span class="n">usb</span><span class="p">:</span> <span class="n">Set</span> <span class="n">speed</span> <span class="n">to</span> <span class="n">high</span><span class="o">-</span><span class="n">speed</span>
<span class="n">uvcvideo</span><span class="p">:</span> <span class="n">Found</span> <span class="n">UVC</span> <span class="mf">1.00</span> <span class="n">device</span> <span class="n">USB</span> <span class="n">Camera</span> <span class="p">(</span><span class="mi">0</span><span class="n">bda</span><span class="p">:</span><span class="mi">5842</span><span class="p">)</span>
<span class="nb">input</span><span class="p">:</span> <span class="n">USB</span> <span class="n">Camera</span><span class="p">:</span> <span class="n">USB</span> <span class="n">Camera</span> <span class="k">as</span> <span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">ocp</span><span class="o">/</span><span class="mf">40080000.</span><span class="n">usb</span><span class="o">/</span><span class="n">usb1</span><span class="o">/</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">input1</span>
</pre></div>
</div>
<p>User can use IOCTL with V4L2 library API to access USB camera.</p>
<p>Find the UVC demo at <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/tests/usbh_uvc</span></code>, which is an example that capture image from UVC camera and save it to a SD card.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SD card shall be mounted before running the UVC demo.</p>
</div>
</section>
</section>
<section id="vendor-class">
<h2>Vendor Class<a class="headerlink" href="#vendor-class" title="Link to this heading"></a></h2>
<p>Vendor class is designed for user to develop customized USB host class.</p>
<section id="id13">
<h3>Configuration<a class="headerlink" href="#id13" title="Link to this heading"></a></h3>
<p>Besides the common USB host configurations, extra configurations are required to support USB vendor class driver, and user can choose to configure it as built-in functions or independent kernel modules.</p>
<section id="id14">
<h4>Built-in Configuration<a class="headerlink" href="#id14" title="Link to this heading"></a></h4>
<p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select USB testing driver:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/y_for_usb_testing_driver.png"><img alt="../../_images/y_for_usb_testing_driver.png" src="../../_images/y_for_usb_testing_driver.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</section>
<section id="id15">
<h4>Module Configuration<a class="headerlink" href="#id15" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">M</span></code> to select USB testing driver:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/m_for_usb_testing_driver.png"><img alt="../../_images/m_for_usb_testing_driver.png" src="../../_images/m_for_usb_testing_driver.png" style="width: 846.0px; height: 630.9px;" /></a>
</figure>
</li>
<li><p>Load kernel modules about vendor class after loading common USB host modules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">usbtest</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id16">
<h3>APIs for Application<a class="headerlink" href="#id16" title="Link to this heading"></a></h3>
<p>None.</p>
</section>
<section id="id17">
<h3>Usage<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<p>Find the USB host vendor demo for user space at <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/tests/usbh_vendor</span></code>.</p>
</section>
</section>
</section>
<section id="usb-gadget-usage">
<h1>USB Gadget Usage<a class="headerlink" href="#usb-gadget-usage" title="Link to this heading"></a></h1>
<p>In USB gadget mode, USB OTG can be enumerated by the attached USB host and response the USB transfer requests.</p>
<p>There are two configuration mode for USB gadget classes:</p>
<ul class="simple">
<li><p>Configfs mode: USB Gadget functions configurable through configfs</p></li>
<li><p>Legacy mode: USB Gadget precomposed configurations</p></li>
</ul>
<p>The configfs mode is adopted in this section.</p>
<p>Only the usage of several device classes are described in this section, refer to <a class="reference external" href="https://www.kernel.org/doc/html/v5.4/usb/index.html">https://www.kernel.org/doc/html/v5.4/usb/index.html</a> for more information.</p>
<section id="id18">
<h2>CDC ACM Class<a class="headerlink" href="#id18" title="Link to this heading"></a></h2>
<section id="id19">
<h3>Configuration<a class="headerlink" href="#id19" title="Link to this heading"></a></h3>
<p>Besides the common USB device configurations, extra configurations are required to support USB CDC ACM class, and user can choose to configure it as built-in functions or independent kernel modules.</p>
<section id="id20">
<h4>Built-in Configuration<a class="headerlink" href="#id20" title="Link to this heading"></a></h4>
<p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select the following options in USB Gadget Support:</p>
<ul>
<li><p>USB Gadget functions configurable through configfs</p></li>
<li><p>Serial gadget console support</p></li>
<li><p>Abstract Control Model (CDC ACM)</p>
<blockquote>
<div><figure class="align-center">
<a class="reference internal image-reference" href="../../_images/cdc_acm_built_in_configuration_options_usb_gadget_support.png"><img alt="../../_images/cdc_acm_built_in_configuration_options_usb_gadget_support.png" src="../../_images/cdc_acm_built_in_configuration_options_usb_gadget_support.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</div></blockquote>
</li>
</ul>
</section>
<section id="id21">
<h4>Module Configuration<a class="headerlink" href="#id21" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Select the following options in USB Gadget Support:</p>
<ul class="simple">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">M</span></code> to select <strong>USB Gadget functions configurable through configfs</strong></p></li>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select <strong>Serial gadget console support</strong></p></li>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select <strong>Abstract Control Model (CDC ACM)</strong></p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/cdc_acm_module_configuration_options_usb_gadget_support.png"><img alt="../../_images/cdc_acm_module_configuration_options_usb_gadget_support.png" src="../../_images/cdc_acm_module_configuration_options_usb_gadget_support.png" style="width: 844.2px; height: 638.1px;" /></a>
</figure>
</li>
<li><p>Load kernel modules about CDC ACM class after loading common USB device modules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">u_serial</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">usb_f_acm</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id22">
<h3>APIs for Application<a class="headerlink" href="#id22" title="Link to this heading"></a></h3>
<p>Refer to <a class="reference external" href="http://www.linux-usb.org/USB-guide/x498.html">http://www.linux-usb.org/USB-guide/x498.html</a>.</p>
</section>
<section id="id23">
<h3>Usage<a class="headerlink" href="#id23" title="Link to this heading"></a></h3>
<p>Here is an example to set the board as a CDC ACM device.</p>
<ol class="arabic">
<li><p>Connect the board to PC via USB cable.</p></li>
<li><p>Run the following commands in board console.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span>
<span class="n">mount</span> <span class="n">none</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span> <span class="o">-</span><span class="n">t</span> <span class="n">configfs</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">usb_gadget</span>
<span class="n">mkdir</span> <span class="n">cdc</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="n">cdc</span>
<span class="n">echo</span> <span class="mh">0x0200</span> <span class="o">&gt;</span> <span class="n">bcdUSB</span>
<span class="n">echo</span> <span class="mh">0x02</span> <span class="o">&gt;</span> <span class="n">bDeviceClass</span>
<span class="n">echo</span> <span class="mh">0x02</span> <span class="o">&gt;</span> <span class="n">bDeviceSubClass</span>
<span class="n">echo</span> <span class="mi">64</span> <span class="o">&gt;</span> <span class="n">bMaxPacketSize0</span>
<span class="n">echo</span> <span class="mh">0x8730</span> <span class="o">&gt;</span> <span class="n">idProduct</span>
<span class="n">echo</span> <span class="mh">0x0BDA</span> <span class="o">&gt;</span> <span class="n">idVendor</span>
<span class="n">mkdir</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">echo</span> <span class="s2">&quot;Realtek&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">manufacturer</span>
<span class="n">echo</span> <span class="s2">&quot;VCOM&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">product</span>
<span class="n">echo</span> <span class="s2">&quot;123456789AB&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">serialnumber</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span>
<span class="n">echo</span> <span class="mi">120</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">MaxPower</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">echo</span> <span class="s2">&quot;acm&quot;</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">configuration</span>
<span class="n">mkdir</span> <span class="n">functions</span><span class="o">/</span><span class="n">acm</span><span class="o">.</span><span class="n">ttyS1</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">functions</span><span class="o">/</span><span class="n">acm</span><span class="o">.</span><span class="n">ttyS1</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span>
<span class="n">echo</span> <span class="mf">40080000.</span><span class="n">usb</span> <span class="o">&gt;</span> <span class="n">UDC</span>
</pre></div>
</div>
</li>
<li><p>Find the correct COM on PC, and open it.</p></li>
<li><p>Send <code class="docutils literal notranslate"><span class="pre">12345</span></code> from board to PC COM.</p>
<p>Input command from board console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">12345</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyGS0</span>
</pre></div>
</div>
<p>PC COM will receive string <code class="docutils literal notranslate"><span class="pre">12345</span></code>.</p>
</li>
<li><p>Receive strings from PC COM.</p>
<p>Input command from board console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">ttyGS0</span>
</pre></div>
</div>
<p>Send string <code class="docutils literal notranslate"><span class="pre">12345</span></code> from PC COM, then board will receive string <code class="docutils literal notranslate"><span class="pre">12345</span></code>.</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Win7 cannot drive CDC ACM device directly. Specific driver needs to be installed: <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/tools/image_tool/RtkUsbCdcAcmSetup.INF</span></code>. And the PID / VID in this driver should be consistent with the CDC ACM device descriptor.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If PC COM cannot be opened, comment following code in <code class="docutils literal notranslate"><span class="pre">&lt;linux&gt;/drivers/usb/gadget/function/f_acm.c</span></code> for temporary workaround:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">acm_cdc_notify</span><span class="p">(</span><span class="n">struct</span> <span class="n">f_acm</span> <span class="o">*</span><span class="n">acm</span><span class="p">,</span> <span class="n">u8</span> <span class="nb">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
<span class="n">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>

<span class="o">/*</span> <span class="n">ep_queue</span><span class="p">()</span> <span class="n">can</span> <span class="n">complete</span> <span class="n">immediately</span> <span class="k">if</span> <span class="n">it</span> <span class="n">fills</span> <span class="n">the</span> <span class="n">fifo</span><span class="o">...</span> <span class="o">*/</span>
<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="o">//</span><span class="n">status</span> <span class="o">=</span> <span class="n">usb_ep_queue</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="hid-class">
<h2>HID Class<a class="headerlink" href="#hid-class" title="Link to this heading"></a></h2>
<section id="id24">
<h3>Configuration<a class="headerlink" href="#id24" title="Link to this heading"></a></h3>
<p>Besides the common USB device configurations, extra configurations are required to support USB HID class, and user can choose to configure it as built-in functions or independent kernel modules.</p>
<p>Make sure <strong>HID bus support</strong> and <strong>Generic HID driver</strong> are selected:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/hid_bus_support_generic_hid_driver.png"><img alt="../../_images/hid_bus_support_generic_hid_driver.png" src="../../_images/hid_bus_support_generic_hid_driver.png" style="width: 720.0px; height: 406.8px;" /></a>
</figure>
<p>Actually, above configurations are enabled as default in SDK to support ADB.</p>
<section id="id25">
<h4>Built-in Configuration<a class="headerlink" href="#id25" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select the following options in USB Gadget Support:</p>
<ul class="simple">
<li><p>USB Gadget functions configurable through configfs</p></li>
<li><p>Serial gadget console support</p></li>
<li><p>HID function</p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/hid_built_in_configuration_options_usb_gadget_support.png"><img alt="../../_images/hid_built_in_configuration_options_usb_gadget_support.png" src="../../_images/hid_built_in_configuration_options_usb_gadget_support.png" style="width: 709.2px; height: 588.6px;" /></a>
</figure>
</li>
</ol>
</section>
<section id="id26">
<h4>Module Configuration<a class="headerlink" href="#id26" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Select the following items in USB Gadget Support:</p>
<ul class="simple">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">M</span></code> to select <strong>USB Gadget functions configurable through configfs</strong></p></li>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select <strong>HID function</strong></p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/hid_module_configuration_options_usb_gadget_support.png"><img alt="../../_images/hid_module_configuration_options_usb_gadget_support.png" src="../../_images/hid_module_configuration_options_usb_gadget_support.png" style="width: 705.6px; height: 585.9px;" /></a>
</figure>
</li>
<li><p>Load kernel modules about HID class after loading common USB device modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">udc</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">usb_f_hid</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id27">
<h3>APIs for Application<a class="headerlink" href="#id27" title="Link to this heading"></a></h3>
<p>Refer to <a class="reference external" href="http://www.linux-usb.org/USB-guide/x498.html">http://www.linux-usb.org/USB-guide/x498.html</a>.</p>
</section>
<section id="id28">
<h3>Usage<a class="headerlink" href="#id28" title="Link to this heading"></a></h3>
<p>Here is an example to set the board as a HID mouse device.</p>
<ol class="arabic">
<li><p>Configure USB device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span>
<span class="n">mount</span> <span class="n">none</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span> <span class="o">-</span><span class="n">t</span> <span class="n">configfs</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">usb_gadget</span>
<span class="n">mkdir</span> <span class="n">hid</span>
<span class="n">cd</span> <span class="n">hid</span>
<span class="n">echo</span> <span class="mh">0x0200</span> <span class="o">&gt;</span> <span class="n">bcdUSB</span>
<span class="n">echo</span> <span class="mh">0x03</span> <span class="o">&gt;</span> <span class="n">bDeviceClass</span>
<span class="n">echo</span> <span class="mh">0x00</span> <span class="o">&gt;</span> <span class="n">bDeviceSubClass</span>
<span class="n">echo</span> <span class="mi">64</span> <span class="o">&gt;</span> <span class="n">bMaxPacketSize0</span>
<span class="n">echo</span> <span class="mh">0x8730</span> <span class="o">&gt;</span> <span class="n">idProduct</span>
<span class="n">echo</span> <span class="mh">0x0BDA</span> <span class="o">&gt;</span> <span class="n">idVendor</span>
<span class="n">mkdir</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">echo</span> <span class="s2">&quot;Realtek&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">manufacturer</span>
<span class="n">echo</span> <span class="s2">&quot;HID&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">product</span>
<span class="n">echo</span> <span class="s2">&quot;123456789AB&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">serialnumber</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span>
<span class="n">echo</span> <span class="mi">120</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">MaxPower</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">echo</span> <span class="s2">&quot;Primary configuration&quot;</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">configuration</span>
</pre></div>
</div>
</li>
<li><p>Configure HID report descriptor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">functions</span><span class="o">/</span><span class="n">hid</span><span class="o">.</span><span class="n">usb0</span>
<span class="n">echo</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">functions</span><span class="o">/</span><span class="n">hid</span><span class="o">.</span><span class="n">usb0</span><span class="o">/</span><span class="n">subclass</span>
<span class="n">echo</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">functions</span><span class="o">/</span><span class="n">hid</span><span class="o">.</span><span class="n">usb0</span><span class="o">/</span><span class="n">protocol</span>
<span class="n">echo</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">functions</span><span class="o">/</span><span class="n">hid</span><span class="o">.</span><span class="n">usb0</span><span class="o">/</span><span class="n">report_length</span>
<span class="n">echo</span> <span class="o">-</span><span class="n">ne</span>\\<span class="n">x05</span>\\<span class="n">x01</span>\\<span class="n">x09</span>\\<span class="n">x02</span>\\<span class="n">xa1</span>\\<span class="n">x01</span>\\<span class="n">x09</span>\\<span class="n">x01</span>\\<span class="n">xa1</span>\\<span class="n">x00</span>\\<span class="n">x05</span>\\<span class="n">x09</span>\\<span class="n">x19</span>\\<span class="n">x01</span>\\<span class="n">x29</span>\\<span class="n">x03</span>\\<span class="n">x15</span>\\<span class="n">x00</span>\\<span class="n">x25</span>\\<span class="n">x01</span>\\<span class="n">x95</span>\\<span class="n">x03</span>\\<span class="n">x75</span>\\<span class="n">x01</span>\\<span class="n">x81</span>\\<span class="n">x02</span>\\<span class="n">x95</span>\\<span class="n">x01</span>\\<span class="n">x75</span>\\<span class="n">x05</span>\\<span class="n">x81</span>\\<span class="n">x03</span>\\<span class="n">x05</span>\\<span class="n">x01</span>\\<span class="n">x09</span>\\<span class="n">x30</span>\\<span class="n">x09</span>\\<span class="n">x31</span>\\<span class="n">x09</span>\\<span class="n">x38</span>\\<span class="n">x15</span>\\<span class="n">x81</span>\\<span class="n">x25</span>\\<span class="n">x7f</span>\\<span class="n">x75</span>\\<span class="n">x08</span>\\<span class="n">x95</span>\\<span class="n">x03</span>\\<span class="n">x81</span>\\<span class="n">x06</span>\\<span class="n">xc0</span>\\<span class="n">xc0</span><span class="o">&gt;</span> <span class="n">functions</span><span class="o">/</span><span class="n">hid</span><span class="o">.</span><span class="n">usb0</span><span class="o">/</span><span class="n">report_desc</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">functions</span><span class="o">/</span><span class="n">hid</span><span class="o">.</span><span class="n">usb0</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span>
<span class="n">echo</span> <span class="mf">40080000.</span><span class="n">usb</span> <span class="o">&gt;</span> <span class="n">UDC</span>
</pre></div>
</div>
</li>
</ol>
<p>Once connect the board to HID host, use can use interface “/dev/hidg0” to communicate with host. The following is an example that make the cursor move 0x40 pixels to the right and down:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">-</span><span class="n">ne</span> <span class="s2">&quot;</span><span class="se">\0\x40\x40\0</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">hidg0</span>
</pre></div>
</div>
<p>The following is mouse protocol.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BYTE0</span>
<span class="o">|--</span> <span class="n">bit7</span><span class="o">~</span><span class="n">bit3</span><span class="p">:</span> <span class="n">RSVD</span>
<span class="o">|--</span> <span class="n">bit2</span><span class="p">:</span> <span class="n">middle</span> <span class="n">button</span> <span class="n">press</span>
<span class="o">|--</span> <span class="n">bit1</span><span class="p">:</span> <span class="n">right</span> <span class="n">button</span> <span class="n">press</span>
<span class="o">|--</span> <span class="n">bit0</span><span class="p">:</span> <span class="n">left</span> <span class="n">button</span> <span class="n">press</span>
<span class="n">BYTE1</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="n">axis</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="o">~</span><span class="mi">127</span>
<span class="n">BYTE2</span><span class="p">:</span> <span class="n">y</span><span class="o">-</span><span class="n">axis</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="o">~</span><span class="mi">127</span>
<span class="n">BYTE3</span><span class="p">:</span> <span class="n">wheel</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="o">~</span><span class="mi">127</span>
</pre></div>
</div>
</section>
</section>
<section id="id29">
<h2>Mass Storage Class<a class="headerlink" href="#id29" title="Link to this heading"></a></h2>
<section id="id30">
<h3>Configuration<a class="headerlink" href="#id30" title="Link to this heading"></a></h3>
<p>Besides the common USB device configurations, extra configurations are required to support USB mass storage class, and user can choose to configure it as built-in functions or independent kernel modules.</p>
<section id="id31">
<h4>Built-in Configuration<a class="headerlink" href="#id31" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select the following options in USB Gadget Support:</p>
<ul class="simple">
<li><p>USB Gadget functions configurable through configfs</p></li>
<li><p>Mass storage</p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/mass_storage_built_in_configuration_options_usb_gadget_support.png"><img alt="../../_images/mass_storage_built_in_configuration_options_usb_gadget_support.png" src="../../_images/mass_storage_built_in_configuration_options_usb_gadget_support.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
</ol>
</section>
<section id="id32">
<h4>Module Configuration<a class="headerlink" href="#id32" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Select the following items in USB Gadget Support:</p>
<ul class="simple">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">M</span></code> to select <strong>USB Gadget functions configurable through configfs</strong></p></li>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select <strong>Mass storage</strong></p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/mass_storage_module_configuration_options_usb_gadget_support.png"><img alt="../../_images/mass_storage_module_configuration_options_usb_gadget_support.png" src="../../_images/mass_storage_module_configuration_options_usb_gadget_support.png" style="width: 846.9px; height: 702.0px;" /></a>
</figure>
</li>
<li><p>Load kernel modules about MSC class after loading common USB device modules.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">udc</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">usb_f_mass_storage</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">libcomposite</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</section>
</section>
<section id="id33">
<h3>APIs for Application<a class="headerlink" href="#id33" title="Link to this heading"></a></h3>
<p>Refer to <a class="reference external" href="http://www.linux-usb.org/USB-guide/x498.html">http://www.linux-usb.org/USB-guide/x498.html</a>.</p>
</section>
<section id="id34">
<h3>Usage<a class="headerlink" href="#id34" title="Link to this heading"></a></h3>
<p>Example to set the board as a USB gadget mass storage device, with SD card as storage media:</p>
<ol class="arabic">
<li><p>Configure SD card of the board, refer to Chapter SDIO Host for details.</p></li>
<li><p>Connect the board to PC.</p></li>
<li><p>Run the following commands in board console.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span>
<span class="n">mount</span> <span class="n">none</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span> <span class="o">-</span><span class="n">t</span> <span class="n">configfs</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">usb_gadget</span>
<span class="n">mkdir</span> <span class="n">msc</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="n">msc</span>
<span class="n">echo</span> <span class="mh">0x0200</span> <span class="o">&gt;</span> <span class="n">bcdUSB</span>
<span class="n">echo</span> <span class="mh">0x8730</span> <span class="o">&gt;</span> <span class="n">idProduct</span>
<span class="n">echo</span> <span class="mh">0x0BDA</span> <span class="o">&gt;</span> <span class="n">idVendor</span>
<span class="n">mkdir</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">echo</span> <span class="s2">&quot;Realtek&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">manufacturer</span>
<span class="n">echo</span> <span class="s2">&quot;MSC&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">product</span>
<span class="n">echo</span> <span class="s2">&quot;123456789AB&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">serialnumber</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span>
<span class="n">echo</span> <span class="mi">120</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">MaxPower</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">echo</span> <span class="s2">&quot;mass_storage&quot;</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">configuration</span>
<span class="n">mkdir</span> <span class="n">functions</span><span class="o">/</span><span class="n">mass_storage</span><span class="mf">.0</span>
<span class="n">echo</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0</span> <span class="o">&gt;</span><span class="n">functions</span><span class="o">/</span><span class="n">mass_storage</span><span class="mf">.0</span><span class="o">/</span><span class="n">lun</span><span class="mf">.0</span><span class="o">/</span><span class="n">file</span>
<span class="n">echo</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">functions</span><span class="o">/</span><span class="n">mass_storage</span><span class="mf">.0</span><span class="o">/</span><span class="n">lun</span><span class="mf">.0</span><span class="o">/</span><span class="n">removable</span>
<span class="n">echo</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">functions</span><span class="o">/</span><span class="n">mass_storage</span><span class="mf">.0</span><span class="o">/</span><span class="n">lun</span><span class="mf">.0</span><span class="o">/</span><span class="n">nofua</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">functions</span><span class="o">/</span><span class="n">mass_storage</span><span class="mf">.0</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span>
<span class="n">echo</span> <span class="mf">40080000.</span><span class="n">usb</span> <span class="o">&gt;</span> <span class="n">UDC</span>
</pre></div>
</div>
</li>
</ol>
<p>The board will be recognized as a UDISK on PC.</p>
</section>
</section>
<section id="id35">
<h2>Vendor Class<a class="headerlink" href="#id35" title="Link to this heading"></a></h2>
<p>Vendor class is designed for user to develop customized USB device class.</p>
<section id="id36">
<h3>Configuration<a class="headerlink" href="#id36" title="Link to this heading"></a></h3>
<p>Besides the common USB device configurations, extra configurations are required to support USB vendor class driver, and user can choose to configure it as built-in functions or independent kernel modules.</p>
<section id="id37">
<h4>Built-in Configuration<a class="headerlink" href="#id37" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select the following options in USB Gadget Support:</p>
<ul class="simple">
<li><p>USB Gadget functions configurable through configfs</p></li>
<li><p>Loopback and sourcesink function (for testing)</p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/vendor_built_in_configuration_options_usb_gadget_support.png"><img alt="../../_images/vendor_built_in_configuration_options_usb_gadget_support.png" src="../../_images/vendor_built_in_configuration_options_usb_gadget_support.png" style="width: 742.5px; height: 679.5px;" /></a>
</figure>
</li>
</ol>
</section>
<section id="id38">
<h4>Module Configuration<a class="headerlink" href="#id38" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Select the following options in USB Gadget Support:</p>
<ul class="simple">
<li><p>Type <code class="docutils literal notranslate"><span class="pre">M</span></code> to select <strong>USB Gadget functions configurable through configfs</strong></p></li>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">Y</span></code> to select <strong>Loopback and sourcesink function (for testing)</strong></p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/vendor_module_configuration_options_usb_gadget_support.png"><img alt="../../_images/vendor_module_configuration_options_usb_gadget_support.png" src="../../_images/vendor_module_configuration_options_usb_gadget_support.png" style="width: 846.0px; height: 703.8000000000001px;" /></a>
</figure>
</li>
<li><p>Load kernel modules about vendor class after loading common USB device modules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">udc</span><span class="o">-</span><span class="n">core</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">usb_f_ss_lb</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/&lt;</span><span class="n">kernel_ver</span><span class="o">&gt;/</span><span class="n">kernel</span><span class="o">/</span><span class="n">drivers</span><span class="o">/</span><span class="n">usb</span><span class="o">/</span><span class="n">gadget</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">libcomposite</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="id39">
<h3>APIs for Application<a class="headerlink" href="#id39" title="Link to this heading"></a></h3>
<p>None.</p>
</section>
<section id="id40">
<h3>Usage<a class="headerlink" href="#id40" title="Link to this heading"></a></h3>
<p>Here are the steps to test USB gadget vendor class:</p>
<ol class="arabic">
<li><p>Run the following commands in board console.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span>
<span class="n">mount</span> <span class="n">none</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span> <span class="o">-</span><span class="n">t</span> <span class="n">configfs</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">usb_gadget</span>
<span class="n">mkdir</span> <span class="n">vendor</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="n">vendor</span>
<span class="n">echo</span> <span class="mh">0x0200</span> <span class="o">&gt;</span> <span class="n">bcdUSB</span>
<span class="n">echo</span> <span class="mh">0xa4a0</span> <span class="o">&gt;</span> <span class="n">idProduct</span>
<span class="n">echo</span> <span class="mh">0x0525</span> <span class="o">&gt;</span> <span class="n">idVendor</span>
<span class="n">mkdir</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">echo</span> <span class="s2">&quot;Realtek&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">manufacturer</span>
<span class="n">echo</span> <span class="s2">&quot;Vendor&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">product</span>
<span class="n">echo</span> <span class="s2">&quot;123456789AB&quot;</span> <span class="o">&gt;</span> <span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">serialnumber</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.2</span>
<span class="n">echo</span> <span class="mi">120</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">MaxPower</span>
<span class="n">echo</span> <span class="mi">120</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.2</span><span class="o">/</span><span class="n">MaxPower</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">mkdir</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.2</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span>
<span class="n">echo</span> <span class="s2">&quot;vendor1&quot;</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">configuration</span>
<span class="n">echo</span> <span class="s2">&quot;vendor2&quot;</span> <span class="o">&gt;</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.2</span><span class="o">/</span><span class="n">strings</span><span class="o">/</span><span class="mh">0x409</span><span class="o">/</span><span class="n">configuration</span>
<span class="n">mkdir</span> <span class="n">functions</span><span class="o">/</span><span class="n">SourceSink</span><span class="mf">.0</span>
<span class="n">mkdir</span> <span class="n">functions</span><span class="o">/</span><span class="n">Loopback</span><span class="mf">.0</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">functions</span><span class="o">/</span><span class="n">SourceSink</span><span class="mf">.0</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.1</span><span class="o">/</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">functions</span><span class="o">/</span><span class="n">Loopback</span><span class="mf">.0</span> <span class="n">configs</span><span class="o">/</span><span class="n">c</span><span class="mf">.2</span><span class="o">/</span>
<span class="n">echo</span> <span class="mf">40080000.</span><span class="n">usb</span> <span class="o">&gt;</span> <span class="n">UDC</span>
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since vendor class is a composite device, so:</p>
<ul class="simple">
<li><p>ln -s functions/SourceSink.0 configs/c.1/ means default function is sourcesink.</p></li>
<li><p>ln -s functions/Loopback.0 configs/c.1/ means default function is loopback.</p></li>
</ul>
</div>
<ol class="arabic" start="2">
<li><p>Connect the board to USB host vendor.</p></li>
<li><p>Host vendor and device vendor test each other.</p>
<table class="docutils align-default" id="id41" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Function</p></th>
<th class="head"><p>Configfs setting</p></th>
<th class="head"><p>Host console command</p></th>
<th class="head"><p>Device console command</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>loopback</p></td>
<td><p>ln -s functions/Loopback.0 configs/c.1/</p></td>
<td><p>testusb -a -c1 -t30 -s256 -g32 -v1</p></td>
<td><p>No need command</p></td>
</tr>
<tr class="row-odd"><td><p>sourcesink</p></td>
<td><p>ln -s functions/SourceSink.0 configs/c.1/</p></td>
<td><p>testusb -a -c1 -tx -s256 -g32 -v1</p></td>
<td><p>No need command</p></td>
</tr>
</tbody>
</table>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For host testing driver, case 30 is used to test loopback function, so host command <code class="docutils literal notranslate"><span class="pre">-t30</span></code> cannot change, other parameters can be modified by user. Case 0~29 are used to test sourcesink function, so <code class="docutils literal notranslate"><span class="pre">-tx</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span></code> means a number in 0~29.</p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="0_usb_index.html" class="btn btn-neutral float-left" title="USB OTG" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../7_sdio/0_sdioh_index.html" class="btn btn-neutral float-right" title="SDIO Host" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Realsil.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 



</body>
</html>