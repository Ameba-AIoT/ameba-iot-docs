

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DSP 配置 &mdash; Ameba IoT Docs  文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=b947ea82" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=b947ea82" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=7d86a446"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/toggleprompt.js?v=d7ede5d2"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script src="../../_static/translations.js?v=beaddf03"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="批量生产" href="../6_mass_production/0_mp_index_cn.html" />
    <link rel="prev" title="DSP 编译环境" href="dsp_build_environment_cn.html" />
     

    
        
        <script>
        // 配置豁免路径（需要与后端路由完全匹配）
        const EXEMPT_PATHS = [
            '/_',                     // Sphinx生成路径
            '/_static',               // 静态资源路径
            '/_images',               // 图片资源
            '/register',              // 注册
            '/login',                 // 登录页面
            '/logout',                // 登出端点
            '/check_session',         // 会话检查
            '/nda_restricted'         // 无权限提示页
        ];

        // 增强型路径检查
        function isExemptPath(targetPath = window.location.pathname) {
            const path = targetPath.toLowerCase();
            const fullExemptPaths = EXEMPT_PATHS.concat(
                EXEMPT_PATHS.map(p => `/en${p}`),  // 英文路径
                EXEMPT_PATHS.map(p => `/zh_CN${p}`) // 中文路径
            );

            return fullExemptPaths.some(exempt => {
                // 精确匹配或前缀匹配
                return path === exempt.toLowerCase() || 
                    path.startsWith(exempt.toLowerCase() + '/');
            });
        }
        </script>
    

    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- 样式模板 -->
    

<style>
    .wy-nav-content {
        transition: margin 0.3s ease; /* 添加过渡效果 */
        margin-left: 0px !important; /* 侧边栏展开时的偏移 */
        max-width: calc(100% - 0px) !important; /* 调整最大宽度，使其与侧边栏宽度相关 */
         
    }

    .wy-nav-content.expanded {
        margin-left: 0 !important; /* 侧边栏收缩时内容区域回归左边 */
        max-width: 100% !important; /* 内容区域最大宽度调整 */
    }
</style>
    

<style>
    .wy-nav-content {
        max-width: 1100px;
         
    }

    #sidebar-toggle-button {
        position: fixed;
        left: 290px;
        top: 50%;
        transform: translateY(-50%);
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: none;
        border-color: rgb(228, 224, 224);
        background-color: white;
        color: rgb(135, 125, 125);
        font-size: 20px;
        cursor: pointer;
        z-index: 1000;
        transition: left 0.3s ease;

        /* 新增flex布局 */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0; /* 清除默认内边距 */
        font-size: 12px;  /* 缩小符号尺寸 */
        line-height: 1;   /* 清除行高影响 */
    }
</style>




    <!-- 注入 TOC 映射和当前页面信息 -->
    

<!-- TOC 映射和当前文档信息 -->
<script>
// 将 Python 字典转换为 JS 对象
const TOC_TITLE_MAP = {"rst_rtos/0_ameba_product": "\u4ea7\u54c1\u4e2d\u5fc3", "rst_rtos/0_ameba_product/0_ameba_product_center_index_cn": "\u4ea7\u54c1\u4e2d\u5fc3", "rst_rtos/0_ameba_sdk": "Ameba SDK", "rst_rtos/0_ameba_sdk/0_ameba_sdks_index_cn": "Ameba SDK", "rst_rtos/0_ameba_solutions": "\u89e3\u51b3\u65b9\u6848", "rst_rtos/0_ameba_solutions/0_ameba_solutions_index_cn": "\u89e3\u51b3\u65b9\u6848", "rst_rtos/0_at_command": "0.8 AT \u547d\u4ee4\u96c6", "rst_rtos/0_at_command/0_at_command_index_cn": "0.8 AT \u547d\u4ee4\u96c6", "rst_rtos/0_build_system": "0.3 \u6784\u5efa\u7cfb\u7edf", "rst_rtos/0_build_system/0_build_system_index_cn": "0.3 \u6784\u5efa\u7cfb\u7edf", "rst_rtos/0_file_system": "0.9 \u865a\u62df\u6587\u4ef6\u7cfb\u7edf", "rst_rtos/0_file_system/0_vfs_index_cn": "0.9 \u865a\u62df\u6587\u4ef6\u7cfb\u7edf", "rst_rtos/0_ftl": "0.a Flash \u8f6c\u6362\u5c42", "rst_rtos/0_ftl/0_ftl_index_cn": "0.a Flash \u8f6c\u6362\u5c42", "rst_rtos/0_gcc_build_environment": "0.1 GCC \u7f16\u8bd1\u73af\u5883", "rst_rtos/0_gcc_build_environment/0_gcc_build_index_cn": "0.1 GCC \u7f16\u8bd1\u73af\u5883", "rst_rtos/0_gdb_debug": "0.2 GDB \u8c03\u8bd5", "rst_rtos/0_gdb_debug/0_gdb_debug_index_cn": "0.2 GDB \u8c03\u8bd5", "rst_rtos/0_memory_layout": "0.5 Flash \u548c RAM \u5e03\u5c40", "rst_rtos/0_memory_layout/0_layout_index_cn": "0.5 Flash \u548c RAM \u5e03\u5c40", "rst_rtos/0_sdk_example": "0.4 SDK \u793a\u4f8b", "rst_rtos/0_sdk_example/0_sdk_example_index_cn": "0.4 SDK \u793a\u4f8b", "rst_rtos/0_tools": "0.7 \u5de5\u5177", "rst_rtos/0_tools/0_tools_index_cn": "0.7 \u5de5\u5177", "rst_rtos/0_user_config": "0.6 \u5f00\u53d1\u8005\u914d\u7f6e", "rst_rtos/0_user_config/0_usrcfg_index_cn": "0.6 \u5f00\u53d1\u8005\u914d\u7f6e", "rst_rtos/10_api_docs": "2.6 Wi-Fi API \u53c2\u8003", "rst_rtos/10_api_docs/0_api_index_cn": "2.6 Wi-Fi API \u53c2\u8003", "rst_rtos/1_boot_process": "1.1 \u542f\u52a8\u8fc7\u7a0b", "rst_rtos/1_boot_process/0_boot_index_cn": "1.1 \u542f\u52a8\u8fc7\u7a0b", "rst_rtos/1_chipen": "1.4 \u82af\u7247\u4f7f\u80fd", "rst_rtos/1_chipen/0_chipen_index_cn": "1.4 \u82af\u7247\u4f7f\u80fd", "rst_rtos/1_gpio": "1.7 GPIO \u548c\u5f15\u811a\u63a7\u5236", "rst_rtos/1_gpio/0_gpio_index_cn": "1.7 GPIO \u548c\u5f15\u811a\u63a7\u5236", "rst_rtos/1_ipc": "1.5 \u6838\u95f4\u901a\u4fe1", "rst_rtos/1_ipc/0_ipc_index_cn": "1.5 \u6838\u95f4\u901a\u4fe1", "rst_rtos/1_mpu_cache": "1.0 \u5185\u5b58\u4fdd\u62a4\u5355\u5143\u548c\u7f13\u5b58", "rst_rtos/1_mpu_cache/0_mpu_cache_index_cn": "1.0 \u5185\u5b58\u4fdd\u62a4\u5355\u5143\u548c\u7f13\u5b58", "rst_rtos/1_ota": "1.2 \u56fa\u4ef6\u5347\u7ea7\uff08OTA\uff09", "rst_rtos/1_ota/0_ota_index_cn": "1.2 \u56fa\u4ef6\u5347\u7ea7\uff08OTA\uff09", "rst_rtos/1_otpc": "1.3 OTP\u5b58\u50a8\u5668", "rst_rtos/1_otpc/0_otpc_index_cn": "1.3 OTP\u5b58\u50a8\u5668", "rst_rtos/1_pinmux": "1.6 \u5f15\u811a\u590d\u7528", "rst_rtos/1_pinmux/0_pinmux_index_cn": "1.6 \u5f15\u811a\u590d\u7528", "rst_rtos/1_power_save": "1.9 \u4f4e\u529f\u8017\u5f00\u53d1", "rst_rtos/1_power_save/0_ps_index_cn": "1.9 \u4f4e\u529f\u8017\u5f00\u53d1", "rst_rtos/2_whc_fullmac": "2.2 WHC FullMAC", "rst_rtos/2_whc_fullmac/0_fullmac_index_cn": "2.2 WHC FullMAC", "rst_rtos/2_whc_wifi_bridge": "2.1 WHC Bridge", "rst_rtos/2_whc_wifi_bridge/0_wifi_bridge_index_cn": "2.1 WHC Bridge", "rst_rtos/2_wifi_adaptivity_test": "2.5 Wi-Fi Adaptivity \u6d4b\u8bd5\u6307\u5357", "rst_rtos/2_wifi_adaptivity_test/0_wifi_adaptivity_index_cn": "2.5 Wi-Fi Adaptivity \u6d4b\u8bd5\u6307\u5357", "rst_rtos/2_wifi_basic": "2.0 Wi-Fi\u57fa\u7840\u6a21\u5f0f", "rst_rtos/2_wifi_basic/0_wifi_basic_index_cn": "2.0 Wi-Fi\u57fa\u7840\u6a21\u5f0f", "rst_rtos/2_wifi_csi": "2.4 Wi-Fi CSI", "rst_rtos/2_wifi_csi/0_wifi_csi_index_cn": "2.4 Wi-Fi CSI", "rst_rtos/2_wifi_tunnel": "2.3 Wi-Fi R-Mesh", "rst_rtos/2_wifi_tunnel/0_wifi_tunnel_index_cn": "2.3 Wi-Fi R-Mesh", "rst_rtos/3_ap_trustzone": "3.d AP \u5b89\u5168\u670d\u52a1", "rst_rtos/3_ap_trustzone/0_ap_tz_index_cn": "3.d AP \u5b89\u5168\u670d\u52a1", "rst_rtos/3_crypto_engine": "3.9 \u5bf9\u79f0\u786c\u4ef6\u52a0\u5bc6\u5f15\u64ce", "rst_rtos/3_crypto_engine/0_crypto_engine_index_cn": "3.9 \u5bf9\u79f0\u786c\u4ef6\u52a0\u5bc6\u5f15\u64ce", "rst_rtos/3_ecdsa_engine": "3.a ECDSA \u786c\u4ef6\u52a0\u5bc6\u5f15\u64ce", "rst_rtos/3_ecdsa_engine/0_ecdsa_index_cn": "3.a ECDSA \u786c\u4ef6\u52a0\u5bc6\u5f15\u64ce", "rst_rtos/3_eddsa_engine": "3.b EDDSA \u786c\u4ef6\u52a0\u5bc6\u5f15\u64ce", "rst_rtos/3_eddsa_engine/0_eddsa_index_cn": "3.b EDDSA \u786c\u4ef6\u52a0\u5bc6\u5f15\u64ce", "rst_rtos/3_nda_huk_derivation": "3.3 HUK \u751f\u6210 \ud83d\udd12", "rst_rtos/3_nda_huk_derivation/0_huk_derivation_index_nda": "3.3 HUK \u751f\u6210 \ud83d\udd12", "rst_rtos/3_nda_rdp": "3.4 RDP \ud83d\udd12", "rst_rtos/3_nda_rdp/0_rdp_index_nda_cn": "3.4 RDP \ud83d\udd12", "rst_rtos/3_nda_rsip": "3.5 RSIP \ud83d\udd12", "rst_rtos/3_nda_rsip/0_rsip_index_nda_cn": "3.5 RSIP \ud83d\udd12", "rst_rtos/3_nda_secure_boot": "3.6 \u5b89\u5168\u542f\u52a8 \ud83d\udd12", "rst_rtos/3_nda_secure_boot/0_secure_boot_index_nda": "3.6 \u5b89\u5168\u542f\u52a8 \ud83d\udd12", "rst_rtos/3_nda_swd_protection": "3.7 SWD \u4fdd\u62a4 \ud83d\udd12", "rst_rtos/3_nda_swd_protection/0_swd_protection_index_nda": "3.7 SWD \u4fdd\u62a4 \ud83d\udd12", "rst_rtos/3_nda_tfm": "3.8 \u53ef\u4fe1\u4efb\u56fa\u4ef6(TF-M) \ud83d\udd12", "rst_rtos/3_nda_tfm/0_tfm_index_nda_cn": "3.8 \u53ef\u4fe1\u4efb\u56fa\u4ef6(TF-M) \ud83d\udd12", "rst_rtos/3_rsa_engine": "3.c RSA \u786c\u4ef6\u52a0\u5bc6\u5f15\u64ce", "rst_rtos/3_rsa_engine/0_rsa_index_cn": "3.c RSA \u786c\u4ef6\u52a0\u5bc6\u5f15\u64ce", "rst_rtos/3_security": "3.1 \u5b89\u5168\u4e0e\u52a0\u5bc6", "rst_rtos/3_security/0_security_index_cn": "3.1 \u5b89\u5168\u4e0e\u52a0\u5bc6", "rst_rtos/3_trng": "3.2 \u771f\u968f\u673a\u6570\u53d1\u751f\u5668", "rst_rtos/3_trng/0_trng_index_cn": "3.2 \u771f\u968f\u673a\u6570\u53d1\u751f\u5668", "rst_rtos/4_ai": "4.1 \u4eba\u5de5\u667a\u80fd", "rst_rtos/4_ai/0_ai_index_cn": "4.1 \u4eba\u5de5\u667a\u80fd", "rst_rtos/4_ai_voice": "4.2 \u8bed\u97f3\u8bc6\u522b", "rst_rtos/4_ai_voice/0_ai_voice_index_cn": "4.2 \u8bed\u97f3\u8bc6\u522b", "rst_rtos/4_dsp": "4.4 DSP \u4f7f\u7528\u6307\u5357", "rst_rtos/4_dsp/0_dsp_index_cn": "4.4 DSP \u4f7f\u7528\u6307\u5357", "rst_rtos/4_multimedia": "4.3 \u591a\u5a92\u4f53", "rst_rtos/4_multimedia/0_multimedia_index_cn": "4.3 \u591a\u5a92\u4f53", "rst_rtos/6_mass_production": "6.1 \u6279\u91cf\u751f\u4ea7", "rst_rtos/6_mass_production/0_mp_index_cn": "6.1 \u6279\u91cf\u751f\u4ea7", "rst_rtos/6_mptools": "6.2 \u4ea7\u6d4b\u5de5\u5177", "rst_rtos/6_mptools/0_mptools_index_cn": "6.2 \u4ea7\u6d4b\u5de5\u5177", "rst_rtos/7_usb": "7.1 USB \u4e3b\u673a\u4e0e\u8bbe\u5907", "rst_rtos/7_usb/0_usb_index_cn": "7.1 USB \u4e3b\u673a\u4e0e\u8bbe\u5907", "rst_rtos/8_adc": "8.4 \u6a21\u6570\u8f6c\u6362\u5668", "rst_rtos/8_adc/0_adc_index_cn": "8.4 \u6a21\u6570\u8f6c\u6362\u5668", "rst_rtos/8_cap_touch": "8.7 Cap-Touch", "rst_rtos/8_cap_touch/0_cap_touch_index_cn": "8.7 Cap-Touch", "rst_rtos/8_dmac": "8.1 DMA \u63a7\u5236\u5668", "rst_rtos/8_dmac/0_dmac_index_cn": "8.1 DMA \u63a7\u5236\u5668", "rst_rtos/8_ir": "8.5 \u7ea2\u5916\u6536\u53d1\u5668", "rst_rtos/8_ir/0_ir_index_cn": "8.5 \u7ea2\u5916\u6536\u53d1\u5668", "rst_rtos/8_key_scan": "8.8 Key-Scan", "rst_rtos/8_key_scan/0_key_scan_index_cn": "8.8 Key-Scan", "rst_rtos/8_lcdc": "8.a LCD \u63a7\u5236\u5668", "rst_rtos/8_lcdc/0_lcdc_index_cn": "8.a LCD \u63a7\u5236\u5668", "rst_rtos/8_ledc": "8.6 LED \u63a7\u5236\u5668", "rst_rtos/8_ledc/0_ledc_index_cn": "8.6 LED \u63a7\u5236\u5668", "rst_rtos/8_psram": "8.2 PSRAM", "rst_rtos/8_psram/0_psram_index_cn": "8.2 PSRAM", "rst_rtos/8_rtc_io": "8.9 RTC-IO", "rst_rtos/8_rtc_io/0_rtc_io_index_cn": "8.9 RTC-IO", "rst_rtos/8_thermal": "8.3 \u6e29\u5ea6\u6d4b\u91cf", "rst_rtos/8_thermal/0_thermal_index_cn": "8.3 \u6e29\u5ea6\u6d4b\u91cf"};
console.log("TOC_TITLE_MAP:", TOC_TITLE_MAP);

// 获取当前页面的文档名 (例如 'rst_rtos/3_nda_secure_boot/0_secure_boot_index_nda')
const CURRENT_DOCNAME = 'rst_rtos/4_dsp/dsp_configuration_cn';

// 动态查找顶级分类函数（定义为全局函数）
window.findTopLevelChapter = function(docname) {
    console.log("Attempting to find top-level chapter for:", docname);
    let bestMatch = "";
    let bestTitle = "Unknown Chapter";

    // 按路径长度降序排序以确保最长匹配
    const sortedPaths = Object.keys(TOC_TITLE_MAP).sort((a, b) => b.length - a.length);

    for (const path of sortedPaths) {
        console.log("Checking path:", path);
        if (docname === path || docname.startsWith(path + '/')) { // 子页面
            bestMatch = path;
            bestTitle = TOC_TITLE_MAP[path];
            console.log("Matched path:", path, "with title:", bestTitle);
            break;
        }
    }

    // 如果没有找到任何匹配项，则尝试更短的路径
    if (bestMatch === "") {
        const pathSegments = docname.split('/');
        while (pathSegments.length > 1) { // 至少保留根路径
            const candidate = pathSegments.join('/');
            console.log("Checking shorter path:", candidate);
            if (TOC_TITLE_MAP[candidate]) {
                bestTitle = TOC_TITLE_MAP[candidate];
                console.log("Matched shorter path:", candidate, "with title:", bestTitle);
                break;
            }
            pathSegments.pop();
        }
    }

    console.log("Final top-level chapter:", bestTitle);
    return bestTitle;
}

// 初始化时调用
document.addEventListener('DOMContentLoaded', function() {
    const topLevelChapter = findTopLevelChapter(CURRENT_DOCNAME);
    console.log("Top Level Chapter:", topLevelChapter);

    // 将顶级分类插入到DOM中（根据需要）
    const chapterElement = document.createElement('div');
    chapterElement.className = 'top-level-chapter';
    chapterElement.innerHTML = `<strong>Top Level Chapter: </strong>${topLevelChapter}`;
    document.body.appendChild(chapterElement);
});
</script>

    <style>
        /* ====================== 紧凑型选择器 ====================== */
        #topleft-panel {
            background: rgba(40, 58, 73, 0.9);
            border-radius: 4px;
            padding: 4px;
            margin: 4px 0;
            box-shadow: 0 4px 4px rgba(0,0,0,0.15);
            backdrop-filter: blur(4px);
        }

        .selectors-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 三列等宽 */
            gap: 4px;
            padding: 1px 1px;
        }

        .dual-selector-group {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 两列等宽 */
            gap: 4px; /* 列间距 */
        }

        .selector-group {
            position: relative;
            width: 100%; /* 确保填满网格列 */
        }

        .selector-label {
            display: block;
            color: #a0b3c6;
            font-size: 0.85em;
            margin-bottom: 4px;
            padding-left: 4px;
        }

        .selector-dropdown {
            width: 100%;
            margin: 3px 0;
            padding: 4px 6px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 0.95em;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a0b3c6'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        .selector-dropdown:hover {
            border-color: #4a6a8b;
            background-color: rgba(44, 62, 80, 1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .selector-dropdown:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            #topleft-panel {
                margin: 8px 0;
                padding: 10px;
            }

            .selectors-grid {
                grid-template-columns: 1fr; /* 小屏幕下堆叠显示 */
                gap: 10px;
            }

            .selector-dropdown {
                padding: 10px 12px;
            }

            .dual-selector-group {
                grid-template-columns: 1fr; /* 小屏幕下堆叠显示 */
            }
        }
    </style>

    

<style>
    /* ================= 用户面板 ================= */
    .user-panel {
        /* background: rgba(255,255,255,0.1); */
        background: rgba(255, 255, 255, 0.05); /* 更暗的背景 */
        border-radius: 4px;
        padding: 1px 1px; /* 上下间距减少 */
        margin: 4px 0px; /* 左右各10px边距 */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);

        width: calc(100% - 4px); /* 宽度占满父容器减去20px（左右边距总和） */
        max-width: 280px; /* 设置最大宽度，防止过宽 */
        box-sizing: border-box; /* 确保padding和border不影响总宽度 */
    }

    #user-info {
        display: flex;
        gap: 4px;
        align-items: center;
        padding: 4px 0;
        width: 100%;
    }

    .username-btn, .logout-btn, .link-btn, .auth-btn {
        flex: 1; /* 均分剩余空间 */
        margin: 3px 0;           /* 减少外链按钮间距 */
        padding: 4px 6px;       /* 减少内边距 */
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 6px;
        color: white;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
    }

    .username-btn:hover {
        background: #92b5bb;
    }

    #username-display {
        font-size: 0.95em;
        color: white !important; /* 白色文字 */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
    }

    .logout-btn:hover {
        background: #c0392b;
    }

    /* ================= 按钮容器 ================= */
    .button-row {
        display: flex;
        gap: 4px;
        width: 100%;
        margin: 4px 0;
    }

    .auth-btn:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    /* 外链按钮 */
    .external-links {
        display: flex;       /* 新增Flex布局 */
        gap: 4px;           /* 按钮间距 */
        width: 100%;        /* 确保容器宽度填满父级 */
    }

    .link-btn:hover {
        background: rgba(255,255,255,0.1);
        transform: translateY(-1px);
    }

    .btn-text {
        font-size: 0.95em;
    }

    .panel-divider {
        height: 1px;
        background: rgba(255,255,255,0.1);
        margin: 2px 0;          /* 减少分隔线间距 */
    }

    /* 桌面端悬停效果 */
    @media (hover: hover) {
        .username-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(255,255,255,0.15);
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
        }
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
        .user-panel {
            padding: 4px 6px;
        }

        .auth-btn {
            padding: 4px 68px;
            font-size: 0.9em;
        }

        .external-links {
            flex-direction: column; /* 移动端垂直排列 */
            gap: 6px;              /* 调整间距 */
        }
        .link-btn {
            width: 100%;          /* 移动端填满宽度 */
            flex: none;           /* 禁用flex缩放 */
        }

        .btn-text {
            font-size: 0.9em;
        }

        #user-info {
            flex-direction: row; /* 保持行排列 */
            gap: 6px;
        }

        .username-btn {
            flex: 1 1 60%;
            padding: 6px 8px;
        }

        .logout-btn {
            flex: 1 1 40%;
            text-align: center;
        }
    }
</style>


    
        <!-- source/_templates/_layout_issue_report.html -->
<style>
    
    #report-button {
        position: fixed;
        bottom: 10px;
        left: 60%;
        transform: translateX(-50%);

        width: 40px;  /* 增加尺寸以便容纳双圆环 */
        height: 40px;
        border-radius: 50%;  /* 保持圆形 */
        border: none;
        background: transparent;  /* 背景透明 */
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #report-button::before, #report-button::after {
        content: "";
        position: absolute;
        border-radius: 50%;
        border: 2px solid;
        background: transparent;
        animation: gradient-shift 8s ease infinite;
    }

    #report-button::before {
        width: 40px; /* 外圈直径 */
        height: 40px;
        background: linear-gradient(45deg, #ff0066, #f7ff00, #00fff0); /* 渐变颜色效果 */
        border-radius: 50%;
        z-index: 0;
        box-shadow: 0 0 15px rgba(255, 0, 102, 0.5), 0 0 25px rgba(247, 255, 0, 0.5), 0 0 35px rgba(0, 255, 240, 0.5);
    }

    #report-button::after {
        width: 30px; /* 内圈直径 */
        height: 30px;
        background: white;
        border-radius: 50%;
        z-index: 0;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    #report-button i {
        font-size: 20px; /* 内部图标大小 */
        color: rgb(71, 74, 71);
        position: relative;
        z-index: 1; /* 确保图标在圆环上层展示 */
    }


    /* 幻彩渐变（未来感） */
    @keyframes gradient-shift {
        0% { border-color: #ff6b6b; }
        20% { border-color: #ff9f43; }
        40% { border-color: #f6e58d; }
        60% { border-color: #7bed9f; }
        80% { border-color: #70a1ff; }
        100% { border-color: #5352ed; }
    }

    /* 悬停效果 */
    #report-button:hover::before,
    #report-button:hover::after {
        transform: scale(1.05) rotate(3deg);
        filter: saturate(150%);
        animation-play-state: paused;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
    }

    /* 点击效果 */
    #report-button:active::before,
    #report-button:active::after {
        transform: scale(0.95) rotate(-2deg);
        transition: transform 0.1s;
    }
</style>

<style>
    
    .feedback-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fffaf0; /* 淡暖色调 */
        padding: 20px;
        border-radius: 16px; /* 增加圆角 */
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* 更柔和的阴影 */
        z-index: 1001;
        width: 800px;
        height: 600px;
        font-family: 'Arial', sans-serif; /* 使用更清晰的字体 */
    }

    .feedback-dialog textarea {
        width: 100%;
        height: 150px;
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
        font-size: 16px; /* 增大字体 */
    }

    .feedback-dialog button {
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #ff7f50; /* 柔和的橙色 */
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s; /* 添加过渡效果 */
    }

    .feedback-dialog button:hover {
        background-color: #ff6243; /* 悬停状态的颜色 */
    }

    .feedback-dialog button:active {
        background-color: #db5538; /* 点击状态的颜色 */
    }

    .feedback-dialog .form-group {
        margin: 10px 0; /* 增加间距 */
    }

    .feedback-dialog label {
        font-weight: bold;
        font-size: 14px; /* 增大标签字体 */
        color: #333; /* 深色字体 */
    }

    .feedback-dialog select .feedback-dialog textarea {
        background-color: #fff8e1; /* 提交区域的背景色 */
    }

    
    
</style>

<div id="prompt-box" style="
    display: none;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    z-index: 9999;
    text-align: center;
    font-size: 14px;
"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict'; // 添加严格模式

    // 获取所有DOM元素引用
    const reportButton = document.getElementById('report-button');
    const feedbackDialog = document.getElementById('feedback-dialog');
    const feedbackText = document.getElementById('inquire_input');
    const submitButton = document.getElementById('submit-feedback');
    const cancelButton = document.getElementById('cancel-feedback');
    const promptBox = document.getElementById('prompt-box');
    const chapterSelect = document.getElementById('chapter-select');
    const paragraphInput = document.getElementById('paragraph-input');
    const postTypeSelect = document.getElementById('post-type');
    console.log('帖子类型(postTypeSelect)DOM元素:', postTypeSelect); // 应输出<select>元素

    // 状态变量
    let hasUserInput = false; // 跟踪用户是否主动输入
    let selectedText = '';
    const language = 'zh-CN'; // 从模板引擎获取语言变量

    // 初始化时设置placeholder
    paragraphInput.placeholder = language === 'zh_CN' 
        ? '你可以先选择有问题的段落或手动输入...'
        : 'You can select/paste text or type directly here...';

    // 获取当前激活的章节
    function getCurrentChapter() {
        try {
            // 通过激活的菜单项获取当前章节
            const currentLink = document.querySelector('.wy-menu .toctree-l1.current > a');
            if (currentLink) {
                return currentLink.textContent.replace('¶', '').trim();
            }

            // 如果没有找到激活的链接，尝试通过页面标题获取
            const pageTitle = document.querySelector('h1');
            if (pageTitle) {
                return pageTitle.textContent.split('\n')[0].trim();
            }

            // 如果以上方法都失败，尝试通过URL路径推断章节
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length > 2) {
                return decodeURIComponent(pathParts[pathParts.length - 2]);
            }

            return null;
        } catch (error) {
            console.error('获取当前章节失败:', error);
            return null;
        }
    }

    // 填充章节选择框
    function populateChapters() {
        const chapterElements = document.querySelectorAll('.wy-menu .toctree-l1 > a');
        const chapters = Array.from(chapterElements).map(el => el.textContent.replace('¶', '').trim());
        const currentChapter = getCurrentChapter();

        console.log('提取全部章节:', chapters);
        console.log('当前页面章节:', currentChapter);

        if (chapters.length === 0) {
            console.error('未找到章节链接');
            return;
        }

        chapterSelect.innerHTML = '';

        // 添加默认选项
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = language === 'zh_CN' ? '-- 请选择章节 --' : '-- Select Chapter --';
        chapterSelect.appendChild(defaultOption);

        // 添加章节选项
        chapters.forEach(chapter => {
            const option = document.createElement('option');
            option.value = chapter;
            option.textContent = chapter;
            if (chapter === currentChapter) {
                option.selected = true;
            }
            chapterSelect.appendChild(option);
        });
    }

    // 初始化章节选择框
    populateChapters();

    // 报告按钮点击事件（处理文本选择）
    reportButton.addEventListener('click', function() {
        // 重置所有输入字段，每次重新inquire应该让对话框处于默认状态
        feedbackText.value = '';          // 清空问题输入框
        paragraphInput.value = '';        // 清空段落输入框
        selectedText = '';                // 清除之前选择的文本

        const selection = window.getSelection().toString().trim();
        if (selection) {
            paragraphInput.value = selection;
        } else {
            // 保持placeholder提示
            if (!paragraphInput.value.trim()) {
                paragraphInput.value = '';
            }
        }
        feedbackDialog.style.display = 'block';
    });

    // 监听输入事件
    paragraphInput.addEventListener('input', function() {
        // 标记用户已经输入
        this.placeholder = '';
    });

    // 提交按钮点击事件
    submitButton.addEventListener('click', function() {
        const userQuestion = feedbackText.value.trim();
        const selectedChapter = chapterSelect.value;
        const selectedPostType = postTypeSelect.value;
        const paragraphContent = paragraphInput.value.trim() || 'null';

        // 在提交事件顶部添加详细日志
        console.group('=== 提交调试信息 ===');
        console.log('章节选择值:', chapterSelect.value);
        console.log('帖子类型postTypeSelect DOM元素:', postTypeSelect);
        console.log('帖子类型postTypeSelect 选中的选项:', postTypeSelect.options[postTypeSelect.selectedIndex]);
        console.log('帖子类型postTypeSelect 实际值:', postTypeSelect.value); // 应输出'doc_correction' 对应文档纠错
          console.groupEnd();

        // 验证输入
        if (!userQuestion) {
            alert(language === 'zh_CN' ? '问题描述为空' : 'Issue description cannot be empty');
            return;
        }
        if (!selectedChapter) {
            alert(language === 'zh_CN' ? '请选择相关章节' : 'Please select a related chapter');
            return;
        }

        if (!selectedPostType) {
            alert(language === 'zh_CN' ? '请选择帖子类型' : 'Please select a post type');
            return;
        }

        // 获取用户名
        const username = localStorage.getItem('username') || 'Anonymous';

        // 构建提交数据
        const feedbackData = {
            user: username,
            chapters: selectedChapter,
            post_type: selectedPostType,
            paragraph: paragraphContent,
            question: userQuestion
        };

        console.log('完整提交数据:', feedbackData);

        // 发送到后端
        fetch('http://172.29.57.206:5000/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(feedbackData)
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            console.log('提交成功:', data);
            promptBox.textContent = language === 'zh_CN' ? '问题已成功提交' : 'Issue submitted successfully';
            promptBox.style.display = 'block';
            setTimeout(() => promptBox.style.display = 'none', 5000);
        })
        .catch(error => {
            console.error('提交失败:', error);
            promptBox.textContent = language === 'zh_CN' ? '提交失败，请检查网络连接' : 'Submission failed, check your network';
            promptBox.style.display = 'block';
            setTimeout(() => promptBox.style.display = 'none', 5000);
        });

        // 关闭对话框
        feedbackDialog.style.display = 'none';
    });


    // 取消按钮点击事件
    cancelButton.addEventListener('click', function() {
        feedbackDialog.style.display = 'none';
    });

    // 初始化检查
    console.log('问题反馈系统已加载');
    console.log('当前语言:', language);
    console.log('检测到章节数量:', chapterSelect.options.length - 1);
});
</script> <!-- 问题回报 -->
    

    <style>
        /* 隐藏整个搜索栏容器 */
        .wy-side-nav-search > div[role="search"] {
            display: none !important;
        }

        /* 或者更精确地隐藏表单 */
        form#rtd-search-form {
            display: none !important;
        }
    </style>

    <style>
        .extension-container {
            position: fixed;
            left: 10px;
            bottom: 10px;
            z-index: 1000;
        }

        .extension-button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .extension-button:hover {
            background-color: #2980b9;
        }
    </style>

    <style>
        /* 保留bottomleft-panel作为用户面板容器 */
        .bottomleft-panel {
            position: fixed;
            padding: 1px 1px; /* 上下间距减少 */
            left: 0;
            bottom: 0;
            width: 300px;
            height: auto;
            background: #2d2d2d;
            border-top: 1px solid #404040;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.2);
            z-index: 1001;
            transition: left 0.3s ease; /* 为位移动画添加过渡效果 */
        }

        .bottomleft-panel.collapsed {
            left: 60px; /* 收缩后的位置 */
        }
        /* 新增userpanel-container的flex定义 */
        .userpanel-container {
            padding: 10px;
            width: 100%;
        }
        /* 增加字体配置 */
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined' !important;
            font-weight: 400 !important;
            font-style: normal !important;
            line-height: 1 !important;
            letter-spacing: normal !important;
            text-transform: none !important;
        }

        /* 调整父容器定位方式 */
        .userpanel-container {
            position: relative; /* 新增定位上下文 */
        }
    </style>

    <!-- 左上角标题距离控制：Ameba IoT Docs -->
    <style>
        /* 隐藏整个搜索栏容器 */
        .wy-side-nav-search > div[role="search"] {
            display: none !important;
        }

        /* 新增的标题间距调整样式（添加在此处） */
        div[role="navigation"] > div[role="search"] {
            margin-bottom: 4px !important;
        }

        a.icon.icon-home {
            display: inline-block;
            margin-bottom: 2px !important;
        }
    </style>

    <!-- 引入功能模块 -->
    
        
<style>
    .auth-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(3px);
    }

    .auth-content {
        background: #5a6c75; /* 淡蓝色背景 */
        color: white; /* 白色文字 */
        padding: 2rem;
        border-radius: 12px;
        min-width: 380px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        transform: translateY(-20px);
        opacity: 0;
        animation: dialogEnter 0.3s ease forwards;
    }

    @keyframes dialogEnter {
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .auth-title {
        font-size: 1.5rem;
        margin: 0 0 1.5rem;
        font-weight: 600;
        text-align: center;
    }

    .auth-input-group {
        margin-bottom: 0.71rem;
    }

    .auth-label {
        color: white;
        display: block;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .auth-input {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #ecf0f1;
        border-radius: 8px !important;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #25292b !important; /* 深蓝色背景 */
        color: white;
    }

    .auth-input:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
        outline: none;
    }

    .auth-button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .auth-button {
        flex: 1;
        padding: 0.8rem 1.2rem;
        border: none;
        color: white;
        background: #3498db;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .auth-button.cancel {
        background: #f1f2f6;
    }

    .auth-button.confirm:hover {
        background: #dfe4ea;
        transform: translateY(-1px);
    }

    .auth-button.cancel:hover {
        background: #dfe4ea;
    }

    .edit-indicator {
        color: white !important; /* 白色文字 */
        margin-left: 5px;
        font-size: 0.8em;
        vertical-align: super;
    }

    /* 保存状态提示 */
    .saving-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 15px;
        border-radius: 4px;
        display: none;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
        .saving-status {
            bottom: 10px;
            right: 10px;
            font-size: 0.9em;
        }
    }

    @media (max-width: 480px) {
        .auth-content {
            min-width: 90%;
            padding: 1.5rem;
        }

        .auth-input-group {
            margin-bottom: 0.8rem;
        }

        .auth-input {
            padding: 0.7rem;
        }
    }
</style>

<script>
    // 初始化认证对话框
    window.initAuthDialogs = function() {
        function createAuthDialog(type) {
            const lang = document.getElementById('language-selector').value === 'cn' ? 'cn' : 'en';

            // 对话框容器
            const dialog = document.createElement('div');
            dialog.className = 'auth-dialog';  // 使用CSS类替代内联样式

            // 内容容器
            const content = document.createElement('div');
            content.className = 'auth-content';

            // 标题
            const title = document.createElement('h3');
            title.className = 'auth-title';
            title.textContent = type === 'register' 
                ? (lang === 'cn' ? '注册' : 'Register') 
                : (lang === 'cn' ? '登录' : 'Login');

            // 输入字段创建函数
            const createInput = (labelText, inputType) => {
                const container = document.createElement('div');
                container.className = 'auth-input-group';

                const label = document.createElement('label');
                label.className = 'auth-label';
                label.textContent = labelText;

                const input = document.createElement('input');
                input.type = inputType;
                input.className = 'auth-input';

                container.appendChild(label);
                container.appendChild(input);
                return { container, input };
            };

            // 用户名输入
            const username = createInput(lang === 'cn' ? '用户名：' : 'Username:', 'text');
            content.appendChild(username.container);

            // 密码输入
            const password = createInput(lang === 'cn' ? '密码：' : 'Password:', 'password');
            content.appendChild(password.container);

            // Enter键支持
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') confirmBtn.click();
            };

            // 确认密码（仅注册）
            let confirmPassword;
            let companyInput, productInput, emailInput;
            if (type === 'register') {
                const savedData = JSON.parse(sessionStorage.getItem('registerFormData') || '{}');

                confirmPassword = createInput(lang === 'cn' ? '确认密码：' : 'Confirm Password:', 'password');
                content.appendChild(confirmPassword.container);

                // 工作单位
                const company = createInput(lang === 'cn' ? '工作单位：' : 'Company:', 'text');
                content.appendChild(company.container);
                companyInput = company.input;

                // 产品信息 
                const product = createInput(lang === 'cn' ? '产品信息：' : 'Product:', 'text');
                content.appendChild(product.container);
                productInput = product.input;

                // 工作邮箱
                const email = createInput(lang === 'cn' ? '工作邮箱：' : 'Email:', 'email');
                email.input.autocomplete = 'email'; // ➕ 添加自动完成类型

                content.appendChild(email.container);
                emailInput = email.input;

                // 原有字段初始化后添加数据恢复
                username.input.value = savedData.username || '';
                password.input.value = savedData.password || '';
                confirmPassword.input.value = savedData.confirmPassword || '';
                companyInput.value = savedData.company || '';
                productInput.value = savedData.product || '';
                emailInput.value = savedData.email || '';

                // 添加Enter键支持到新字段
                [companyInput, productInput, emailInput].forEach(input => {
                    input.addEventListener('keypress', handleKeyPress);
                });

                // 新增代码：实时保存输入数据
                const saveFormData = () => {
                    const formData = {
                        username: username.input.value,
                        password: password.input.value,
                        confirmPassword: confirmPassword.input.value,
                        company: companyInput.value,
                        product: productInput.value,
                        email: emailInput.value
                    };
                    sessionStorage.setItem('registerFormData', JSON.stringify(formData));
                };

                // 为所有输入字段添加事件监听
                const inputs = [
                    username.input, 
                    password.input, 
                    confirmPassword.input,
                    companyInput,
                    productInput,
                    emailInput
                ];

                inputs.forEach(input => {
                    input.addEventListener('input', saveFormData);
                    input.addEventListener('change', saveFormData);
                });

            }

            // 按钮容器
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'auth-button-group';

            // 确认按钮
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'auth-confirm-btn';
            confirmBtn.textContent = lang === 'cn' ? '确认' : 'Confirm';

            username.input.addEventListener('keypress', handleKeyPress);
            password.input.addEventListener('keypress', handleKeyPress);
            if (confirmPassword) confirmPassword.input.addEventListener('keypress', handleKeyPress);

            // 确认按钮逻辑
            confirmBtn.onclick = () => {
                const usernameVal = username.input.value.trim();
                const passwordVal = password.input.value.trim();
                const companyVal = companyInput?.value.trim() || '';
                const productVal = productInput?.value.trim() || '';
                const emailVal = emailInput?.value.trim() || '';
                const confirmVal = confirmPassword ? confirmPassword.input.value.trim() : null;

                // 基础邮箱格式验证
                if (type === 'register' && emailVal) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(emailVal)) {
                        alert(lang === 'cn' 
                            ? '请输入有效邮箱地址' 
                            : 'Please enter a valid email address');
                        return;
                    }
                }

                // 验证逻辑
                if (!usernameVal || !passwordVal) {
                    alert(lang === 'cn' ? '用户名和密码不能为空！' : 'Username and password are required!');
                    return;
                }

                if (type === 'register' && passwordVal !== confirmVal) {
                    alert(lang === 'cn' ? '两次输入的密码不一致！' : 'Passwords do not match!');
                    return;
                }

                // fetch请求
                let url = '';
                let bodyData = {};
                if (type === 'register') {
                    url = 'http://172.29.57.206:5000/register';
                    bodyData = {
                        username: usernameVal,
                        password: passwordVal,
                        company: companyVal,
                        product: productVal,
                        email: emailVal
                    };
                } else if (type === 'login') {
                    url = 'http://172.29.57.206:5000/login';
                    bodyData = {
                        username: usernameVal,
                        password: passwordVal
                    };
                }
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.getCSRFToken()
                    },
                    body: JSON.stringify(bodyData),
                    credentials: 'include'
                })

                .then(response => {
                    console.log('[DEBUG] 完整响应头:', [...response.headers.entries()]);
                    console.log('Access-Control-Allow-Origin:', response.headers.get('Access-Control-Allow-Origin'));
                    console.log('Access-Control-Allow-Credentials:', response.headers.get('Access-Control-Allow-Credentials'));
                    console.log('登录响应 Cookies:', response.headers.get('Set-Cookie'));
                    return response.json();
                })
                .then(async (data) => {
                    // 成功处理逻辑
                    if (data.success) {
                        sessionStorage.removeItem('registerFormData'); //注册成功时清除数据
                        console.log('initAuthDialogs 登录成功，当前 Cookies:', document.cookie);
                        console.log('initAuthDialogs CSRF Token:', window.getCSRFToken());

                        localStorage.setItem('auth_session', JSON.stringify({
                            username: data.username, 
                            expires: Date.now() + 3600000
                        }));

                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('username', usernameVal);
                        
                        document.getElementById('auth-buttons').style.display = 'none';
                        document.getElementById('user-info').style.display = 'flex';
                        document.getElementById('username-display').textContent = localStorage.getItem('username') || '';
                        document.body.removeChild(dialog);

                        Swal.fire({
                            icon: 'success',
                            title: lang === 'cn' ? '登录成功' : 'Logged In',
                            showConfirmButton: false,
                            timer: 500
                        });
                    } else {
                        document.body.removeChild(dialog);
                        window.syncLoginState();
                        Swal.fire({
                            icon: 'fail',
                            title: lang === 'cn' ? '登录失败' : 'Logged In Fail',
                            showConfirmButton: false,
                            timer: 500
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(lang === 'cn' ? '网络错误' : 'Network error');
                });
            };

            // 取消按钮
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'auth-cancel-btn';
            cancelBtn.textContent = lang === 'cn' ? '取消' : 'Cancel';
            cancelBtn.onclick = () => document.body.removeChild(dialog);

            // 组装元素
            buttonContainer.appendChild(confirmBtn);
            buttonContainer.appendChild(cancelBtn);
            content.appendChild(buttonContainer);
            dialog.appendChild(content);
            document.body.appendChild(dialog);

            // 点击外部关闭
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) document.body.removeChild(dialog);
            });
        }

        // 事件绑定
        document.getElementById('register-button').addEventListener('click', () => createAuthDialog('register'));
        document.getElementById('login-button').addEventListener('click', () => createAuthDialog('login'));
    }

    // 注销功能
    async function handleLogout() {
        try {
            const lang = (window.location.pathname.includes('/zh_CN') || 
                        document.documentElement.lang === 'zh_CN') ? 'cn' : 'en';

            // 更新本地存储和UI
            //localStorage.removeItem('isLoggedIn');
            localStorage.setItem('isLoggedIn', 'false');
            localStorage.removeItem('username');

            // 强制刷新显示状态
            document.getElementById('auth-buttons').style.display = 'flex';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('username-display').textContent = localStorage.getItem('username') || '';

            const response = await fetch('http://172.29.57.206:5000/logout', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': window.getCSRFToken(),
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            await Swal.fire({
                icon: 'success',
                title: lang === 'cn' ? '登出成功' : 'Logged Out',
                timer: 1500
            });
        } catch (error) {
            console.error('登出流程异常:', error);
            Swal.fire({
                icon: 'error',
                title: lang === 'cn' ? '登出异常' : 'Logout Failed',
                text: lang === 'cn' ? '请尝试清除浏览器缓存' : 'Please clear browser cache'
            });
        }
    }

    // 同步登录状态
    window.syncLoginState = function() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        document.getElementById('auth-buttons').style.display = isLoggedIn ? 'none' : 'flex';
        document.getElementById('user-info').style.display = isLoggedIn ? 'flex' : 'none';
        if (isLoggedIn) {
            document.getElementById('username-display').textContent = localStorage.getItem('username') || '';
        } else {

        }
    }

</script>
    
    
<script>
    /* ====================== 嵌入式配置开始 ====================== */
    const embeddedConfig = {
        "freertos": {
            "name": "FreeRTOS",
            "languages": {
                "en": ["latest"],
                "cn": ["latest"]
            }
        },
        "linux": {
            "name": "Linux",
            "languages": {
                "en": ["latest"],
                "cn": ["latest"]
            }
        }
    };
    /* ====================== 嵌入式配置结束 ====================== */
</script>

<script>
    // 获取OS显示名称列表
    function getOSNames(data) {
        return Object.keys(data).map(key => data[key].name);
    }

    // 获取指定OS的语言列表
    function getLanguages(data, osKey) {
        return Object.keys(data[osKey]?.languages || {});
    }

    // 获取指定OS和语言的版本列表
    function getVersions(data, osKey, language) {
        return data[osKey]?.languages?.[language] || ['latest'];
    }

    // 根据显示名称查找OS键
    function findOSKey(data, displayName) {
        return Object.keys(data).find(key => data[key].name === displayName);
    }

    // 获取基础URL路径
    function getBaseURL() {
        const url = new URL(window.location.href);
        console.log('[DEBUG] getBaseURL:');

        if (url.protocol === 'file:') {
            // 本地路径处理
            const pathParts = url.pathname.split('/').filter(part => part !== '');
            const index = pathParts.indexOf('build');
            console.log('[DEBUG] getBaseURL0:', pathParts.slice(0, index + 1).join('/'));
            return `file://${pathParts.slice(0, index + 1).join('/')}/`;
        } else {
            // 网络路径处理
            const basePath = url.pathname.split('/')[1]; // 直接取第一个有效路径段
            console.log('[DEBUG] getBaseURL:', url.origin, basePath);
            return `${url.origin}/${basePath}/`;
        }
    }

    // 获取当前URL路径分段
    function getCurrentSegments() {
        const url = new URL(window.location.href);
        let segments = url.pathname.split('/').filter(segment => segment);


        console.log('[DEBUG] getCurrentSegments:');

        if (url.protocol === 'file:') {
            // 本地路径处理
            const index = segments.indexOf('build');
            segments = segments.slice(index + 1); // 去掉 build 及之前的路径
            console.log('[DEBUG] getCurrentSegments0:', segments);
        } else {
            // 网络路径处理
            segments = segments.slice(1); // 去掉 ameba-iot-docs/
            console.log('[DEBUG] getCurrentSegments:', segments);
        }

        return {
            osKey: segments[0] || 'freertos', // 默认为 freertos
            language: segments[1] || 'en',   // 默认为 en
            version: segments[2] || 'latest' // 默认为 latest
        };
    }

    // 绑定事件监听
    function bindEvents(baseURL, segments) {
        document.getElementById('os-selector').addEventListener('change', () => {
            const newOSKey = document.getElementById('os-selector').value;
            const availableLangs = getLanguages(embeddedConfig, newOSKey);
            const defaultLang = availableLangs[0] || 'en';
            const defaultVersion = getVersions(embeddedConfig, newOSKey, defaultLang)[0] || 'latest';
            console.log('OS Changed:', {newOSKey, defaultLang, defaultVersion});
            redirectTo(`${baseURL}${newOSKey}/${defaultLang}/${defaultVersion}/`);
        });

        document.getElementById('language-selector').addEventListener('change', () => {
            const newLang = document.getElementById('language-selector').value;
            const defaultVersion = getVersions(embeddedConfig, segments.osKey, newLang)[0] || 'latest';
            console.log('Language Changed:', {newLang, defaultVersion});
            redirectTo(`${baseURL}${segments.osKey}/${newLang}/${defaultVersion}/`);
        });

        document.getElementById('version-selector').addEventListener('change', () => {
            const newVer = document.getElementById('version-selector').value;
            console.log('Version Changed:', {newVer});
            redirectTo(`${baseURL}${segments.osKey}/${segments.language}/${newVer}/`);
        });
    }

    // 跳转函数
    function redirectTo(path) {
        const url = new URL(path, window.location.href);
        if (url.protocol === 'file:') {
            url.pathname += 'index.html';
        }
        console.log('Redirecting to:', url.href);
        window.location.href = url.href;
    }
</script>

<script>
    // 验证并修正路径参数
    function validateSegments(segments) {
        const currentOSName = embeddedConfig[segments.osKey]?.name;

        // 如果 OS 无效，默认设置为 FreeRTOS
        if (!currentOSName) {
            console.warn("Invalid OS key, defaulting to FreeRTOS");
            segments.osKey = 'freertos';
        }

        // 如果语言无效，默认设置为 en
        if (!getLanguages(embeddedConfig, segments.osKey).includes(segments.language)) {
            console.warn("Invalid language, defaulting to en");
            segments.language = 'en';
        }

        return segments;
    }

    // 生成选择器HTML
    function generateSelectorsHTML(segments) {
        return `
        ${generateUserPanelHTML(segments)}`;
    }

    // 生成用户面板HTML
    function generateUserPanelHTML(segments) {
        return `
            <div class="user-panel">
                <div class="selectors-grid">
                    <!-- 系统选择器 -->
                    <div class="selector-group">
                        <select id="os-selector" class="selector-dropdown">
                            ${Object.keys(embeddedConfig).map(key => `
                                <option value="${key}">${embeddedConfig[key].name}</option>
                            `).join('')}
                        </select>
                    </div>

                    <!-- 语言选择器 -->
                    <div class="selector-group">
                        <select id="language-selector" class="selector-dropdown">
                            ${getLanguages(embeddedConfig, segments.osKey).map(lang => `
                                <option value="${lang}">${lang === 'en' ? 'en' : 'cn'}</option>
                            `).join('')}
                        </select>
                    </div>

                    <!-- 版本选择器 -->
                    <div class="selector-group">
                        <select id="version-selector" class="selector-dropdown">
                            ${getVersions(embeddedConfig, segments.osKey, segments.language).map(ver => `
                                <option value="${ver}">${ver}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>

                
                    <!-- 分隔线 -->
                    <div class="panel-divider"></div>

                    <!-- 用户名显示（登录后可见） -->
                    <div id="user-info" style="display: ${localStorage.getItem('isLoggedIn') ? 'flex' : 'none'}">
                        <button class="username-btn")">
                            <span class="btn-icon">👤</span>
                            <span id="username-display">${localStorage.getItem('username') || ''}</span>
                        </button>
                        <button class="logout-btn" onclick="handleLogout()")">
                            <span class="btn-icon">🚪</span>
                            <span id="btn-text">${segments.language === 'cn' ? '注销' : 'Logout'}</span>
                        </button>
                    </div>

                    <!-- 登录注册按钮（未登录时可见） -->
                    <div id="auth-buttons" class="button-row" style="display: ${localStorage.getItem('isLoggedIn') ? 'none' : 'flex'}">
                        <button class="auth-btn" id="login-button">
                            <span class="btn-icon">🔓</span> <!-- 登录图标 -->
                            ${segments.language === 'cn' ? '登录' : 'Login'}
                        </button>
                        <button class="auth-btn" id="register-button">
                            <span class="btn-icon">✍️</span> <!-- 注册图标 -->
                            ${segments.language === 'cn' ? '注册' : 'Register'}
                        </button>
                    </div>

                    <!-- 分隔线 -->
                    <div class="panel-divider"></div>

                    <!-- 外链按钮 -->
                    <div class="external-links">
                        <button class="link-btn official" onclick="window.open('https://www.realmcu.com/', '_blank')">
                            <span class="btn-icon">🌐</span>
                            <span class="btn-text">${segments.language === 'cn' ? '官网' : 'Official'}</span>
                        </button>
                        <button class="link-btn forum" onclick="window.open('http://172.29.57.206:5000/forum', '_blank')">
                            <span class="btn-icon">💬</span>
                            <span class="btn-text">${segments.language === 'cn' ? '论坛' : 'Forum'}</span>
                        </button>
                    </div>
                
            </div>`;
    }

    // 设置初始选中值
    function setInitialValues(segments) {
        document.getElementById('os-selector').value = segments.osKey;
        document.getElementById('language-selector').value = segments.language;

        const versionSelector = document.getElementById('version-selector');
        const availableVersions = getVersions(embeddedConfig, segments.osKey, segments.language);
        versionSelector.value = availableVersions.includes(segments.version) ? segments.version : availableVersions[0] || 'latest';
    }
</script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
    

          
          
          <a href="../../index.html" class="icon icon-home">
            Ameba IoT Docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

    
    <div id="topleft-panel" style="display: block !important; padding: 0; background: none; border: none;"></div>

    
    <div class="bottomleft-panel"><div class="userpanel-container"></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const segments = validateSegments(getCurrentSegments());
                const baseURL = getBaseURL();

                // 渲染HTML
                document.getElementById('topleft-panel').innerHTML = generateSelectorsHTML(segments);

                // 设置初始值
                setInitialValues(segments);

                // 绑定事件
                bindEvents(baseURL, segments);

                // 初始化认证逻辑
                
                    window.initAuthDialogs();
                    window.syncLoginState();
                

                // 将 user-panel 移动到 bottomleft-panel 内
                const userPanel = document.querySelector('.user-panel');
                const settingsContainer = document.querySelector('.userpanel-container');
                if (userPanel && settingsContainer) {
                    settingsContainer.appendChild(userPanel); // 直接添加为子元素
                }
            } catch (error) {
                console.error("Error initializing selectors:", error);
            }
        });
    </script>

        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../0_ameba_product/0_ameba_product_center_index_cn.html">产品中心</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_ameba_sdk/0_ameba_sdks_index_cn.html">Ameba SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_ameba_solutions/0_ameba_solutions_index_cn.html">解决方案</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_gcc_build_environment/0_gcc_build_index_cn.html">0.1 GCC 编译环境</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_gdb_debug/0_gdb_debug_index_cn.html">0.2 GDB 调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_build_system/0_build_system_index_cn.html">0.3 构建系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_sdk_example/0_sdk_example_index_cn.html">0.4 SDK 示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_memory_layout/0_layout_index_cn.html">0.5 Flash 和 RAM 布局</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_user_config/0_usrcfg_index_cn.html">0.6 开发者配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_tools/0_tools_index_cn.html">0.7 工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_at_command/0_at_command_index_cn.html">0.8 AT 命令集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_file_system/0_vfs_index_cn.html">0.9 虚拟文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_ftl/0_ftl_index_cn.html">0.a Flash 转换层</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_mpu_cache/0_mpu_cache_index_cn.html">1.0 内存保护单元和缓存</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_boot_process/0_boot_index_cn.html">1.1 启动过程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_ota/0_ota_index_cn.html">1.2 固件升级（OTA）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_otpc/0_otpc_index_cn.html">1.3 OTP存储器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_chipen/0_chipen_index_cn.html">1.4 芯片使能</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_ipc/0_ipc_index_cn.html">1.5 核间通信</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_pinmux/0_pinmux_index_cn.html">1.6 引脚复用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_gpio/0_gpio_index_cn.html">1.7 GPIO 和引脚控制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_power_save/0_ps_index_cn.html">1.9 低功耗开发</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_wifi_basic/0_wifi_basic_index_cn.html">2.0 Wi-Fi基础模式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_whc_wifi_bridge/0_wifi_bridge_index_cn.html">2.1 WHC Bridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_whc_fullmac/0_fullmac_index_cn.html">2.2 WHC FullMAC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_wifi_tunnel/0_wifi_tunnel_index_cn.html">2.3 Wi-Fi R-Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_wifi_csi/0_wifi_csi_index_cn.html">2.4 Wi-Fi CSI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_wifi_adaptivity_test/0_wifi_adaptivity_index_cn.html">2.5 Wi-Fi Adaptivity 测试指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10_api_docs/0_api_index_cn.html">2.6 Wi-Fi API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_security/0_security_index_cn.html">3.1 安全与加密</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_trng/0_trng_index_cn.html">3.2 真随机数发生器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_nda_huk_derivation/0_huk_derivation_index_nda.html">3.3 HUK 生成 🔒</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_nda_rdp/0_rdp_index_nda_cn.html">3.4 RDP 🔒</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_nda_rsip/0_rsip_index_nda_cn.html">3.5 RSIP 🔒</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_nda_secure_boot/0_secure_boot_index_nda.html">3.6 安全启动 🔒</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_nda_swd_protection/0_swd_protection_index_nda.html">3.7 SWD 保护 🔒</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_nda_tfm/0_tfm_index_nda_cn.html">3.8 可信任固件(TF-M) 🔒</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_crypto_engine/0_crypto_engine_index_cn.html">3.9 对称硬件加密引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_ecdsa_engine/0_ecdsa_index_cn.html">3.a ECDSA 硬件加密引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_eddsa_engine/0_eddsa_index_cn.html">3.b EDDSA 硬件加密引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_rsa_engine/0_rsa_index_cn.html">3.c RSA 硬件加密引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_ap_trustzone/0_ap_tz_index_cn.html">3.d AP 安全服务</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_ai/0_ai_index_cn.html">4.1 人工智能</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_ai_voice/0_ai_voice_index_cn.html">4.2 语音识别</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_multimedia/0_multimedia_index_cn.html">4.3 多媒体</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="0_dsp_index_cn.html">4.4 DSP 使用指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dsp_build_environment_cn.html">DSP 编译环境</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">DSP 配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#calling-conventions">Calling Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#switching-between-call0-and-windowed-register-abi">Switching between Call0 and Windowed Register ABI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#placing-libs-according-to-calling-conventions">Placing Libs According to Calling Conventions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-environment-variable-to-avoid-changing-search-path">Using Environment Variable to Avoid Changing Search Path</a></li>
<li class="toctree-l4"><a class="reference internal" href="#libs-provided-by-realtek">Libs Provided by Realtek</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#layout-of-dsp">Layout of DSP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#default-layout-of-dsp">Default Layout of DSP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#placing-codes-data-into-sram">Placing Codes/Data into SRAM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#changing-default-layout-of-lsp">Changing Default Layout of LSP</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#other-precautions">Other Precautions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#idma">iDMA</a></li>
<li class="toctree-l4"><a class="reference internal" href="#freertos-systick">FreeRTOS Systick</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cacheline">Cacheline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mpu-entry">MPU Entry</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../6_mass_production/0_mp_index_cn.html">6.1 批量生产</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6_mptools/0_mptools_index_cn.html">6.2 产测工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_usb/0_usb_index_cn.html">7.1 USB 主机与设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_dmac/0_dmac_index_cn.html">8.1 DMA 控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_psram/0_psram_index_cn.html">8.2 PSRAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_thermal/0_thermal_index_cn.html">8.3 温度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_adc/0_adc_index_cn.html">8.4 模数转换器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_ir/0_ir_index_cn.html">8.5 红外收发器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_ledc/0_ledc_index_cn.html">8.6 LED 控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_cap_touch/0_cap_touch_index_cn.html">8.7 Cap-Touch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_key_scan/0_key_scan_index_cn.html">8.8 Key-Scan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_rtc_io/0_rtc_io_index_cn.html">8.9 RTC-IO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_lcdc/0_lcdc_index_cn.html">8.a LCD 控制器</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ameba IoT Docs</a>
      </nav>

      <div class="wy-nav-content">
    
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="0_dsp_index_cn.html">数字信号处理（DSP）</a></li>
      <li class="breadcrumb-item active">DSP 配置</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dsp">
<span id="dsp-configuration"></span><h1>DSP 配置<a class="headerlink" href="#dsp" title="Link to this heading"></a></h1>
<section id="calling-conventions">
<h2>Calling Conventions<a class="headerlink" href="#calling-conventions" title="Link to this heading"></a></h2>
<p>Xtensa supports two different application binary interfaces (ABI), Windowed register ABI and Call0 ABI, which also include the calling conventions.</p>
<p>A windowed function call and return can only be within the same 1GB aligned region. That is to say, all of the functions must reside in exactly one of the following 4 regions of the 4GB memory space. However, a Call0 function call and return can be within the whole 4GB region. The address range of SRAM is from 0x2000_0000 to 0x2008_0000, and the address range of PSRAM starts from 0x6000_0000 (end address depends on the type of PSRAM). The ranges of SRAM and PSRAM are not in the same 1GB region, so it is impossible to call a function residing in SRAM from a function residing in PSRAM with a windowed register ABI.</p>
</section>
<section id="switching-between-call0-and-windowed-register-abi">
<h2>Switching between Call0 and Windowed Register ABI<a class="headerlink" href="#switching-between-call0-and-windowed-register-abi" title="Link to this heading"></a></h2>
<p>Each configuration is either compatible with Call0 ABI or windowed register ABI. <em>HIFI5_PROD_1123_asic_UPG</em> is compatible with Call0 ABI; <em>HIFI5_PROD_1123_asic_wUPG</em> is compatible with windowed register ABI.</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Configuration name</p></th>
<th class="head"><p>ABI type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>HIFI5_PROD_1123_asic_UPG</p></td>
<td><p>Call0 ABI</p></td>
</tr>
<tr class="row-odd"><td><p>HIFI5_PROD_1123_asic_wUPG</p></td>
<td><p>Windowed Register ABI</p></td>
</tr>
</tbody>
</table>
<p>If Xplorer is used to manage the project, you just need to change the configuration to choose the ABI you use. Be careful, the pre-built libs should be compiled according to the ABI you choose. Here is the configuration chosen for a Call0 ABI:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_chosen_for_call0_abi.png"><img alt="../../_images/dspcfg_chosen_for_call0_abi.png" src="../../_images/dspcfg_chosen_for_call0_abi.png" style="width: 970.4000000000001px; height: 75.2px;" /></a>
</figure>
<p>Here is the configuration chosen for a Windowed register ABI:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_chosen_for_windowed_register_abi.png"><img alt="../../_images/dspcfg_chosen_for_windowed_register_abi.png" src="../../_images/dspcfg_chosen_for_windowed_register_abi.png" style="width: 969.6px; height: 76.0px;" /></a>
</figure>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>If your project uses some libs provided by yourself, please re-compile the project according to the ABI you choose.</p></li>
<li><p>If use CMD line (<code class="file docutils literal notranslate"><span class="pre">auto_build.sh</span></code>) to build the project, the configuration file for the automatic compilation script is <code class="file docutils literal notranslate"><span class="pre">project/auto_build</span> <span class="pre">/dsp_batch.xml</span></code> (HIFI5_PROD_1123_asic_wUPG or HIFI5_PROD_1123_asic_UPG).</p></li>
</ul>
</div>
</section>
<section id="placing-libs-according-to-calling-conventions">
<h2>Placing Libs According to Calling Conventions<a class="headerlink" href="#placing-libs-according-to-calling-conventions" title="Link to this heading"></a></h2>
<section id="using-environment-variable-to-avoid-changing-search-path">
<h3>Using Environment Variable to Avoid Changing Search Path<a class="headerlink" href="#using-environment-variable-to-avoid-changing-search-path" title="Link to this heading"></a></h3>
<p>It will be tedious to change the location of lib search path when switching between two ABIs. You can create two folders named <em>HIFI5_PROD_1123_asic_UPG</em> and <em>HIFI5_PROD_1123_asic_wUPG</em> under the path you used to store libs, and place libs compiled with different ABIs into these two folders.</p>
<p>For example, if we used to place libs in <code class="docutils literal notranslate"><span class="pre">lib/audio/prebuilts</span></code>:</p>
<ol class="arabic">
<li><p>Create two folders under the path <code class="docutils literal notranslate"><span class="pre">/lib/audio/prebuilts/HIFI5_PROD_1123_asic_UPG</span></code> and <code class="docutils literal notranslate"><span class="pre">/lib/audio/prebuilts/HIFI5_PROD_1123_asic_wUPG</span></code>.</p></li>
<li><p>Change the <em>Library Search Paths</em> to <code class="docutils literal notranslate"><span class="pre">${workspace_loc}/.../lib/audio/prebuilts/$(TARGET_CONFIG)</span></code>. Environment variable <em>$(TARGET_CONFIG)</em> changes as configuration changes, which assures the right place to find prebuilt libs.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_library_search_path.png"><img alt="../../_images/dspcfg_library_search_path.png" src="../../_images/dspcfg_library_search_path.png" style="width: 1072.8px; height: 338.40000000000003px;" /></a>
</figure>
</li>
</ol>
</section>
<section id="libs-provided-by-realtek">
<h3>Libs Provided by Realtek<a class="headerlink" href="#libs-provided-by-realtek" title="Link to this heading"></a></h3>
<section id="libaudio-base-a-and-librpc-hal-a">
<h4>libaudio_base.a and librpc_hal.a<a class="headerlink" href="#libaudio-base-a-and-librpc-hal-a" title="Link to this heading"></a></h4>
<p>Two libs of different flavors are stored under <code class="docutils literal notranslate"><span class="pre">dsp/lib/audio/prebuilts/$(TARGET_CONFIG)</span></code>.</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">libaudio_base.a</span></code> is a RPC framework to synchronize data and signal between MCU and DSP.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">librpc_hal.a</span></code> is a hardware layer to adapt to different RPC platform.</p></li>
</ul>
</section>
<section id="libxa-nnlib-a-and-libhifi5-dsp-a">
<h4>libxa_nnlib.a and libhifi5_dsp.a<a class="headerlink" href="#libxa-nnlib-a-and-libhifi5-dsp-a" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">libxa_nnlib.a</span></code> can be found under <code class="docutils literal notranslate"><span class="pre">dsp/lib/xa_nnlib/v1.7.0/bin/$(TARGET_CONFIG)/Release</span></code>. It is the HiFi 5 Neural Network Library.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">libhifi5_dsp.a</span></code> can be found under <code class="docutils literal notranslate"><span class="pre">dsp/lib/lib_hifi5/project/hifi5_library/bin/$(TARGET_CONFIG)/Release</span></code>. It is the NatureDSP Signal for HiFi 5 DSP.</p></li>
</ul>
</section>
</section>
</section>
<section id="layout-of-dsp">
<h2>Layout of DSP<a class="headerlink" href="#layout-of-dsp" title="Link to this heading"></a></h2>
<section id="default-layout-of-dsp">
<h3>Default Layout of DSP<a class="headerlink" href="#default-layout-of-dsp" title="Link to this heading"></a></h3>
<p>We use a linker support package (LSP) to describe the layout of DSP. A LSP specifies object files to pull into an executable using a specific memory map, and is used as a convenient short-hand for telling the linker what it needs for a particular target environment. Refer to <em>Xtensa Linker Support Packages (LSPs) Reference Manual</em> (<code class="file docutils literal notranslate"><span class="pre">dspdoclsp_rm.pdf</span></code>) for more information.</p>
<p>Here is the sketch of the default layout:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_sketch_of_default_dsp_layout.svg"><img alt="../../_images/dspcfg_sketch_of_default_dsp_layout.svg" height="405" src="../../_images/dspcfg_sketch_of_default_dsp_layout.svg" width="262" /></a>
</figure>
<p>Here is the LSP seen from Xplorer:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_lsp_seen_from_xplorer.png"><img alt="../../_images/dspcfg_lsp_seen_from_xplorer.png" src="../../_images/dspcfg_lsp_seen_from_xplorer.png" style="width: 1001.6999999999999px; height: 399.7px;" /></a>
</figure>
<p>DSP can use sram_dsp, entry_table and extra_reset_mem for system memory, and DRAM 0/1 for local memory. Reset vector address will be placed in entry_table. DRAM 0/1 can only be used to store data.</p>
<ul class="simple">
<li><p>For Call0 ABI, code AND data can be stored in sram_dsp and extra_reset_mem.</p></li>
<li><p>For Window ABI: code can only be stored in extra_reset_mem, data can be stored in sram_dsp and extra_reset_mem.</p></li>
</ul>
</section>
<section id="placing-codes-data-into-sram">
<h3>Placing Codes/Data into SRAM<a class="headerlink" href="#placing-codes-data-into-sram" title="Link to this heading"></a></h3>
<p>There is a segment called <em>sram_dsp</em> in the default LSP: RTK_LSP. Putting codes or data into this area may have an effect on the performance of the whole project.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_sram_dsp_in_default_lsp.png"><img alt="../../_images/dspcfg_sram_dsp_in_default_lsp.png" src="../../_images/dspcfg_sram_dsp_in_default_lsp.png" style="width: 951.3000000000001px; height: 308.7px;" /></a>
</figure>
<section id="using-c-language-extensions">
<h4>Using C Language Extensions<a class="headerlink" href="#using-c-language-extensions" title="Link to this heading"></a></h4>
<ul>
<li><p>If the function to be placed into SRAM is:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">place_into_sram</span><span class="p">();</span>
</pre></div>
</div>
<p>You should do this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">place_into_sram</span><span class="p">()</span><span class="n">__attribute__</span><span class="w"> </span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&quot;.sram_dsp.text&quot;</span><span class="p">)));</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">place_into_sram</span><span class="p">(){</span>
<span class="w">  </span><span class="c1">//detailed implentation</span>
<span class="w">   </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>If you need to put an array into SRAM, you can do like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">__attribute__</span><span class="w"> </span><span class="p">((</span><span class="n">section</span><span class="p">(</span><span class="s">&quot;.sram_dsp.data&quot;</span><span class="p">)))</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">array_in_psram</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="compiler-flags-to-rename-sections">
<h4>Compiler Flags to Rename Sections<a class="headerlink" href="#compiler-flags-to-rename-sections" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>If all functions in <code class="file docutils literal notranslate"><span class="pre">ameba_clk_rom.c</span></code> needs to be placed in SRAM, right click on this file, and choose <code class="docutils literal notranslate"><span class="pre">Build</span> <span class="pre">Properties</span></code>. And in the new window, set values to <em>No</em> for items in the box.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_project_explorer_of_project_dsp.png"><img alt="../../_images/dspcfg_project_explorer_of_project_dsp.png" src="../../_images/dspcfg_project_explorer_of_project_dsp.png" style="width: 479.0px; height: 212.0px;" /></a>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_set_create_separate_function_sections_no.png"><img alt="../../_images/dspcfg_set_create_separate_function_sections_no.png" src="../../_images/dspcfg_set_create_separate_function_sections_no.png" style="width: 877.0999999999999px; height: 406.7px;" /></a>
</figure>
</li>
<li><p>Switch to <span class="guilabel">Addl compiler</span> tab, add an option as follows:</p></li>
</ol>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_addl_compiler_tab.png"><img alt="../../_images/dspcfg_addl_compiler_tab.png" src="../../_images/dspcfg_addl_compiler_tab.png" style="width: 872.1999999999999px; height: 405.29999999999995px;" /></a>
</figure>
</section>
</section>
<section id="changing-default-layout-of-lsp">
<h3>Changing Default Layout of LSP<a class="headerlink" href="#changing-default-layout-of-lsp" title="Link to this heading"></a></h3>
<p>MCU and DSP share the PSRAM and SRAM, but DTCM is exclusive to DSP. When the layout of MCU changes, the LSP of DSP should change accordingly. For DSP memory layout, the memory addresses of DTCM and SRAM generally remain default, and only the start and end addresses of PSRAM need to be adjusted. We only need to use a python script to adjust the PSRAM space of the DSP, and then modify the MCU layout file accordingly according to the output of the script. The specific operation method is as follows:</p>
<ol class="arabic">
<li><p>Enter the directory: <code class="docutils literal notranslate"><span class="pre">{SDK}\project\img_utility</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="p">{</span><span class="n">SDK</span><span class="p">}</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">img_utility</span>
</pre></div>
</div>
<ul>
<li><p>With the command <code class="file docutils literal notranslate"><span class="pre">python</span> <span class="pre">lsp_modify.py</span></code>, you can get the current DSP PSRAM address from output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">python</span> <span class="n">lsp_modify</span><span class="o">.</span><span class="n">py</span>
<span class="n">Current</span> <span class="n">LSP</span> <span class="n">psram</span><span class="p">:</span> <span class="n">Start</span> <span class="n">Address</span><span class="p">:</span> <span class="mh">0x60300000</span><span class="p">,</span> <span class="n">End</span> <span class="n">Address</span><span class="p">:</span> <span class="mh">0x61000000</span><span class="p">,</span> <span class="n">Size</span><span class="p">:</span> <span class="mh">0xd00000</span>
<span class="n">Invalid</span> <span class="nb">input</span><span class="o">.</span> <span class="n">Please</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">end</span> <span class="n">addresses</span> <span class="ow">in</span> <span class="nb">hex</span><span class="o">.</span> <span class="n">Example</span><span class="p">:</span> <span class="s2">&quot;python lsp_modify.py 0x60300000 0x61000000&quot;</span>
<span class="n">DSP</span> <span class="n">link</span> <span class="n">script</span> <span class="n">change</span> <span class="n">FAIL</span><span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>With the command <code class="file docutils literal notranslate"><span class="pre">python</span> <span class="pre">lsp_modify.py</span> <span class="pre">&lt;start</span> <span class="pre">address</span> <span class="pre">in</span> <span class="pre">hex&gt;</span> <span class="pre">&lt;end</span> <span class="pre">address</span> <span class="pre">in</span> <span class="pre">hex&gt;</span></code>, you will get a new lsp:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">python</span> <span class="n">lsp_modify</span><span class="o">.</span><span class="n">py</span> <span class="mh">0x60400000</span> <span class="mh">0x60A00000</span>
<span class="n">Current</span> <span class="n">LSP</span> <span class="n">psram</span><span class="p">:</span> <span class="n">Start</span> <span class="n">Address</span><span class="p">:</span> <span class="mh">0x60300000</span><span class="p">,</span> <span class="n">End</span> <span class="n">Address</span><span class="p">:</span> <span class="mh">0x61000000</span><span class="p">,</span> <span class="n">Size</span><span class="p">:</span> <span class="mh">0xd00000</span>
<span class="n">New</span> <span class="n">LSP</span> <span class="n">psram</span><span class="p">:</span> <span class="n">Start</span> <span class="n">Address</span><span class="p">:</span> <span class="mh">0x60400000</span><span class="p">,</span> <span class="n">End</span> <span class="n">Address</span><span class="p">:</span> <span class="mh">0x60a00000</span><span class="p">,</span> <span class="n">Size</span><span class="p">:</span> <span class="mh">0x600000</span>
<span class="ne">Warning</span> <span class="p">:</span> <span class="s1">&#39;entry_table&#39;</span> <span class="n">start</span> <span class="n">address</span> <span class="ow">not</span> <span class="n">aligned</span> <span class="n">to</span> <span class="n">MPU</span> <span class="nb">min</span> <span class="n">alignment</span>
<span class="p">(</span><span class="ow">is</span> <span class="mh">0x60400020</span><span class="p">,</span> <span class="nb">min</span> <span class="n">alignment</span> <span class="ow">is</span> <span class="mh">0x00001000</span><span class="p">)</span>
<span class="ne">Warning</span> <span class="p">:</span> <span class="n">MPU</span> <span class="n">region</span> <span class="n">size</span> <span class="n">smaller</span> <span class="n">than</span> <span class="nb">min</span> <span class="n">region</span> <span class="n">size</span>
<span class="p">(</span><span class="mh">0x60400020</span> <span class="o">-</span> <span class="mh">0x60400040</span><span class="p">,</span> <span class="ow">is</span> <span class="mi">32</span> <span class="n">must</span> <span class="n">be</span> <span class="n">at</span> <span class="n">least</span> <span class="mi">4096</span> <span class="nb">bytes</span><span class="p">)</span>
<span class="ne">Warning</span> <span class="p">:</span> <span class="s1">&#39;unused&#39;</span> <span class="n">start</span> <span class="n">address</span> <span class="ow">not</span> <span class="n">aligned</span> <span class="n">to</span> <span class="n">MPU</span> <span class="nb">min</span> <span class="n">alignment</span>
<span class="p">(</span><span class="ow">is</span> <span class="mh">0x60400040</span><span class="p">,</span> <span class="nb">min</span> <span class="n">alignment</span> <span class="ow">is</span> <span class="mh">0x00001000</span><span class="p">)</span>
<span class="n">New</span> <span class="n">linker</span> <span class="n">scripts</span> <span class="n">generated</span> <span class="ow">in</span>
<span class="o">../../</span><span class="n">project</span><span class="o">/</span><span class="n">RTK_LSP</span><span class="o">/</span><span class="n">RI</span><span class="o">-</span><span class="mf">2021.8</span><span class="o">/</span><span class="n">HIFI5_PROD_1123_asic_UPG</span><span class="o">/</span><span class="n">RTK_LSP</span><span class="o">/</span><span class="n">ldscripts</span>
<span class="n">Change</span> <span class="n">MCU</span> <span class="n">layout</span> <span class="p">(</span><span class="n">amebalite_layout</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span> <span class="n">PSRAM_DSP_START</span> <span class="n">to</span> <span class="mh">0x60400000</span>
</pre></div>
</div>
</li>
</ul>
<p>In the example, we adjust the PSRAM start/end positions to 0x60400000/0x60A00000. Since the MPU table automatically generated by the script, the address alignment warning above can be ignored without any adverse effects.</p>
</li>
<li><p>Add <em>KEEP</em> in the link script <code class="file docutils literal notranslate"><span class="pre">RTK_LSPldscriptself32xtensa.x</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">ipc_table</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">_ipc_table_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ABSOLUTE</span><span class="p">(.);</span>
<span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">ipc_table</span><span class="p">))</span>
<span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">_ipc_table_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ABSOLUTE</span><span class="p">(.);</span>
<span class="p">}</span><span class="w"> </span><span class="o">&gt;</span><span class="n">psram0_seg</span><span class="w"> </span><span class="o">:</span><span class="n">psram0_phdr</span>
<span class="p">.</span><span class="n">command</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">_command_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ABSOLUTE</span><span class="p">(.);</span>
<span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">command</span><span class="p">))</span>
<span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">_command_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ABSOLUTE</span><span class="p">(.);</span>
<span class="p">}</span><span class="w"> </span><span class="o">&gt;</span><span class="n">psram0_seg</span><span class="w"> </span><span class="o">:</span><span class="n">psram0_phdr</span>
</pre></div>
</div>
</li>
<li><p>Change the layout file ({SDK}amebalite_gcc_projectamebalite_layout.ld ) according to the output of the script:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PSRAM_DSP_START        (0x60400000)</span>
</pre></div>
</div>
</li>
<li><p>Recompile the DSP and MCU projects.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">备注</p>
<ul class="simple">
<li><p>Before using the script, make sure the bin directory of Xtensa tool has been added to the system or user path. Otherwise the executable file cannot be found. This script needs python3.</p></li>
<li><p>If you changed other MPU properties, please synchronize previous modifications on the newly generated <code class="file docutils literal notranslate"><span class="pre">mpu_table.c</span></code>. And compile the new <code class="file docutils literal notranslate"><span class="pre">mpu_table.c</span></code> in the project.</p></li>
</ul>
</div>
</section>
</section>
<section id="other-precautions">
<h2>Other Precautions<a class="headerlink" href="#other-precautions" title="Link to this heading"></a></h2>
<section id="idma">
<h3>iDMA<a class="headerlink" href="#idma" title="Link to this heading"></a></h3>
<p>The iDMA can transfer data from PSRAM or SRAM to DTCM. DTCM is a fast data memory in which data can be fetched within one clock cycle. Therefore, using the iDMA to move large blocks of data into DTCM for calculation can often improve performance. However, the use of iDMA has the following restrictions:</p>
<section id="address-restrictions">
<h4>Address Restrictions<a class="headerlink" href="#address-restrictions" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>The iDMA can only move data between system memory (SRAM and PSRAM) and local memory (DRAM 0/1), or within local memory. Only transfers between system memories are not allowed.</p></li>
<li><p>Although the DTCM (DRAM) space is a continuous 256KB, our DTCM is actually composed of two DRAM memories (each with a size of 128K). The iDMA cannot transfer across DRAM boundary (boundary address: 0x1ffe0000), so if the transfer crosses the middle border, then iDMA address error IDMA_ERR_WRITE_ADDR will be reported. You can bypass this limitation by doing two moves. There is also no performance penalty for performing the transfer twice.</p></li>
</ul>
</section>
<section id="interrupt-registration-and-enable">
<h4>Interrupt Registration and Enable<a class="headerlink" href="#interrupt-registration-and-enable" title="Link to this heading"></a></h4>
<p>If you need to use iDMA interrupts, not only need to register and enable interrupts, but also add control descriptor <em>DESC_NOTIFY_W_INT</em> when adding start iDMA transfer task. Otherwise, the interrupt will not enter the corresponding handler.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">idma_register_interrupts</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">os_handler</span><span class="p">)</span><span class="n">done_handler</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="n">os_handler</span><span class="p">)</span><span class="n">error_handler</span><span class="p">);</span>
<span class="n">idma_copy_desc</span><span class="p">(</span><span class="n">dst_data</span><span class="p">,</span><span class="w"> </span><span class="n">src_data</span><span class="p">,</span><span class="w"> </span><span class="n">DATA_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">DESC_NOTIFY_W_INT</span><span class="p">);</span>
</pre></div>
</div>
<p>Refer to the iDMA example in our SDK and Xtensa docs <code class="file docutils literal notranslate"><span class="pre">sys_sw_rm.pdf</span></code>.</p>
</section>
</section>
<section id="freertos-systick">
<h3>FreeRTOS Systick<a class="headerlink" href="#freertos-systick" title="Link to this heading"></a></h3>
<p>The systick value obtained by calling xTaskGetTickCountFromISR in the interrupt handler is not accurate. This API interface is to obtain the systick value before the system enters WATI. The systick value will not be updated until the interrupt handler finishes executing. We do not recommend using the systick value directly.</p>
</section>
<section id="cacheline">
<h3>Cacheline<a class="headerlink" href="#cacheline" title="Link to this heading"></a></h3>
<p>In the <code class="file docutils literal notranslate"><span class="pre">dsp_wrapper.h</span></code> file, we wrap three D-Cache operation functions:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">DCache_Clean</span>
<span class="n">DCache_Invalidate</span>
<span class="n">DCache_CleanInvalidate</span>
</pre></div>
</div>
<p>When using DMA, be sure to pay attention to the operation of the cache:</p>
<ul class="simple">
<li><p>In DCache_Invalidate operation, if length is not an integer multiple of the cacheline (128 Bytes), it will invalidate the entire cacheline. This will cause data stored in the same cacheline to be lost.</p></li>
<li><p>In DCache_Clean operation, if DMA has refreshed the memory, executing DCache_Clean again will overwrite the old data in the cache to the memory, resulting in invalid DMA fetch.</p></li>
</ul>
</section>
<section id="mpu-entry">
<h3>MPU Entry<a class="headerlink" href="#mpu-entry" title="Link to this heading"></a></h3>
<p>If the user needs to make more detailed memory protection settings, he can add new MPU entries based on the default MPU table. The total available MPU entry number is 16. The default SDK configuration uses 7 entries. Note that the <code class="file docutils literal notranslate"><span class="pre">mpu_table.c</span></code> files in the RTK_LSP path and project_dsp path should be modified simultaneously.</p>
<p>An example of the modification method is as follows: For example, we need to reserve a memory area in the memory address (0x60700000 - 0x60800000) in PSRAM that DSP cannot access it:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_example_of_modification_method.png"><img alt="../../_images/dspcfg_example_of_modification_method.png" src="../../_images/dspcfg_example_of_modification_method.png" style="width: 777.6999999999999px; height: 546.6999999999999px;" /></a>
</figure>
<p>If the DSP accesses a protected address, the following crash log will be printed:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/dspcfg_crash_log_printed.png"><img alt="../../_images/dspcfg_crash_log_printed.png" src="../../_images/dspcfg_crash_log_printed.png" style="width: 731.5px; height: 567.0px;" /></a>
</figure>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="dsp_build_environment_cn.html" class="btn btn-neutral float-left" title="DSP 编译环境" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../6_mass_production/0_mp_index_cn.html" class="btn btn-neutral float-right" title="批量生产" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2025, Realsil。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>

    <!-- 侧边栏收缩按钮 -->
    <button id="sidebar-toggle-button">&lt;</button>

    <!-- 问题反馈按钮和对话框 -->
        
        <button id="report-button">
            <i class="fas fa-question-circle"></i> <!-- 问号图标 -->
        </button>
    

    <div id="feedback-dialog" class="feedback-dialog" style="display: none;">
        <div class="form-group">
            <label style="font-weight: bold;">Please select the related chapter:</label>
            <select id="chapter-select">
                <option value="">Select Chapter</option>
                <!-- 章节选项将通过JavaScript动态填充 -->
            </select>
        </div>

        <div class="form-group">
            <label style="font-weight: bold;">Post Type</label>
            <select id="post-type" class="form-control" required>
                <option value="">-- Select Type --</option>
                <option value="doc_correction">Document Correction</option>
                <option value="tech_consult">Technical Consult</option>
                <option value="tech_summary">Technical Summary</option>
                <option value="operation_flow">Operation Flow</option>
            </select>
        </div>

        <div class="form-group">
            <label style="font-weight: bold;">Related Paragraph:</label>
            <textarea
                id="paragraph-input"
                placeholder="{{ '你可以先选择有问题的段落或手动输入...' if language == 'zh_CN' else 'You can select text or type directly here...' }}"
                rows="4"
            ></textarea>
        </div>

        <div class="form-group">
            <label style="font-weight: bold;">Please describe your issue:</label>
            <textarea
                id="inquire_input"
                placeholder="Feature enhancement in progress, please stay tuned...">
            </textarea>
        </div>

        <button id="submit-feedback">Submit</button>
        <button id="cancel-feedback">Cancel</button>
    </div>

    <style>
        .form-group {
            margin: 5px 0;  /* 基础间距 */
        }

        /* 相邻表单项缩小上方间距 */
        .form-group + .form-group {
            margin-top: 10px;
        }

        /* 段落输入框底部微调 */
        #paragraph-input, #inquire_input {
            margin: 2px 0; /* 上下间距 */
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 100px;

            /* 占位符样式 */
            &::placeholder {
                color: #999;
                font-style: italic;
            }
        }
    </style>

      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
     

    <script>
        function sidebarToggleButton() {
            const sidebar = document.querySelector('.wy-nav-side');
            const contentArea = document.querySelector('.wy-nav-content');
            const contentAreaWrap = document.querySelector('.wy-nav-content-wrap');
            const bottomLeftPanel = document.querySelector('.bottomleft-panel');
            const toggleButton = document.getElementById('sidebar-toggle-button');

            console.log('Sidebar:', sidebar);
            console.log('Content Area:', contentArea);
            console.log('Toggle Button:', toggleButton);

            if (!sidebar || !contentArea || !toggleButton) {
                console.error('One or more elements not found');
                return;
            }

            let isSidebarCollapsed = false;

            toggleButton.addEventListener('click', function() {
                if (isSidebarCollapsed) {
                    sidebar.style.marginLeft = '0px';
                    bottomLeftPanel.style.marginLeft = '0px';
                    contentAreaWrap.style.marginLeft = '280px';
                    contentArea.classList.remove('expanded');

                    toggleButton.innerHTML = '&lt;';
                    toggleButton.style.left = '290px';
                } else {
                    sidebar.style.marginLeft = '-280px';
                    bottomLeftPanel.style.marginLeft = '-280px';
                    contentAreaWrap.style.marginLeft = '0px';
                    contentArea.classList.add('expanded');

                    toggleButton.innerHTML = '&gt;';
                    toggleButton.style.left = '15px';
                }
                isSidebarCollapsed = !isSidebarCollapsed;
            });
        }

        sidebarToggleButton();
    </script>


    
    <!-- source/_templates/layout_nda_access.html -->

<!-- 文档列表 -->
<style>
    #document-list {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 5px; /* 上下间隔 */
    }

    #document-list > div {
        display: flex;
        align-items: center;
        width: 100%;
    }

    #document-list label {
        margin: 0;
        text-align: left;
        display: inline-flex; /* 在同一行展示内容 */
        align-items: center; /* 垂直对齐 */
        gap: 8px; /* 确保无间隙 */
    }

    #document-list input {
        margin: 0;
    }

    /* 文档列表外框 */
    .input-frame {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 7px;
        margin-bottom: 10px;
        background: white;
    }

    /* 调整文档列表内部布局 */
    #document-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
    }

    #document-list label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px;
        transition: background 0.2s;
    }

    #document-list label:hover {
        background: #f8f9fa;
    }

</style>

<style>
    .nda_request_modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #5a6c75; /* 淡蓝色背景 */
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        width: 400px;
    }

    .nda_request_modal-content {
        position: relative;
    }

    .nda_request_modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        cursor: pointer;
        color: white !important;
        text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    }

    .nda_request_modal .form-group {
        margin: 10px 0;
    }

    .nda_request_modal label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }

    /* 标签文字颜色 */
    .nda_request_modal .form-group label {
        color: white !important; /* 白色文字 */
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); /* 增加可读性 */
    }

    .nda_request_modal input,
    .nda_request_modal textarea,
    .nda_request_modal select,
    .input-frame {
        width: 100%;
        padding: 7px;
        border-radius: 4px;
        margin-bottom: 10px;
        border: 2px solid white !important; /* 白色边框 */
        background: #25292b !important; /* 深蓝色背景 */
    }

    .nda_request_modal button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
    }

    .nda_request_modal button:hover {
        background-color: #0056b3;
    }

    /* 标题样式调整 */
    .nda_request_modal h4 {
        color: white !important; /* 白色文字 */
        text-align: center; /* 居中 */
        text-decoration: underline; /* 下划线 */
        margin: 0 0 20px 0; /* 调整间距 */
        padding: 15px 0 10px 0; /* 上间距加大 */
        background: #5a6c75; /* 淡蓝色背景 */
        border-radius: 4px 4px 0 0; /* 顶部圆角 */
        position: relative;
        top: -30px; /* 向上移动 */
        left: -30px;
        width: calc(100% + 60px); /* 扩展宽度 */
    }

    /* 统一输入元素样式 */
    .nda_request_modal input, 
    .nda_request_modal textarea,
    .input-frame {
        border: 2px solid white !important; /* 白色边框 */
        border-radius: 4px;
        transition: border-color 0.2s;
        color: white;
    }

    /* 加强输入框聚焦效果 */
    .nda_request_modal input:focus,
    .nda_request_modal textarea:focus,
    .input-frame:focus-within {
        border-color: #003366 !important;
        box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.25);
        outline: none;
    }

    .nda_request_modal,
    .nda_request_modal h4 {
        background: #5a6c75; /* 淡蓝色背景 */
    }

</style>



<script>
    var PROTECTED_PAGES = ["3_nda_swd_protection/0_swd_protection_index_nda", "3_nda_rdp/0_rdp_index_nda", "3_nda_rsip/0_rsip_index_nda_cn", "3_nda_tfm/0_tfm_index_nda_cn", "3_nda_secure_boot/0_secure_boot_index_nda", "3_nda_huk_derivation/0_huk_derivation_index_nda", "3_nda_rsip/0_rsip_index_nda", "3_nda_tfm/0_tfm_index_nda", "3_nda_rdp/0_rdp_index_nda_cn"];

    // 路由守卫配置
    const ROUTER_CONFIG = {
        baseUrl: 'http://172.29.57.206:5000',
        checkInterval: 30000 // 30秒检查一次
    };

    window.getStoredUsername = function() {
        try {
            const session = localStorage.getItem('auth_session');
            if (!session) return null;
            const { username, expires } = JSON.parse(session);
            if (Date.now() > expires) {
                localStorage.removeItem('auth_session');
                return null;
            }
            return username;
        } catch (e) {
            console.error('读取存储会话失败:', e);
            return null;
        }
    }

    // 增强型路由守卫
    function setupRouteGuard() {
        const originalPushState = history.pushState;
        const originalReplaceState = history.replaceState;
    
        function wrappedHistoryMethod(method) {
            return function(state, title, url) {
                if (url) {
                    const urlObj = new URL(url, window.location.origin);
                    checkNdaProtect(urlObj.pathname).then(allowed => {
                        if (allowed) {
                            method.apply(history, [state, title, url]);
                        }
                    });
                } else {
                    method.apply(history, [state, title, url]);
                }
            };
        }

        history.pushState = wrappedHistoryMethod(originalPushState);
        history.replaceState = wrappedHistoryMethod(originalReplaceState);

        window.addEventListener('popstate', () => {
            checkNdaProtect(window.location.pathname);
        });
    }

    // CSRF Token处理：获取CSRF令牌
    window.getCSRFToken = function() {
        // 从 Cookie 中获取 CSRF Token
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrf_token='))
            ?.split('=')[1];
        return cookieValue || '';
    }

    // 检测当前页面是否是nda文件
    function isProtectedPage(page_name) {
        return page_name.toLowerCase().includes('nda');
    }

    // 定义获取最后路径段的函数
    function getLastPathSegment(url) {
        const parts = url.split('/');
        return parts.pop() || parts.pop();  // 使用双 pop 处理可能的尾部斜线
    }

    // 显示服务不可用
    window.NdaPageAccessDenied = function() {
        document.querySelector('.wy-nav-content').innerHTML = `
            <div class="auth-denied service-unavailable">
                <h3>${document.documentElement.lang === 'zh_CN' ? '访问被拒绝' : 'Access Denied'}</h3>
                <p>${document.documentElement.lang === 'zh_CN' 
                    ? '你首先要注册用户，并通过页面下方的帮助按钮申请文档访问权限.' 
                    : 'You should first register as a user and then request document access permissions use the same register email.'}
                </p>
                <button id="request-access-btn">
                    ${document.documentElement.lang === 'zh_CN' ? '访问权限申请' : 'Request Access'}
                </button>
            </div>

            <!-- 模态框 -->
            <div id="access-request-modal" class="nda_request_modal" style="display:none;">
                <div class="nda_request_modal-content">
                    <span class="nda_request_modal-close">&times;</span>
                    <h4>${document.documentElement.lang === 'zh_CN' ? '申请访问权限' : 'Request Access Permission'}</h4>

                    <div class="form-group">
                        <label>${document.documentElement.lang === 'zh_CN' ? '文档选择' : 'Select Documents'}</label>
                        <!-- 新增外框容器 -->
                        <div class="input-frame">
                            <div id="document-list">
                                ${Array.from(PROTECTED_PAGES).map(page => {
                                    const lastSegment = page.substring(page.lastIndexOf('/') + 1);
                                    return `<div>
                                                <label for="${page}">
                                                    <input type="checkbox" value="${page}" id="${page}"> ${lastSegment}
                                                </label>
                                            </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>${document.documentElement.lang === 'zh_CN' ? '工作邮箱' : 'Work Email'}</label>
                        <input type="email" id="work-email" required>
                    </div>
                    <div class="form-group">
                        <label>${document.documentElement.lang === 'zh_CN' ? '工作单位' : 'Work Unit'}</label>
                        <input type="text" id="work-unit" required>
                    </div>
                    <div class="form-group">
                        <label>${document.documentElement.lang === 'zh_CN' ? '产品信息' : 'Product Information'}</label>
                        <textarea id="product-info"></textarea>
                    </div>
                    <div class="form-group">
                        <label>${document.documentElement.lang === 'zh_CN' ? '联系电话' : 'Contact Number'}</label>
                        <input type="tel" id="contact-number" required>
                    </div>
                    <button id="nda_access_request_button">
                        ${document.documentElement.lang === 'zh_CN' ? '提交申请' : 'Submit Request'}
                    </button>
                </div>
            </div>
        `;
    };

    // 统一验证逻辑
    function checkNdaProtect(path, isBackgroundCheck = false) {
        const page_name = getLastPathSegment(path);
        console.log('checkNdaProtect ', page_name);

        // 非NDA 则直接允许
        if (!isProtectedPage(page_name)) {
            console.log('checkNdaProtect normal page');

            return Promise.resolve(true);
        }

        const wyNavContent = document.querySelector('.wy-nav-content');
        let originalContent = wyNavContent.innerHTML; // 缓存原始内容

        // 豁免路径快速通过
        if (isExemptPath()) {
            console.log('checkNdaProtect Exempt path, bypass check');
            wyNavContent.style.display = 'block';
            return Promise.resolve(true);
        }

        // 显示加载状态
        wyNavContent.innerHTML = `
            <div class="auth-loading">
                <div class="spinner"></div>
                <p>${document.documentElement.lang === 'zh_CN' ? '权限验证中...' : 'Checking permissions...'}</p>
            </div>
        `;

        const page = new URL(path, window.location.origin).pathname.split('/').pop();
        console.log('checkNdaProtect 提取的页面名称:', page);

        return fetch('http://172.29.57.206:5000/check_nda_access', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.getCSRFToken()
            },
            body: JSON.stringify({
                path: page,
                username: window.getStoredUsername() || 'null' //  注意：后端从 session 取用户名，此处不需要传 username
            }),
            credentials: 'include'
        })

        .then(response => {
            // 关键：先检查状态码再解析 JSON
            if (!response.ok) {
                console.log('checkNdaProtect Access denied');
                NdaPageAccessDenied();
            }
            return response.json(); // 显式解析 JSON
        })
        .then(data => {
            console.log('checkNdaProtect data.access:', data.access);

            if (data.access) {
                console.log('checkNdaProtect Access granted');
                wyNavContent.innerHTML = originalContent; // 恢复原始内容
                document.querySelector('.wy-nav-content').style.display = 'block';
            } else {
                console.log('checkNdaProtect Access denied');
                NdaPageAccessDenied();
            }

            return data.access ?? false;
        })
        .catch(error => {
            console.error('checkNdaProtect 验证失败:', error);
            return false;
        });
    }

    function requestNdaAccessRight() {
        // 访问权限申请按钮点击事件
        document.body.addEventListener('click', function(event) {
            if (event.target.id === 'request-access-btn') {
                document.getElementById('access-request-modal').style.display = 'block';
            }
        });

        // 模态框关闭事件
        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('nda_request_modal-close')) {
                document.getElementById('access-request-modal').style.display = 'none';
            }
        });

        // 提交申请按钮点击事件
        document.body.addEventListener('click', function(event) {
            if (event.target.id === 'nda_access_request_button') {
                const documents = Array.from(document.querySelectorAll('#document-list input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
                const email = document.getElementById('work-email').value;
                const unit = document.getElementById('work-unit').value;
                const productInfo = document.getElementById('product-info').value;
                const contactNumber = document.getElementById('contact-number').value;

                if (!documents.length) {
                    alert('must select one page');
                    return;
                }

                // 数据验证和提交
                if (!email || !unit || !contactNumber) {
                    alert('Please fill in all required fields.');
                    return;
                }

                const ndaAaccessRequestData = {
                    username: window.getStoredUsername() || 'null',
                    documents: documents,
                    email: email,
                    unit: unit,               // 保持前端字段名不变
                    productInfo: productInfo, // 保持前端字段名不变 
                    contactNumber: contactNumber // 改为驼峰命名
                };

                console.log('Request Data:', ndaAaccessRequestData);

                // 发送请求到后端处理（替换为实际后端服务路径）
                fetch('/nda_access_request_submit', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.getCSRFToken()  // 添加CSRF令牌
                    },
                    body: JSON.stringify(ndaAaccessRequestData)
                })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'server response error');
                    }

                    console.log('Request successful:', data);
                    alert('Access request submitted successfully.');
                    document.getElementById('access-request-modal').style.display = 'none'; // 关闭模态框

                    return data;
                })
                .catch(error => {
                    console.error('Submit failed:', error);

                    // 构建详细错误信息
                    let errorMsg = `Submit failed: ${error.message}`;
                    if (error.message.includes('Missing required fields')) {
                        errorMsg += ', please check all required fields';
                    }

                    alert(errorMsg);
                    document.getElementById('access-request-modal').style.display = 'block'; // 保持表单数据
                });
            }
        });
    }
</script>
    

    <script>
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            
                checkNdaProtect(window.location.pathname);
                setupRouteGuard();
                requestNdaAccessRight();
            
        });


    </script>




    


</body>
</html>