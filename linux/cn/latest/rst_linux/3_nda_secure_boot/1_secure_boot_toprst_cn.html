

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; Ameba IoT Docs  文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom_cn.css?v=0d22fac7" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="../../_static/_static/custom_cn.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=7d86a446"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/toggleprompt.js?v=d7ede5d2"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script src="../../_static/translations.js?v=beaddf03"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="USB BOOT" href="../7_usb_boot/0_usb_boot_index_cn.html" />
    <link rel="prev" title="Secure Boot" href="0_secure_boot_index_nda_cn.html" />
   
  
  <script type="text/javascript" src="../../_static/js/selector.js"></script>

  <style>
    .wy-nav-content {max-width: 1000px;} /* 设置最大宽度 */
  </style>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Ameba IoT Docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_ameba_product/0_ameba_product_center_index_cn.html">产品中心</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_ameba_sdk/0_ameba_sdks_index_cn.html">Ameba SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_release_packages/0_release_packages_index_cn.html">0.0 释放包</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_gcc_build_environment/0_gcc_build_index_cn.html">0.1 GCC 编译环境</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_sdk_architecture/0_sdk_architecture_index_cn.html">0.2 SDK 架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_tools/0_tools_index_cn.html">0.7 工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_question_help/0_question_help_index_cn.html">0.A 问题与帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_debugging/0_debugging_index_cn.html">0.B 系统调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_boot_process/0_boot_index_cn.html">1.1 启动流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_ota/0_ota_index_cn.html">1.2 固件在线升级（OTA）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_otpc/0_otpc_index_cn.html">1.3 OTP 存储器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_flash/0_flash_index_cn.html">1.4 闪存</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_gpio/0_gpio_index_cn.html">1.7 通用输入输出端口</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_power_save/0_ps_index_cn.html">1.8 电源管理</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="0_secure_boot_index_nda_cn.html">3.6 安全启动</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#secure-boot-from-rom-code">Secure Boot from ROM Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linux-secure-boot-flow">Linux Secure Boot Flow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-use-secure-boot">How to Use Secure Boot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#enable-uboot-secure-boot-config">Enable UBoot Secure Boot Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prepare-secure-boot-key">Prepare Secure Boot Key</a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-secure-image">Make Secure Image</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#enable-secure-boot">Enable Secure Boot</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../7_usb_boot/0_usb_boot_index_cn.html">3.7 USB 启动</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_crypto_engine/0_crypto_engine_index_cn.html">3.8 加密引擎</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_multimedia/0_multimedia_index_cn.html">4.3 多媒体</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_usb/0_usb_index_cn.html">7.1 USB 主机与设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_sdio/0_sdioh_index_cn.html">7.2 SDIO 主机</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_dmac/0_dmac_index_cn.html">8.1 DMA 控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_rtc/0_rtc_index_cn.html">8.2 实时时钟（RTC）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_thermal/0_thermal_index_cn.html">8.3 热计量器（Thermel）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_adc/0_adc_index_cn.html">8.4 模数转换器（ADC）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_cap_touch/0_cap_touch_index_cn.html">8.5 电容触摸（Cap-touch）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_ir/0_ir_index_cn.html">8.6 红外收发器（IR）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_ledc/0_ledc_index_cn.html">8.7 LED 灯控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_i2c/0_i2c_index_cn.html">8.8 集成电路间通信（I2C）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_uart/0_uart_index_cn.html">8.9 通用异步收发传输器（UART）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_lcdc/0_lcdc_index_cn.html">8.A 液晶显示控制器（LCDC）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_spi/0_spi_index_cn.html">8.B 串行外设接口（SPI）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_spic/0_spic_index_cn.html">8.C SPI 闪存控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_timer/0_timer_index_cn.html">8.D 计时器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_wdg/0_wdg_index_cn.html">8.E 看门狗</a></li>
<li class="toctree-l1"><a class="reference internal" href="../9_bluetooth/0_bluetooth_index_cn.html">9.1 蓝牙</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ameba IoT Docs</a>
      </nav>

      <div class="wy-nav-content">

        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="0_secure_boot_index_nda_cn.html">Secure Boot</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<span id="secure-boot"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<p>Secure boot aims at firmware protection, which prevents attackers from modifying or replacing firmware maliciously. When the chip is powered on, the secure boot ROM executes to check the validation of the image signature.</p>
<p>If the signature is valid, authentication will be successful, which means that the firmware is safe and the subsequent operations can be continued. Otherwise, the SoC clears the stack and goes into an endless loop.</p>
<p>This chapter illustrates the usage of Linux verified boot.</p>
<section id="secure-boot-from-rom-code">
<h2>Secure Boot from ROM Code<a class="headerlink" href="#secure-boot-from-rom-code" title="Link to this heading"></a></h2>
<p>Linux secure boot should be guided to start from ROM code, which verifies the bootloader using Root of Trusted Key (RoT) saved in the OTP. Bootloader shall verify the KM0/KM4 images and <code class="file docutils literal notranslate"><span class="pre">cert.bin</span></code> in firmware. Except for RoT, all the keys are saved in <code class="file docutils literal notranslate"><span class="pre">cert.bin</span></code> (Key Cert).</p>
</section>
<section id="linux-secure-boot-flow">
<h2>Linux Secure Boot Flow<a class="headerlink" href="#linux-secure-boot-flow" title="Link to this heading"></a></h2>
<p>Linux secure boot is based on ROM/KM0/KM4 secure boot. The secure boot flow of Linux part is illustrated below.</p>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="../../_images/verified_boot_sw_arch.svg"><img alt="../../_images/verified_boot_sw_arch.svg" height="589" src="../../_images/verified_boot_sw_arch.svg" width="904" /></a>
<figcaption>
<p><span class="caption-text">Linux verified boot software architecture</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Normally, the kernel cmdline will be <code class="docutils literal notranslate"><span class="pre">Kernel</span> <span class="pre">command</span> <span class="pre">line:</span> <span class="pre">console=ttyS0,1500000</span> <span class="pre">earlycon</span> <span class="pre">psci=enable</span> <span class="pre">ubi.mtd=8</span> <span class="pre">ubi.block=0,0</span> <span class="pre">ubi.mtd=9</span> <span class="pre">dm-mod.create=&quot;system,,0,ro,</span> <span class="pre">0</span> <span class="pre">55928</span> <span class="pre">verity</span> <span class="pre">1</span> <span class="pre">/dev/ubiblock0_0</span> <span class="pre">/dev/ubiblock0_0</span> <span class="pre">4096</span> <span class="pre">4096</span> <span class="pre">6991</span> <span class="pre">6991</span> <span class="pre">sha512</span> <span class="pre">&lt;salt&gt;</span> <span class="pre">&lt;hash&gt;</span> <span class="pre">2</span> <span class="pre">ignore_corruption</span> <span class="pre">ignore_zero_blocks&quot;</span> <span class="pre">root=/dev/dm-0</span> <span class="pre">rootfstype=squashfs</span></code>.
The cmdline is shown when kernel initializing and the content is given by <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/sources/boot/uboot/cmd/realtek_avb.c</span></code>.
Function <code class="xref py py-func docutils literal notranslate"><span class="pre">realtek_organize_cmdline()</span></code> will abstract the key information and organize a new cmdline for secure boot.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">ubi.mtd=8</span></code> means the index of rootfs block in mtd, which is used to make mtd8 as character-device ubi0.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ubi.block=0,0</span></code> means make character-device ubi0 as block-device ubiblock0, because the dm verity can only be done for block-devices.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">dm-mod.create</span></code> parameters are defined by dm-verity driver. Including the block-device to verify, the size of hash block, the numbers of hash block, the start address of rootfs hash tree, the salt and digest of verification and so on. The digest is the root hash of rootfs which has been verified by VBmeta in uboot.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ubi.block0_0</span></code> is attached to dm-0. <code class="docutils literal notranslate"><span class="pre">root=/dev/dm-0</span></code> mounts dm-0 to root-filesystem which also means make informations in mtd8 area as rootfs. The dm-verity will do a dynamic hash calculation for any block and its related blocks when user accesses to some blocks in rootfs.</p></li>
</ul>
</div>
<p>For more details on dm-verity, refer to <a class="reference external" href="https://docs.kernel.org/admin-guide/device-mapper/verity.html">https://docs.kernel.org/admin-guide/device-mapper/verity.html</a>.</p>
<p>This section describes the Construction Parameters, Theory of operation, Hash Tree, On-disk format and some examples. The kernel command line is the only start-point for the hash-tree verification of rootfs, and the digest of root-hash for hash-tree will be inserted to VBmeta whose validity is confirmed by the former flow.</p>
<p>Codes of the above framework can be divided into three parts: <strong>Flash</strong> area, <strong>U-Boot</strong> area and <strong>kernel</strong> area. Only the core code directories of each part are listed below.</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Area</p></th>
<th class="head"><p>Directory</p></th>
<th class="head"><p>Introduction</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Flash</p></td>
<td><p>&lt;sdk&gt;/sources/yocto/meta-realtek/tools/verified_boot</p></td>
<td><p>The script of making secure related images.</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>U-Boot</p></td>
<td><p>&lt;uboot&gt;/cmd/mtd.c</p></td>
<td><p>The operations of reading NAND Flash.</p></td>
</tr>
<tr class="row-even"><td><p>&lt;uboot&gt;/cmd/realtek-avb.c</p></td>
<td><p>The verification of vbmeta/public key/kernel/dtb.</p></td>
</tr>
<tr class="row-odd"><td><p>Kernel</p></td>
<td><p>&lt;linux&gt;/drivers/md/*</p></td>
<td><p>This directory is provided by GPI Linux kernel named dm-verity, used to verify the hash tree of rootfs.</p></td>
</tr>
</tbody>
</table>
<p>More for android verified boot, refer to <a class="reference external" href="https://android.googlesource.com/platform/external/avb">https://android.googlesource.com/platform/external/avb</a>.</p>
</section>
</section>
<section id="configuration">
<span id="id1"></span><h1>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h1>
<p>Yocto SDK uses <code class="file docutils literal notranslate"><span class="pre">mksecure.sh</span></code> to build secure images, which is located at <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/sources/yocto/meta-realtek/tools/verified_boot</span></code>.
The usage of the script is illustrated below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mksecure</span><span class="o">.</span><span class="n">sh</span>
<span class="o">--</span><span class="n">key_dir</span><span class="o">=&lt;</span><span class="n">secure</span> <span class="n">key</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">output_dir</span><span class="o">=&lt;</span><span class="n">secure</span> <span class="n">image</span> <span class="n">output</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">input_dir</span><span class="o">=&lt;</span><span class="n">directory</span> <span class="n">of</span> <span class="n">the</span> <span class="n">normal</span> <span class="n">images</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">boot_image</span><span class="o">=&lt;</span><span class="n">boot</span> <span class="n">image</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">dtb_image</span><span class="o">=&lt;</span><span class="n">device</span> <span class="n">tree</span> <span class="n">blob</span> <span class="n">image</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">dtb_part_size</span><span class="o">=&lt;</span><span class="n">tree</span> <span class="n">blob</span> <span class="n">image</span> <span class="n">partition</span> <span class="n">size</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">kernel_image</span><span class="o">=&lt;</span><span class="n">kernel</span> <span class="n">image</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">kernel_part_size</span><span class="o">=&lt;</span><span class="n">kernel</span> <span class="n">partition</span> <span class="n">size</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">recovery_dtb_image</span><span class="o">=&lt;</span><span class="n">recovery</span> <span class="n">device</span> <span class="n">tree</span> <span class="n">blob</span> <span class="n">image</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">recovery_dtb_part_size</span><span class="o">=&lt;</span><span class="n">recovery</span> <span class="n">device</span> <span class="n">tree</span>  <span class="n">blob</span> <span class="n">partition</span> <span class="n">size</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">recovery_kernel_image</span><span class="o">=&lt;</span><span class="n">recovery</span> <span class="n">kernel</span> <span class="n">image</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">recovery_kernel_part_size</span><span class="o">=&lt;</span><span class="n">recovery</span> <span class="n">kernel</span> <span class="n">partition</span> <span class="n">size</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">root_image</span><span class="o">=&lt;</span><span class="n">rootfs</span> <span class="n">image</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">root_part_size</span><span class="o">=&lt;</span><span class="n">rootfs</span> <span class="n">partition</span> <span class="n">size</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">km4_boot</span><span class="o">=&lt;</span><span class="n">firmware</span> <span class="n">boot</span> <span class="n">image</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">km4_app</span><span class="o">=&lt;</span><span class="n">firmware</span> <span class="n">app</span> <span class="n">image</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">imgtool_flashloader</span><span class="o">=&lt;</span><span class="n">imgtool</span> <span class="n">flashloader</span> <span class="n">path</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">use_dtb_size</span> <span class="o">=&lt;</span><span class="n">enable</span> <span class="n">the</span> <span class="n">auto</span> <span class="n">parse</span> <span class="n">of</span> <span class="n">image</span> <span class="n">size</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The parameters are illustrated below:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Mandatory/Optional?</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>key_dir</p></td>
<td><p>Mandatory</p></td>
<td><p>Indicates where the secure keys locate at, default is <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/sources/yocto/meta-realtek/tools/verified_boot/security_keys/test</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p>output_dir</p></td>
<td><p>Mandatory</p></td>
<td><p>Indicates the output path of the secure images.</p></td>
</tr>
<tr class="row-even"><td><p>input_dir</p></td>
<td><p>Optional</p></td>
<td><div class="line-block">
<div class="line">Indicates the directory of the normal images. Images inside this directory will be used as the source of secure images.</div>
<div class="line">If <em>input_dir</em> is given, the boot_image, kernel_image, recovery_kernel_image, root_image, km4_boot, km4_app and</div>
<div class="line">imgtool_flashloader can be omitted. The mksecure.sh will use boot.img, uImage, &lt;va7, va8&gt;.rootfs.squashfs, km4_boot_all.bin,</div>
<div class="line">km0_km4_app.bin, imgtool_flashloader.bin, and uImage-initramfs-rtl8730elh-recovery.bin by default inside the given <em>input_dir</em>.</div>
<div class="line">If some of the images are specified by other input parameter, mksecure.sh will use the specified path preferentially.</div>
<div class="line">If <em>input_dir</em> is not given, all the image path shall be given each and every.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>dtb_imag</p></td>
<td><p>Mandatory</p></td>
<td><p>Indicates the path of non-secure device tree blob images.</p></td>
</tr>
<tr class="row-even"><td><p>recovery_dtb_image</p></td>
<td><p>Mandatory if recovery is enabled</p></td>
<td><div class="line-block">
<div class="line">Indicates the path of recovery device tree blob image, and this parameter is not mandatory if non-secure recovery images</div>
<div class="line">need to be flashed.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>boot_image</p></td>
<td><p>Optional if <em>input_dir</em> is given</p></td>
<td><p>Indicates the path of non-secure boot images.</p></td>
</tr>
<tr class="row-even"><td><p>kernel_image</p></td>
<td><p>Optional if <em>input_dir</em> is given</p></td>
<td><p>Indicates the path of non-secure kernal images.</p></td>
</tr>
<tr class="row-odd"><td><p>recovery_kernel_image</p></td>
<td><p>Optional if <em>input_dir</em> is given</p></td>
<td><div class="line-block">
<div class="line">Indicates the path of non-secure recovery kernal images, and this parameter is not mandatory if non-secure recovery images</div>
<div class="line">need to be flashed.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>root_image</p></td>
<td><p>Optional if <em>input_dir</em> is given</p></td>
<td><p>Indicates the path of non-secure rootfs squashfs image, and only squashfs image is needed.</p></td>
</tr>
<tr class="row-odd"><td><p>km4_boot</p></td>
<td><p>Optional if <em>input_dir</em> is given</p></td>
<td><p>Indicates the path of non-secure firmware boot image.</p></td>
</tr>
<tr class="row-even"><td><p>km4_app</p></td>
<td><p>Optional if <em>input_dir</em> is given</p></td>
<td><p>Indicates the path of non-secure firmware APP image.</p></td>
</tr>
<tr class="row-odd"><td><p>km4_boot</p></td>
<td><p>Optional if <em>input_dir</em> is given</p></td>
<td><p>Indicates the path of non-secure firmware boot image.</p></td>
</tr>
<tr class="row-even"><td><p>imgtool_flashloader</p></td>
<td><p>Optional if <em>input_dir</em> is given</p></td>
<td><p>Indicates the path of <code class="file docutils literal notranslate"><span class="pre">imgtool_flashloader.bin</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p>use_dtb_size</p></td>
<td><p>Optional, also named as <em>-s</em></p></td>
<td><div class="line-block">
<div class="line">Set to 1 to enable automatically dtb parse. The <code class="file docutils literal notranslate"><span class="pre">mksecure.mk</span></code> will parse the size information according to the selected dtb_image.</div>
<div class="line">If <em>-s</em> is enabled, the size information of dtb_part_size, kernel_part_size, recovery_dtb_part_size, recovery_kernel_part_size,</div>
<div class="line">and root_part_size can be omitted. However, make sure that the description for layout in dts includes the key names of</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Device</span> <span class="pre">Tree</span> <span class="pre">Blob</span></code>, <code class="docutils literal notranslate"><span class="pre">Kernel</span> <span class="pre">Image</span></code>, and <code class="docutils literal notranslate"><span class="pre">Rootfs</span> <span class="pre">Image</span></code> (the capitalization of letters is not important).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>dtb_part_size</p></td>
<td><p>Only useful when <em>-s</em> is not set</p></td>
<td><div class="line-block">
<div class="line">Indicates the partition size of device tree blob partition, which is described in</div>
<div class="line"><code class="file docutils literal notranslate"><span class="pre">&lt;dts_dir&gt;/rtl8730e-spi-nand-256m.dtsi</span> <span class="pre">(rtl8730e-spi-nand-128m.dtsi)</span></code>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>kernel_part_size</p></td>
<td><p>Only useful when <em>-s</em> is not set</p></td>
<td><p>Indicates the partition size of kernel partition described in <code class="file docutils literal notranslate"><span class="pre">rtl8730e-spi-nand-256m.dtsi</span> <span class="pre">(rtl8730e-spi-nand-128m.dtsi)</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p>recovery_dtb_part_size</p></td>
<td><p>Only useful when <em>-s</em> is not set</p></td>
<td><div class="line-block">
<div class="line">Indicates the partition size of recovery device tree blob described in <code class="file docutils literal notranslate"><span class="pre">rtl8730e-spi-nand-256m.dtsi</span> <span class="pre">(rtl8730e-spi-nand-128m.dtsi)</span></code>,</div>
<div class="line">and this parameter is not mandatory if non-secure recovery images need to be flashed.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>recovery_kernel_part_size</p></td>
<td><p>Only useful when <em>-s</em> is not set</p></td>
<td><div class="line-block">
<div class="line">Indicates the partition size of recovery kernel described in <code class="file docutils literal notranslate"><span class="pre">rtl8730e-spi-nand-256m.dtsi</span> <span class="pre">(rtl8730e-spi-nand-128m.dtsi)</span></code>,</div>
<div class="line">and this parameter is not mandatory if non-secure recovery images need to be flashed.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>root_part_size</p></td>
<td></td>
<td><p>Indicates the partition size of rootfs described in <code class="file docutils literal notranslate"><span class="pre">rtl8730e-spi-nand-256m.dtsi</span> <span class="pre">(rtl8730e-spi-nand-128m.dtsi)</span></code>.</p></td>
</tr>
</tbody>
</table>
<p>Where <cite>&lt;dts_dir&gt;</cite> means the directory of dts files, which is <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/kernel/linux-5.4/arch/arm/boot/dts</span></code> for kernel 5.4.x, and <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/kernel/linux-6.6/arch/arm/boot/dts/realtek/ameba</span></code> for kernel 6.6.x.</p>
</section>
<section id="how-to-use-secure-boot">
<h1>How to Use Secure Boot<a class="headerlink" href="#how-to-use-secure-boot" title="Link to this heading"></a></h1>
<p>The following steps illustrate how to use secure boot.</p>
<ol class="arabic simple">
<li><p>Enable uboot secure boot configs</p></li>
<li><p>Prepare secure boot keys</p></li>
<li><p>Make and generate raw images</p></li>
<li><p>Make secure images</p></li>
<li><p>Enable firmware secure boot related OTP bits after the system boots up</p></li>
</ol>
<section id="enable-uboot-secure-boot-config">
<h2>Enable UBoot Secure Boot Config<a class="headerlink" href="#enable-uboot-secure-boot-config" title="Link to this heading"></a></h2>
<p>To enable Linux secure boot, uboot related secure boot configs need to be opened, the uboot config listed at <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/sources/boot/uboot/configs</span></code> and secure boot related configs are listed below</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONFIG_VERIFIED_BOOT</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_OTP_RTK_AMEBA</span><span class="o">=</span><span class="n">y</span>
</pre></div>
</div>
<p>Make sure the configs above are enabled.</p>
<p>Currently we have enabled the configs in default.</p>
</section>
<section id="prepare-secure-boot-key">
<h2>Prepare Secure Boot Key<a class="headerlink" href="#prepare-secure-boot-key" title="Link to this heading"></a></h2>
<p>To use Linux verified boot, secure keys should be prepared. Just as mentioned above, key path needs to be set by configuring <code class="docutils literal notranslate"><span class="pre">--key_dir</span></code> parameter when executing <code class="file docutils literal notranslate"><span class="pre">mksecure.sh</span></code>.</p>
<p>The default manifest/key file (<code class="file docutils literal notranslate"><span class="pre">manifest.json/key.json</span></code>) and keys are located at <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/sources/yocto/meta-realtek/tools/verified_boot/security_keys/test</span></code>.</p>
<p>Linux SDK provides tool <code class="docutils literal notranslate"><span class="pre">make_key</span></code> (<code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/sources/yocto/meta-realtek/tools/verified_boot</span></code>) for users to generate their own secure keys under specific key path. Use the following command to generate secure keys, which will be generated under the path below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make_key</span> <span class="o">&lt;</span><span class="n">key</span> <span class="n">path</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Secure keys are listed below:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fw.key</p></td>
<td><p>Used to sign the firmware bootloader and key certificate</p></td>
</tr>
<tr class="row-odd"><td><p>root.key</p></td>
<td><p>Used to sign firmware NSPE/SPE and Linux boot image</p></td>
</tr>
<tr class="row-even"><td><p>vbmeta.priv.key/vbmeta.pub.key</p></td>
<td><p>Used to sign Linux vbmeta image</p></td>
</tr>
</tbody>
</table>
</section>
<section id="make-secure-image">
<h2>Make Secure Image<a class="headerlink" href="#make-secure-image" title="Link to this heading"></a></h2>
<p>Before making secure images, all the raw images (except firmware images) need to be generated first. Refer to <a class="reference internal" href="#configuration"><span class="std std-ref">Configuration</span></a> to use <code class="file docutils literal notranslate"><span class="pre">mksecure.sh</span></code> to make secure images if needed.</p>
<p>elf2bin is used to make secure image in mksecure.sh, the usage of elf2bin is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elf2bin</span> <span class="n">manifest</span> <span class="o">&lt;</span><span class="n">manifest_json</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">key_json</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">img_file</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">out_file</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">app</span><span class="o">|</span><span class="n">boot</span><span class="p">]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">elf2bin</span> <span class="pre">manifest</span></code> is used to generate <code class="file docutils literal notranslate"><span class="pre">manifest.bin</span></code> for specific image.</p>
<dl class="field-list simple">
<dt class="field-odd">&lt;manifest_json&gt;<span class="colon">:</span></dt>
<dd class="field-odd"><p>manifest file describing related information for image. The default manifest file locates at <code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/sources/</span> <span class="pre">yocto/meta-realtek/tools/verified_boot/security_keys/test</span></code>.</p>
</dd>
<dt class="field-even">&lt;key_json&gt;<span class="colon">:</span></dt>
<dd class="field-even"><p>key file describing key-related information for image. The default key file locates at the path above too.</p>
</dd>
<dt class="field-odd">&lt;img_file&gt;<span class="colon">:</span></dt>
<dd class="field-odd"><p>image needed to generate <code class="file docutils literal notranslate"><span class="pre">manifest.bin</span></code>.</p>
</dd>
<dt class="field-even">&lt;out_file&gt;<span class="colon">:</span></dt>
<dd class="field-even"><p>output secure manifest file for <code class="docutils literal notranslate"><span class="pre">&lt;img_file&gt;</span></code></p>
</dd>
<dt class="field-odd">[app|boot]<span class="colon">:</span></dt>
<dd class="field-odd"><p>indicates manifest type for image. <code class="docutils literal notranslate"><span class="pre">boot</span></code> is used for firmware boot, and <code class="docutils literal notranslate"><span class="pre">app</span></code> is for firmware app image including Linux bootloader.</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elf2bin</span> <span class="n">cert</span> <span class="o">&lt;</span><span class="n">manifest_json</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">key_json</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">out_file</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">key_id1</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">app</span><span class="o">|</span><span class="n">vbmeta</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">key1_json</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">elf2bin</span> <span class="pre">cert</span></code> is used to generate <code class="file docutils literal notranslate"><span class="pre">cert.bin</span></code> for all app images. <code class="file docutils literal notranslate"><span class="pre">cert.bin</span></code> contains the app image secure information, and is used to verify each app image</p>
<dl class="field-list">
<dt class="field-odd">&lt;manifest_json&gt;<span class="colon">:</span></dt>
<dd class="field-odd"><div class="line-block">
<div class="line">manifest file describing related information for image. The default</div>
<div class="line">manifest file locates at</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">&lt;sdk&gt;/sources/yocto/meta-realtek/tools/verified_boot/security_keys/test</span></code>.</div>
</div>
</dd>
<dt class="field-even">&lt;key_json&gt;<span class="colon">:</span></dt>
<dd class="field-even"><div class="line-block">
<div class="line">key file describing key-related information for image. The default key file</div>
<div class="line">locates at the path above too.</div>
</div>
</dd>
<dt class="field-odd">&lt;out_file&gt;<span class="colon">:</span></dt>
<dd class="field-odd"><p>output secure cert file.</p>
</dd>
<dt class="field-even">&lt;key_id1&gt; [app|vbmeta] &lt;key1_json&gt;<span class="colon">:</span></dt>
<dd class="field-even"><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;key_id1&gt;</span></code> indicates key ID in <code class="file docutils literal notranslate"><span class="pre">cert.bin</span></code>, whose value begins from 0.</p></li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">[app|vbmeta]</span></code> indicates the image type described in <code class="docutils literal notranslate"><span class="pre">&lt;key1_json&gt;</span></code>.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">vbmeta</span></code> is used to verify Linux vbmeta image, and <code class="docutils literal notranslate"><span class="pre">app</span></code> is used to</div>
<div class="line">verify other app images (firmware app images, Linux bootloader).</div>
</div>
</li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="enable-secure-boot">
<h1>Enable Secure Boot<a class="headerlink" href="#enable-secure-boot" title="Link to this heading"></a></h1>
<p>After flashing the secure images and system boots up, enable secure boot via programming OTP bit.</p>
<ol class="arabic">
<li><p>Start km4_console to program OTP.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$km4_console
</pre></div>
</div>
</li>
<li><p>Program secure boot root public key hash in OTP.</p>
<p>The root public key hash value is from <code class="docutils literal notranslate"><span class="pre">public</span> <span class="pre">key</span> <span class="pre">hash</span></code> field of <code class="docutils literal notranslate"><span class="pre">fw.key</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span><span class="s2">&quot;ed25519&quot;</span><span class="p">,</span>
   <span class="s2">&quot;private key&quot;</span><span class="p">:</span><span class="s2">&quot;6AA34203018334474B25A0600996CA0968AA6228B886FF234B4EB9628B703C0A&quot;</span><span class="p">,</span>
   <span class="s2">&quot;public key&quot;</span><span class="p">:</span><span class="s2">&quot;E2A0D6500BBF1DD8DC212098C230EB731ECE3A81AA11D0E6E538FA36BBA4FF6E&quot;</span><span class="p">,</span>
   <span class="s2">&quot;public key hash&quot;</span><span class="p">:</span><span class="s2">&quot;72B2E1CB0E8F715262AF38DFA0E522C95660D0EBFD920F4B1A229845E599C697&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Use the following command to program OTP PK1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">efuse</span> <span class="n">wraw</span> <span class="mi">320</span> <span class="mi">20</span> <span class="mi">72</span><span class="n">B2E1CB0E8F715262AF38DFA0E522C95660D0EBFD920F4B1A229845E599C697</span>
</pre></div>
</div>
</li>
<li><p>Enable secure boot in OTP.</p>
<ol class="loweralpha">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">efuse</span> <span class="pre">rmap</span></code> first to check value in 0x2 and 0x3:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$efuse rmap 0 16
</pre></div>
</div>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/check_bit.png"><img alt="../../_images/check_bit.png" src="../../_images/check_bit.png" style="width: 413.6px; height: 225.20000000000002px;" /></a>
</figure>
<p>The value of 0x2 0x3 is 1080.</p>
</li>
<li><p>Enable secure boot enable bit (set 0x3[2] to 1)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$efuse wmap 2 2 1084
</pre></div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">efuse</span> <span class="pre">rmap</span></code> check if secure boot bit is set successfully.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/enable_bit.png"><img alt="../../_images/enable_bit.png" src="../../_images/enable_bit.png" style="width: 415.20000000000005px; height: 218.4px;" /></a>
</figure>
</li>
</ol>
</li>
<li><p>Reset the board.</p>
<p>When secure boot is successful, you can see the following logs:</p>
<ul class="simple">
<li><p><strong>IMG1 SBOOT EN</strong>: secure boot is enabled</p></li>
<li><p><strong>IMG1(OTA1) VALID, ret: 0</strong>: bootloader authentication pass</p></li>
<li><p><strong>IMG2 VERIFY PASS</strong>: IMAGE2 authentication pass</p></li>
<li><p><strong>AP BL1&amp;FIP VERIFY PASS</strong>: AP uboot authentication pass</p></li>
<li><p><strong>Public Key Hash Verified Success</strong></p></li>
<li><p><strong>Rollback Index: Version PASS!</strong>: rollback authentication pass</p></li>
<li><p><strong>VbMeta Signature Verified Success!</strong>: vbmeta authentication pass</p></li>
<li><p><strong>Kernel Image verified success!</strong>: linux kernel authentication pass</p></li>
<li><p><strong>DTB/FDT Image verified success!</strong>: Linux DTB authentication pass</p></li>
<li><p><strong>linux verified boot: success!</strong></p></li>
</ul>
</li>
</ol>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="0_secure_boot_index_nda_cn.html" class="btn btn-neutral float-left" title="Secure Boot" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../7_usb_boot/0_usb_boot_index_cn.html" class="btn btn-neutral float-right" title="USB BOOT" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2025, Realsil。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 



</body>
</html>