

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; Ameba IoT Docs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=7d84cf84" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="../../_static/_static/custom.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/toggleprompt.js?v=d7ede5d2"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Watchdog" href="../8_wdg/0_wdg_index.html" />
    <link rel="prev" title="Timer" href="0_timer_index.html" />
   
  
  <script type="text/javascript" src="../../_static/js/selector.js"></script>

  <style>
    .wy-nav-content {max-width: 1000px;} /* 设置最大宽度 */
  </style>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Ameba IoT Docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_ameba_product/0_ameba_product_center_index.html">Products Center</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_ameba_sdk/0_ameba_sdks_index.html">Ameba SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_release_packages/0_release_packages_index.html">0.0 Release Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_gcc_build_environment/0_gcc_build_index.html">0.1 Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_sdk_architecture/0_sdk_architecture_index.html">0.2 SDK Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rst_rtos/0_tools/0_tools_index.html">0.7 Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_question_help/0_question_help_index.html">0.A Questions and Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_debugging/0_debugging_index.html">0.B System Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_boot_process/0_boot_index.html">1.1 BOOT Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_ota/0_ota_index.html">1.2 OTA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_otpc/0_otpc_index.html">1.3 OTPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_flash/0_flash_index.html">1.4 Flash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_gpio/0_gpio_index.html">1.7 GPIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_power_save/0_ps_index.html">1.8 Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_nda_secure_boot/0_secure_boot_index_nda.html">3.6 Secure Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_usb_boot/0_usb_boot_index.html">3.7 USB Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_crypto_engine/0_crypto_engine_index.html">3.8 Crypto Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_multimedia/0_multimedia_index.html">4.3 Multimedia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_usb/0_usb_index.html">7.1 USB Host &amp; Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_sdio/0_sdioh_index.html">7.2 SDIO Host</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_dmac/0_dmac_index.html">8.1 DMA Controllor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_rtc/0_rtc_index.html">8.2 RTC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_thermal/0_thermal_index.html">8.3 Thermal Meter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_adc/0_adc_index.html">8.4 ADC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_cap_touch/0_cap_touch_index.html">8.5 Cap-Touch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_ir/0_ir_index.html">8.6 IR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_ledc/0_ledc_index.html">8.7 LEDC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_i2c/0_i2c_index.html">8.8 I2C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_uart/0_uart_index.html">8.9 UART</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_lcdc/0_lcdc_index.html">8.A LCDC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_spi/0_spi_index.html">8.B SPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_spic/0_spic_index.html">8.C SPI Flash Controller</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="0_timer_index.html">8.D Timer</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#clock-source">Clock Source</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation">Implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dts-configuration">DTS Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-configuration">Build Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#apis">APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#apis-for-user-space">APIs for User Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#apis-for-kernel-space">APIs for Kernel Space</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mfd-timer">MFD Timer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#software-architecture">Software Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">DTS configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">Build Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">APIs for User Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">APIs for Kernel Space</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#pwm">PWM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">Implementation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id13">Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">DTS configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">Build Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id16">APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id17">APIs for User Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">APIs for Kernel Space</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../8_wdg/0_wdg_index.html">8.E Watchdog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../9_bluetooth/0_bluetooth_index.html">9.1 Bluetooth</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ameba IoT Docs</a>
      </nav>

      <div class="wy-nav-content">

        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="0_timer_index.html">Timer</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<span id="timers"></span><h1>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h1>
<p>General timer could work in three Linux subsystems.</p>
<ul class="simple">
<li><p>Clock source – general timer can be clock source of time subsystem.</p></li>
<li><p>MFD timer – just to implement basic timing function of general timer in MFD subsystem.</p></li>
<li><p>PWM – timer8 is PWM timer and it is implemented in PWM subsystem.</p></li>
</ul>
<p>The three sections will be described separately.</p>
</section>
<section id="clock-source">
<h1>Clock Source<a class="headerlink" href="#clock-source" title="Link to this heading"></a></h1>
<section id="id1">
<h2>Introduction<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<section id="architecture">
<h3>Architecture<a class="headerlink" href="#architecture" title="Link to this heading"></a></h3>
<p>The generic timer can be used as clock source or clock event. Typical usage is as broadcast timer in time subsystem. Architecture of Linux time subsystem is shown below.</p>
<figure class="align-center" id="id19">
<a class="reference internal image-reference" href="../../_images/time_subsystem_software_arch.png"><img alt="../../_images/time_subsystem_software_arch.png" src="../../_images/time_subsystem_software_arch.png" style="width: 306.59999999999997px; height: 256.2px;" /></a>
<figcaption>
<p><span class="caption-text">Time subsystem software architecture</span><a class="headerlink" href="#id19" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Time related modules (tick devices, hrtimer, timekeeping, etc.) depend on clock source module and clock event module, which depend on hardware timer. General timers are hardware timer so it can be used as clock source module and clock event module.</p>
<p>General timers’ frequency is not enough to make it a tick device for system. Actually, CPU local timer is the tick device to generate tick for system.</p>
<p>However, general timer still plays a role in time subsystem, that is, as a broadcast timer. The existence of broadcast timer is useful for the time subsystem, which make the CPU local timer can use oneshot mode. Also, the system can stop the CPU local timer in idle state to save power.</p>
<p>All Generic timers can be used as clock source.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Timer0 could be used as system timer for LP and NP system, so it is not recommended to use Timer0 as clock source.</p>
</div>
</section>
<section id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h3>
<p>Clock source driver for general timer is implemented as following files:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Driver location</p></th>
<th class="head"><p>Introduction</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/rtkdrivers/clocksource/Kconfig</p></td>
<td><p>Clock source driver Kconfig</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;linux&gt;/drivers/rtkdrivers/clocksource/Makefile</p></td>
<td><p>Clock source driver Makefile</p></td>
</tr>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/rtkdrivers/clocksource/timer-rtk.c</p></td>
<td><p>Clock source driver for general timer.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h2>
<section id="dts-configuration">
<h3>DTS Configuration<a class="headerlink" href="#dts-configuration" title="Link to this heading"></a></h3>
<p>DTS configuration is as follows. Take TIMER1 as an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">timer1</span><span class="p">:</span> <span class="n">timer</span><span class="o">@</span><span class="mi">4200</span><span class="n">B200</span> <span class="p">{</span>
   <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;realtek,ameba-timer-clk&quot;</span><span class="p">;</span>
   <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x4200B200</span> <span class="mh">0x200</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">interrupts</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">GIC_SPI</span> <span class="mi">1</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">clocks</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">rcc</span> <span class="n">RTK_CKE_TIM1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The description of DTS properties is as below:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Configurable?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>compatible</p></td>
<td><p>ID to match the driver and device</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>reg</p></td>
<td><p>Register resource.</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>interrupts</p></td>
<td><p>SPI interrupt</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>clocks</p></td>
<td><p>General timer clock node</p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
</section>
<section id="build-configuration">
<h3>Build Configuration<a class="headerlink" href="#build-configuration" title="Link to this heading"></a></h3>
<p>Select Device Drivers &gt; Drivers for Realtek &gt; Clocksource driver &gt; General timer:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/clock_source_build_configuration1.png"><img alt="../../_images/clock_source_build_configuration1.png" src="../../_images/clock_source_build_configuration1.png" style="width: 419.5px; height: 261.5px;" /></a>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/clock_source_build_configuration2.png"><img alt="../../_images/clock_source_build_configuration2.png" src="../../_images/clock_source_build_configuration2.png" style="width: 424.0px; height: 88.0px;" /></a>
</figure>
</section>
</section>
<section id="apis">
<h2>APIs<a class="headerlink" href="#apis" title="Link to this heading"></a></h2>
<section id="apis-for-user-space">
<h3>APIs for User Space<a class="headerlink" href="#apis-for-user-space" title="Link to this heading"></a></h3>
<p>None.</p>
</section>
<section id="apis-for-kernel-space">
<h3>APIs for Kernel Space<a class="headerlink" href="#apis-for-kernel-space" title="Link to this heading"></a></h3>
<p>Refer to <a class="reference external" href="https://www.kernel.org/doc/html/v5.4/timers/index.html#">timers_information</a> to get more information.</p>
</section>
</section>
</section>
<section id="mfd-timer">
<h1>MFD Timer<a class="headerlink" href="#mfd-timer" title="Link to this heading"></a></h1>
<section id="id2">
<h2>Introduction<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<section id="software-architecture">
<h3>Software Architecture<a class="headerlink" href="#software-architecture" title="Link to this heading"></a></h3>
<p>General timers’ basic timing functions are put in MFD (Multi-function Device) subsystem. Due to the emergence of a kind of peripheral devices with multiple functions, Linux provides a MFD subsystem.</p>
<p>Actually, MFD timer driver does not use any contents of MFD subsystem, So MFD architecture is not shown here.</p>
<p>MFD timer driver just provide APIs for kernel so that kernel can use timer interrupt function simply.</p>
<p>All generic timers can be MFD Timer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Timer0 is system timer for LP and NP, so it is not recommended to use Timer0 as MFD timer.</p>
</div>
</section>
<section id="id3">
<h3>Implementation<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>MFD timer driver is implemented as following files:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Driver location</p></th>
<th class="head"><p>Introduction</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/rtkdrivers/mfd_timer/Kconfig</p></td>
<td><p>MFD timer driver Kconfig</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;linux&gt;/drivers/rtkdrivers/mfd_timer/Makefile</p></td>
<td><p>MFD timer driver Makefile</p></td>
</tr>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/rtkdrivers/mfd_timer/rtk-timer.c</p></td>
<td><p>MFD timer driver for general timer.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="id4">
<h2>Configuration<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<section id="id5">
<h3>DTS configuration<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<p>DTS configuration is as follows. Take timer2 as an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">timer2</span><span class="p">:</span> <span class="n">timer</span><span class="o">@</span><span class="mi">4200</span><span class="n">B400</span> <span class="p">{</span>
   <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;realtek,ameba-timer&quot;</span><span class="p">;</span>
   <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x4200B400</span> <span class="mh">0x200</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">interrupts</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">GIC_SPI</span> <span class="mi">2</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">clocks</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">rcc</span> <span class="n">RTK_CKE_TIM2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The following is property description:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Configurable?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>compatible</p></td>
<td><p>ID to match the driver and device</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>reg</p></td>
<td><p>Register resource.</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>interrupts</p></td>
<td><p>SPI interrupt</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>clocks</p></td>
<td><p>General clock node</p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id6">
<h3>Build Configuration<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<p>Select Device Drivers &gt; Drivers for Realtek &gt; Timer driver:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/mfd_build_configuration.png"><img alt="../../_images/mfd_build_configuration.png" src="../../_images/mfd_build_configuration.png" style="width: 427.5px; height: 274.0px;" /></a>
</figure>
</section>
</section>
<section id="id7">
<h2>APIs<a class="headerlink" href="#id7" title="Link to this heading"></a></h2>
<section id="id8">
<h3>APIs for User Space<a class="headerlink" href="#id8" title="Link to this heading"></a></h3>
<p>None.</p>
</section>
<section id="id9">
<h3>APIs for Kernel Space<a class="headerlink" href="#id9" title="Link to this heading"></a></h3>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>rtk_gtimer_init</p></td>
<td><p>Initilize a mfd-timer with a specific channel number.</p></td>
</tr>
<tr class="row-odd"><td><p>rtk_gtimer_dynamic_init</p></td>
<td><p>Initilize a mfd-timer with any free channel.</p></td>
</tr>
<tr class="row-even"><td><p>rtk_gtimer_deinit</p></td>
<td><p>Deinitilize timer.</p></td>
</tr>
<tr class="row-odd"><td><p>rtk_gtimer_int_config</p></td>
<td><p>Enable or disable timer update interrupt.</p></td>
</tr>
<tr class="row-even"><td><p>rtk_gtimer_int_clear</p></td>
<td><p>Clear interrupt flag.</p></td>
</tr>
<tr class="row-odd"><td><p>rtk_gtimer_change_period</p></td>
<td><p>Change timer period.</p></td>
</tr>
<tr class="row-even"><td><p>rtk_gtimer_start</p></td>
<td><p>Start or stop timer(counter will not reset to 0).</p></td>
</tr>
</tbody>
</table>
<p>The following is an example to show how to use kernel APIs.</p>
<ol class="arabic">
<li><p>Init MFD timer device.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">rtk_gtimer_init</span><span class="p">(</span><span class="n">Tim_Idx</span><span class="p">,</span><span class="w"> </span><span class="mi">10000000</span><span class="p">,</span><span class="w"> </span><span class="n">timer_callback</span><span class="p">,</span><span class="w"> </span><span class="n">cbdata</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Configure MFD timer interrupt.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">rtk_gtimer_int_config</span><span class="p">(</span><span class="n">Tim_Idx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Start the timer.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">rtk_gtimer_start</span><span class="p">(</span><span class="n">Tim_Idx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
<p>Timer interrupt will rise after 10000000ns and then executes handler time_callback which use parameter cbcata.</p>
</section>
</section>
</section>
<section id="pwm">
<h1>PWM<a class="headerlink" href="#pwm" title="Link to this heading"></a></h1>
<section id="id10">
<h2>Introduction<a class="headerlink" href="#id10" title="Link to this heading"></a></h2>
<section id="id11">
<h3>Architecture<a class="headerlink" href="#id11" title="Link to this heading"></a></h3>
<p>The PWM timer can be used as PMW device. The architecture of Linux PWM subsystem is shown below.</p>
<figure class="align-center" id="id20">
<a class="reference internal image-reference" href="../../_images/pwm_subsystem_arch.png"><img alt="../../_images/pwm_subsystem_arch.png" src="../../_images/pwm_subsystem_arch.png" style="width: 419.29999999999995px; height: 324.09999999999997px;" /></a>
<figcaption>
<p><span class="caption-text">PWM subsystem architecture</span><a class="headerlink" href="#id20" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Application controls PWM device through sysfs layer, while kernel controls it through API. PWM core implements core logic of PWM subsystem.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only timer 8 can be PWM device.</p>
</div>
</section>
<section id="id12">
<h3>Implementation<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<p>PWM driver is implemented as following files:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Driver location</p></th>
<th class="head"><p>Introduction</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/rtkdrivers/pwm/Kconfig</p></td>
<td><p>PWM timer driver Kconfig</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;linux&gt;/drivers/rtkdrivers/pwm/Makefile</p></td>
<td><p>PWM timer driver Makefile</p></td>
</tr>
<tr class="row-even"><td><p>&lt;linux&gt;/drivers/rtkdrivers/pwm/rtk-pwm.c</p></td>
<td><p>PWM driver for PWM timer.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="id13">
<h2>Configuration<a class="headerlink" href="#id13" title="Link to this heading"></a></h2>
<section id="id14">
<h3>DTS configuration<a class="headerlink" href="#id14" title="Link to this heading"></a></h3>
<p>As PMW timer also can be general timer, PWM node is in timer node. DTS configuration is as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">timer8</span><span class="p">:</span> <span class="n">timer</span><span class="o">@</span><span class="mi">4100</span><span class="n">A000</span> <span class="p">{</span>
   <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;realtek,ameba-timer&quot;</span><span class="p">;</span>
   <span class="c1">#address-cells = &lt;1&gt;;</span>
   <span class="c1">#size-cells = &lt;1&gt;;</span>
   <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x4100A000</span> <span class="mh">0x200</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">interrupts</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">GIC_SPI</span> <span class="mi">57</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">clocks</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">rcc</span> <span class="n">RTK_CKE_TIM_PWM</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="n">pwm</span><span class="p">:</span> <span class="n">pwm</span><span class="o">@</span><span class="mi">0</span> <span class="p">{</span>
      <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;realtek,ameba-pwm&quot;</span><span class="p">;</span>
      <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;disabled&quot;</span><span class="p">;</span>
   <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The following table is property description:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Configurable?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>compatible</p></td>
<td><p>ID to match the driver and device</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>reg</p></td>
<td><p>Register resource.</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>status</p></td>
<td><p>Whether enable this device.</p>
<ul class="simple">
<li><p>“disable”</p></li>
<li><p>“enable”</p></li>
</ul>
</td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
<p>DTS nodes of pinctrl are defined in <code class="docutils literal notranslate"><span class="pre">&lt;dts&gt;/rtl8730e-pinctrl.dtsi</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pwm_pins</span><span class="p">:</span> <span class="n">pwm</span><span class="o">@</span><span class="mi">0</span> <span class="p">{</span>
   <span class="n">pins1</span> <span class="p">{</span>
      <span class="n">pinmux</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">REALTEK_PINMUX</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">PWM</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">//</span> <span class="n">HS_PWM0</span>
               <span class="o">&lt;</span><span class="n">REALTEK_PINMUX</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">PWM</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>     <span class="o">//</span> <span class="n">HS_PWM1</span>
               <span class="o">&lt;</span><span class="n">REALTEK_PINMUX</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">PWM</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>     <span class="o">//</span> <span class="n">HS_PWM2</span>
               <span class="o">&lt;</span><span class="n">REALTEK_PINMUX</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">PWM</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>     <span class="o">//</span> <span class="n">HS_PWM3</span>
               <span class="o">&lt;</span><span class="n">REALTEK_PINMUX</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">PWM</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>     <span class="o">//</span> <span class="n">HS_PWM4</span>
      <span class="n">bias</span><span class="o">-</span><span class="n">pull</span><span class="o">-</span><span class="n">up</span><span class="p">;</span>
      <span class="n">slew</span><span class="o">-</span><span class="n">rate</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
      <span class="n">drive</span><span class="o">-</span><span class="n">strength</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="p">};</span>
   <span class="n">pins2</span> <span class="p">{</span>
      <span class="n">pinmux</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">REALTEK_PINMUX</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">PWM</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>  <span class="o">//</span> <span class="n">HS_PWM5</span>
      <span class="n">bias</span><span class="o">-</span><span class="n">pull</span><span class="o">-</span><span class="n">up</span><span class="p">;</span>
      <span class="n">swd</span><span class="o">-</span><span class="n">disable</span><span class="p">;</span>
      <span class="n">slew</span><span class="o">-</span><span class="n">rate</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
      <span class="n">drive</span><span class="o">-</span><span class="n">strength</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
   <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The following table is property description:</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Configurable?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>pinmux</p></td>
<td><p>Pin definition of PWM</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>bias-pull-up</p></td>
<td><p>Pin pull status</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>slew-rate</p></td>
<td><p>Pin voltage slew rate</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>drive-strength</p></td>
<td><p>Pin drive strength</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Refer to pinmux specification to choose pin assignment.</p>
</div>
</section>
<section id="id15">
<h3>Build Configuration<a class="headerlink" href="#id15" title="Link to this heading"></a></h3>
<p>Select Device Drivers &gt; Drivers for Realtek &gt; PWM driver:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../../_images/pwm_build_configuration.png"><img alt="../../_images/pwm_build_configuration.png" src="../../_images/pwm_build_configuration.png" style="width: 422.5px; height: 274.5px;" /></a>
</figure>
</section>
</section>
<section id="id16">
<h2>APIs<a class="headerlink" href="#id16" title="Link to this heading"></a></h2>
<section id="id17">
<h3>APIs for User Space<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<p>PWM subsystem provides user space interface: /sys/class/pwm</p>
<p>User can control PWM device through sysfs layer. The PWM node is <code class="docutils literal notranslate"><span class="pre">/sys/class/pwm/pwmchip0</span></code>.</p>
<p>The following is an example:</p>
<ol class="arabic">
<li><p>User should choose a channel to export firstly. Command to export channel 2:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">pwm</span><span class="o">/</span><span class="n">pwmchip0</span><span class="o">/</span><span class="n">export</span>
</pre></div>
</div>
</li>
<li><p>Command to configure period to 2000000ns:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span><span class="w"> </span><span class="mi">2000000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">pwm</span><span class="o">/</span><span class="n">pwmchip0</span><span class="o">/</span><span class="n">pwm2</span><span class="o">/</span><span class="n">period</span>
</pre></div>
</div>
</li>
<li><p>Command to configure duty cycle to 25%:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span><span class="w"> </span><span class="mi">500000</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">pwm</span><span class="o">/</span><span class="n">pwmchip0</span><span class="o">/</span><span class="n">pwm2</span><span class="o">/</span><span class="n">duty_cycle</span>
</pre></div>
</div>
</li>
<li><p>Command to enable PWM channel:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">pwm</span><span class="o">/</span><span class="n">pwmchip0</span><span class="o">/</span><span class="n">pwm2</span><span class="o">/</span><span class="n">enable</span>
</pre></div>
</div>
</li>
</ol>
<p>Then, channel 2 will output square wave with 500Hz frequency and 25% duty cycle.</p>
<p>PWM demo for user space is located at &lt;test&gt;/pwm. Refer to PWM demo to get more information.</p>
</section>
<section id="id18">
<h3>APIs for Kernel Space<a class="headerlink" href="#id18" title="Link to this heading"></a></h3>
<p>PWM subsystem provides APIs for Kernel Space.</p>
<table class="docutils align-default" style="width: 100%">
<thead>
<tr class="row-odd"><th class="head"><p>API</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>pwm_request</p></td>
<td><p>Request a PWM device</p></td>
</tr>
<tr class="row-odd"><td><p>pwm_free</p></td>
<td><p>Free a PWM device</p></td>
</tr>
<tr class="row-even"><td><p>pwm_apply_state</p></td>
<td><p>Atomically apply a new state to a PWM device</p></td>
</tr>
<tr class="row-odd"><td><p>pwm_adjust_config</p></td>
<td><p>Adjust the current PWM config to the PWM arguments</p></td>
</tr>
<tr class="row-even"><td><p>pwm_config</p></td>
<td><p>Change a PWM device configuration</p></td>
</tr>
<tr class="row-odd"><td><p>pwm_enable</p></td>
<td><p>Start a PWM output toggling</p></td>
</tr>
<tr class="row-even"><td><p>pwm_disable</p></td>
<td><p>Stop a PWM output toggling</p></td>
</tr>
</tbody>
</table>
<p>Refer to <a class="reference external" href="https://www.kernel.org/doc/html/v5.4/driver-api/miscellaneous.html#pulse-width-modulation-pwm">PWM_information</a> to get more details.</p>
<p>The following is an example to show how to use kernel APIs.</p>
<ol class="arabic">
<li><p>Request PWM device.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pwm_dev</span><span class="o">=</span><span class="w"> </span><span class="n">pwm_request</span><span class="p">(</span><span class="n">pwm_channel_id</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Configure and apply PWM setting</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pwm_config</span><span class="p">(</span><span class="n">pwm_dev</span><span class="p">,</span><span class="w"> </span><span class="mi">500000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000000</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Enable PWM output.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pwm_enable</span><span class="p">(</span><span class="n">pwm_dev</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="0_timer_index.html" class="btn btn-neutral float-left" title="Timer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../8_wdg/0_wdg_index.html" class="btn btn-neutral float-right" title="Watchdog" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Realsil.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>

      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 



</body>
</html>